{"version":3,"mappings":"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","names":["HostBridge","__publicField","_a","_c","_b","event","envelope","type","payload","responseType","timeoutMs","waitType","waitPromise","resolve","reject","handler","timeoutId","existing","set","error","hostBridge","valueOrNA","value","toNumber","val","m","armorScore","armor","text","clampScore","num","deepClone","obj","toNumericId","trimmed","parsed","indexById","items","map","item","numericId","resolveUnitReference","reference","units","lookup","resolveFormationReference","formations","oneBasedIndex","collectSubFormationReferences","formation","refs","link","attachment","gatherUnitsForFormation","root","unitLookup","formationLookup","resolved","seenUnits","visitedFormations","visit","node","category","unitRef","unit","childRef","child","scoreUnitDetailed","guns","caps","stats","gren","lethality","sum","g","survivability","sustainability","mobility","versatility","stealth","speed","morale","training","antiInfantry","antiTank","antiAir","scoreFormationDetailed","allFormations","resolvedUnits","metricsArray","avg","field","scoreNationDetailed","nation","formationRefs","ref","UnitService","id","callback","snapshot","subscriber","unitService","FormationService","next","response","detail","formationService","NationService","nations","nationService","SettingsService","settings","settingsService","WeaponLibraryService","weapons","weaponLibraryService","AmmoLibraryService","templates","ammoLibraryService","FireModeTemplateService","fireModeTemplateService","emptyMap","WeaponTagService","tags","weaponTagService","TRAJECTORY_OPTIONS","WEAPON_TRAIT_GROUPS","HEAVY_TRAIT_VALUES","createBlankUnit","booleanToSelectValue","parseBool","UnitEditor","weapon","message","input","index","template","button","action","row","search","categoryFilter","sortMode","b","btn","match","u","setValue","name","gun","equipment","nameInput","title","rowBody","toggleButton","ensureId","randomSuffix","syncToggleAria","expanded","amountInput","ammoPerInput","totalAmmoInput","weaponCaliberInput","recalcTotalAmmo","amount","per","total","traitButtons","ammoBallisticUpdaters","notifyTraitChange","fn","allowBallisticAutomation","chipRow","trajectoryField","trajectoryLabel","trajectoryWrap","activeTrajectories","option","traitField","traitLabel","traitWrap","activeTraits","group","separator","makePanelId","prefix","primeSubpanelToggle","panel","label","body","sync","verb","ammoSection","ammoHeader","ammoActions","ammoLibrarySelect","populateAmmoLibrary","tpl","appendAmmoRow","refreshFireAmmoOptions","addAmmoBtn","collapseAmmoBtn","ammoList","ammoBody","parseCaliberMeasurement","raw","computeAmmoFpsEstimate","caliberRaw","barrelLength","grain","caliberMatch","diameter","decimalPart","base","barrelComponent","grainPenalty","caliberTweak","estimate","getWeaponCaliberValue","refreshAmmoCaliberAutoFill","inherited","fallback","fireSection","fireHeader","fireActions","fireLibrarySelect","populateFireLibrary","appendFireRow","addFireBtn","collapseFireBtn","fireList","fireBody","ammo","ammoRow","airburstValue","grainInput","fpsInput","ammoCaliberInput","startingValue","getBarrelLength","applyBallistics","barrel","caliberSource","velocity","airburstSelect","subInputs","syncAirburstFields","enabled","mode","fireRow","getAmmoNames","names","select","current","empty","opt","data","key","grenadeInputs","grenadeSum","capabilities","staticLineJump","haloHaho","laser","sprintDistance","sprintSpeed","sprintCooldown","rows","str","int","ammoTypes","numberValue","intValue","airburst","fireModes","fire","trajectoryValues","chip","traitValues","values","a","tone","kph","placeholder","options","ammoMap","fireMap","ammoPerCaliber","registerAmmo","fallbackName","caliberHint","calKey","bucket","genericBucket","registerFire","createFormation","FormationsPanel","activeCategories","validUnits","invalidCount","categories","helper","links","sanitized","parsedId","selectedId","currentId","previousValue","selected","formationId","read","unique","unitId","validFormations","missingCount","readValue","messages","msg","createNation","NationsPanel","missing","DEFAULT_ACCENT","clamp","min","max","shadeColor","hex","percent","normalized","r","applyTheme","theme","accent","ServerService","listener","headers","bag","pickString","keys","pickNumber","entries","entry","serverService","SettingsPanel","metadata","logs","diagnostics","started","baseUrl","port","filter","timestamp","level","metaParts","exception","backupFiles","rest","TemplatesPanel","container","module","__vitePreload","DiagnosticsPanel","target","file","status","size","latest","panels","StatsPanel","navContainer","host","panelRegistry","panelInstances","navBadges","navButtons","groupLists","setPanelPlaceholder","list","section","badge","ensurePanelInitialized","panelKey","instance","definition","loadPromise","controller","activatePanel","isActive","updateBadge","el","info"],"ignoreList":[],"sources":["../../src/lib/hostBridge.ts","../../src/lib/helpers.ts","../../src/services/unitService.ts","../../src/services/formationService.ts","../../src/services/nationService.ts","../../src/services/settingsService.ts","../../src/services/weaponLibraryService.ts","../../src/services/ammoLibraryService.ts","../../src/services/fireModeTemplateService.ts","../../src/services/weaponTagService.ts","../../src/config/weaponOptions.ts","../../src/modules/unitEditor.ts","../../src/modules/formationsPanel.ts","../../src/modules/nationsPanel.ts","../../src/lib/theme.ts","../../src/services/serverService.ts","../../src/modules/settingsPanel.ts","../../src/modules/templatesPanel.ts","../../src/modules/diagnosticsPanel.ts","../../src/main.ts"],"sourcesContent":["type HostEnvelope<TPayload = unknown> = {\r\n  type: string;\r\n  payload?: TPayload;\r\n};\r\n\r\ndeclare global {\r\n  interface Window {\r\n    chrome?: {\r\n      webview?: {\r\n        postMessage: (data: HostEnvelope) => void;\r\n        addEventListener: (event: \"message\", handler: (event: { data: HostEnvelope }) => void) => void;\r\n      };\r\n    };\r\n  }\r\n}\r\n\r\ntype HostHandler = (payload: unknown) => void;\r\n\r\nclass HostBridge {\r\n  private listeners = new Map<string, Set<HostHandler>>();\r\n  public readonly isAvailable: boolean;\r\n\r\n  constructor() {\r\n    this.isAvailable = Boolean(window.chrome?.webview);\r\n    if (this.isAvailable) {\r\n      window.chrome?.webview?.addEventListener(\"message\", (event) => this.handleEnvelope(event?.data));\r\n    } else {\r\n      console.info(\"[HostBridge] Running without desktop host; messaging will be no-ops.\");\r\n    }\r\n  }\r\n\r\n  private handleEnvelope(envelope?: HostEnvelope): void {\r\n    if (!envelope || typeof envelope !== \"object\" || !envelope.type) return;\r\n    this.emit(envelope.type, envelope.payload);\r\n  }\r\n\r\n  postMessage<TPayload = unknown>(type: string, payload?: TPayload): void {\r\n    if (!this.isAvailable) {\r\n      console.warn(`[HostBridge] Skipping \"${type}\" message because WebView host is unavailable.`);\r\n      return;\r\n    }\r\n    window.chrome!.webview!.postMessage({ type, payload });\r\n  }\r\n\r\n  request<TRequest = unknown, TResponse = unknown>(\r\n    type: string,\r\n    payload?: TRequest,\r\n    responseType?: string,\r\n    timeoutMs = 10000\r\n  ): Promise<TResponse> {\r\n    if (!this.isAvailable) {\r\n      return Promise.reject(new Error(\"Host bridge is not available.\"));\r\n    }\r\n    const waitType = responseType ?? type;\r\n    const waitPromise = this.waitFor<TResponse>(waitType, timeoutMs);\r\n    this.postMessage(type, payload);\r\n    return waitPromise;\r\n  }\r\n\r\n  waitFor<TPayload = unknown>(type: string, timeoutMs = 10000): Promise<TPayload> {\r\n    return new Promise((resolve, reject) => {\r\n      const handler: HostHandler = (payload) => {\r\n        this.off(type, handler);\r\n        clearTimeout(timeoutId);\r\n        resolve(payload as TPayload);\r\n      };\r\n\r\n      const timeoutId = window.setTimeout(() => {\r\n        this.off(type, handler);\r\n        reject(new Error(`Timed out waiting for host payload \"${type}\"`));\r\n      }, timeoutMs);\r\n\r\n      this.on(type, handler);\r\n    });\r\n  }\r\n\r\n  on<TPayload = unknown>(type: string, handler: (payload: TPayload) => void): () => void {\r\n    const existing = this.listeners.get(type) ?? new Set<HostHandler>();\r\n    existing.add(handler as HostHandler);\r\n    this.listeners.set(type, existing);\r\n    return () => this.off(type, handler as HostHandler);\r\n  }\r\n\r\n  off(type: string, handler: HostHandler): void {\r\n    const existing = this.listeners.get(type);\r\n    if (!existing) return;\r\n    existing.delete(handler);\r\n    if (!existing.size) this.listeners.delete(type);\r\n  }\r\n\r\n  private emit(type: string, payload: unknown): void {\r\n    const set = this.listeners.get(type);\r\n    if (!set) return;\r\n    set.forEach((handler) => {\r\n      try {\r\n        handler(payload);\r\n      } catch (error) {\r\n        console.error(`[HostBridge] Listener for \"${type}\" failed`, error);\r\n      }\r\n    });\r\n  }\r\n}\r\n\r\nexport const hostBridge = new HostBridge();\r\n","import type { Unit, Formation, Nation, SubFormationAttachment } from \"../types\";\r\n\r\nexport const valueOrNA = (value: unknown): string => {\r\n  if (value === undefined || value === null || value === \"\") return \"N/A\";\r\n  return String(value);\r\n};\r\n\r\nexport const yesNo = (value: unknown): string => {\r\n  if (value === undefined || value === null) return \"N/A\";\r\n  if (value === true || value === \"true\") return \"Yes\";\r\n  if (value === false || value === \"false\") return \"No\";\r\n  return String(value);\r\n};\r\n\r\nexport const parseBoolish = (value: unknown): boolean | \"\" => {\r\n  if (value === \"\" || value === undefined || value === null) return \"\";\r\n  if (value === true || value === \"true\") return true;\r\n  if (value === false || value === \"false\") return false;\r\n  return \"\";\r\n};\r\n\r\nexport const createPill = (label: string, value: unknown): HTMLDivElement => {\r\n  const pill = document.createElement(\"div\");\r\n  pill.className = \"stat-pill\";\r\n  const key = document.createElement(\"span\");\r\n  key.className = \"label\";\r\n  key.textContent = label;\r\n  const val = document.createElement(\"span\");\r\n  val.className = \"strong\";\r\n  val.textContent = valueOrNA(value);\r\n  pill.append(key, val);\r\n  return pill;\r\n};\r\n\r\nexport const sectionTitle = (text: string): HTMLDivElement => {\r\n  const el = document.createElement(\"div\");\r\n  el.className = \"section-title\";\r\n  el.textContent = text;\r\n  return el;\r\n};\r\n\r\nexport const getTagColor = (\r\n  kind: \"category\" | \"caliber\",\r\n  key: string | undefined,\r\n  weaponTags?: { categories?: Record<string, string>; calibers?: Record<string, string> }\r\n): string | null => {\r\n  if (!key || !weaponTags) return null;\r\n  if (kind === \"category\") return weaponTags.categories?.[key] ?? null;\r\n  if (kind === \"caliber\") return weaponTags.calibers?.[key] ?? null;\r\n  return null;\r\n};\r\n\r\nexport const toNumber = (val: unknown): number => {\r\n  if (typeof val === \"number\") return val;\r\n  if (typeof val === \"string\") {\r\n    const m = val.match(/-?\\d+(\\.\\d+)?/);\r\n    return m ? parseFloat(m[0]) : 0;\r\n  }\r\n  return 0;\r\n};\r\n\r\nexport const formatWithUnit = (val: unknown, unit: string): string => {\r\n  if (val === \"\" || val === undefined || val === null) return \"N/A\";\r\n  const num = toNumber(val);\r\n  if (Number.isNaN(num)) return valueOrNA(val);\r\n  return `${num} ${unit}`;\r\n};\r\n\r\nexport const formatPercent = (val: unknown): string => {\r\n  if (val === \"\" || val === undefined || val === null) return \"N/A\";\r\n  const num = toNumber(val);\r\n  if (Number.isNaN(num)) return valueOrNA(val);\r\n  return `${num}%`;\r\n};\r\n\r\nexport const formatSpeed = (val: unknown): string => {\r\n  if (val === \"\" || val === undefined || val === null) return \"N/A\";\r\n  const mps = toNumber(val);\r\n  if (Number.isNaN(mps)) return valueOrNA(val);\r\n  const kph = (mps * 3.6).toFixed(1);\r\n  return `${mps} m/s (${kph} kp/h)`;\r\n};\r\n\r\nexport const formatPoints = (val: unknown): string => {\r\n  if (val === \"\" || val === undefined || val === null) return \"N/A\";\r\n  const num = toNumber(val);\r\n  if (Number.isNaN(num)) return valueOrNA(val);\r\n  return `${num} pts`;\r\n};\r\n\r\nexport const armorScore = (armor: unknown): number => {\r\n  const text = typeof armor === \"string\" ? armor.toLowerCase() : \"\";\r\n  if (!text && typeof armor !== \"number\") return 5;\r\n  if (text.includes(\"era\") || text.includes(\"composite\") || text.includes(\"heavy\")) return 40;\r\n  if (text.includes(\"kevlar\") || text.includes(\"lvl\") || text.includes(\"iii\")) return 25;\r\n  if (text.includes(\"light\")) return 15;\r\n  return Math.max(5, Math.min(35, toNumber(armor) * 2));\r\n};\r\n\r\nexport const clampScore = (num: number): number => Math.max(0, Math.min(100, Math.round(num)));\r\n\r\nexport const deepClone = <T>(obj: T): T => JSON.parse(JSON.stringify(obj));\r\n\r\nconst toNumericId = (value: unknown): number | undefined => {\r\n  if (typeof value === \"number\" && Number.isFinite(value)) return value;\r\n  if (typeof value === \"string\") {\r\n    const trimmed = value.trim();\r\n    if (!trimmed) return undefined;\r\n    const parsed = Number(trimmed);\r\n    return Number.isFinite(parsed) ? parsed : undefined;\r\n  }\r\n  return undefined;\r\n};\r\n\r\nconst indexById = <T extends { id?: number | string }>(items: T[]): Map<number, T> => {\r\n  const map = new Map<number, T>();\r\n  items.forEach((item) => {\r\n    if (!item) return;\r\n    const numericId = toNumericId(item.id);\r\n    if (numericId !== undefined) {\r\n      map.set(numericId, item);\r\n    }\r\n  });\r\n  return map;\r\n};\r\n\r\nconst resolveUnitReference = (reference: unknown, units: Unit[], lookup: Map<number, Unit>): Unit | undefined => {\r\n  const numericId = toNumericId(reference);\r\n  if (numericId === undefined) return undefined;\r\n  if (lookup.has(numericId)) return lookup.get(numericId);\r\n  if (numericId >= 0 && numericId < units.length) return units[numericId];\r\n  return undefined;\r\n};\r\n\r\nconst resolveFormationReference = (\r\n  reference: unknown,\r\n  formations: Formation[],\r\n  lookup: Map<number, Formation>\r\n): Formation | undefined => {\r\n  const numericId = toNumericId(reference);\r\n  if (numericId === undefined) return undefined;\r\n  if (lookup.has(numericId)) return lookup.get(numericId);\r\n  if (numericId >= 0 && numericId < formations.length) return formations[numericId];\r\n  const oneBasedIndex = numericId - 1;\r\n  if (oneBasedIndex >= 0 && oneBasedIndex < formations.length) return formations[oneBasedIndex];\r\n  return undefined;\r\n};\r\n\r\nconst collectSubFormationReferences = (formation: Formation): number[] => {\r\n  const refs = new Set<number>();\r\n  (formation.subFormations || []).forEach((value) => {\r\n    const numericId = toNumericId(value);\r\n    if (numericId !== undefined) refs.add(numericId);\r\n  });\r\n  (formation.subFormationLinks || []).forEach((link) => {\r\n    if (!link || typeof link !== \"object\") return;\r\n    const attachment = link as SubFormationAttachment & { id?: number | string; childId?: number | string };\r\n    const numericId =\r\n      toNumericId(attachment.formationId) ?? toNumericId(attachment.id) ?? toNumericId(attachment.childId);\r\n    if (numericId !== undefined) refs.add(numericId);\r\n  });\r\n  return Array.from(refs);\r\n};\r\n\r\nconst gatherUnitsForFormation = (\r\n  root: Formation,\r\n  units: Unit[],\r\n  unitLookup: Map<number, Unit>,\r\n  formations: Formation[],\r\n  formationLookup: Map<number, Formation>\r\n): Unit[] => {\r\n  const resolved: Unit[] = [];\r\n  const seenUnits = new Set<Unit>();\r\n  const visitedFormations = new Set<Formation>();\r\n\r\n  const visit = (node: Formation | undefined): void => {\r\n    if (!node || visitedFormations.has(node)) return;\r\n    visitedFormations.add(node);\r\n    (node.categories || []).forEach((category) => {\r\n      (category.units || []).forEach((unitRef) => {\r\n        const unit = resolveUnitReference(unitRef, units, unitLookup);\r\n        if (unit && !seenUnits.has(unit)) {\r\n          seenUnits.add(unit);\r\n          resolved.push(unit);\r\n        }\r\n      });\r\n    });\r\n    collectSubFormationReferences(node).forEach((childRef) => {\r\n      const child = resolveFormationReference(childRef, formations, formationLookup);\r\n      if (child) visit(child);\r\n    });\r\n  };\r\n\r\n  visit(root);\r\n  return resolved;\r\n};\r\n\r\nexport const scoreUnitDetailed = (\r\n  unit: Unit | undefined\r\n): { metrics: Record<string, number> } | null => {\r\n  if (!unit) return null;\r\n  const guns = Array.isArray(unit.guns) ? unit.guns : [];\r\n  const caps = unit.capabilities || {};\r\n  const stats = unit.stats || {};\r\n  const gren = unit.grenades || {};\r\n\r\n  const lethality = clampScore(\r\n    guns.reduce((sum, g) => sum + toNumber(g.totalAmmo || g.ammoPerSoldier) * 0.4, 0) +\r\n    toNumber(gren.total) * 2\r\n  );\r\n  const survivability = clampScore(armorScore(stats.armor) + toNumber(stats.health) * 0.5);\r\n  const sustainability = clampScore(80 - toNumber(stats.weight) * 5 - toNumber(unit.price) * 0.001);\r\n  const mobility = clampScore(toNumber(stats.speed) * 6 + toNumber(caps?.sprint?.speed) * 2);\r\n  const versatility = clampScore(guns.length * 6);\r\n  const stealth = clampScore(toNumber(stats.stealth));\r\n  const speed = clampScore(toNumber(stats.speed) * 10);\r\n  const morale = clampScore(50 + toNumber(stats.health) * 0.2 + toNumber(unit.tier) * 4);\r\n  const training = clampScore(toNumber(unit.tier) * 10);\r\n  const antiInfantry = clampScore(toNumber(gren.frag) * 6);\r\n  const antiTank = clampScore(guns.reduce((sum, g) => sum + (g.category?.includes(\"Launcher\") ? 15 : 0), 0));\r\n  const antiAir = clampScore(guns.reduce((sum, g) => sum + (g.category?.includes(\"AA\") ? 20 : 0), 0));\r\n\r\n  return {\r\n    metrics: {\r\n      lethality,\r\n      survivability,\r\n      sustainability,\r\n      mobility,\r\n      versatility,\r\n      stealth,\r\n      speed,\r\n      morale,\r\n      training,\r\n      antiInfantry,\r\n      antiTank,\r\n      antiAir,\r\n    },\r\n  };\r\n};\r\n\r\nexport const scoreFormationDetailed = (\r\n  formation: Formation | undefined,\r\n  units: Unit[],\r\n  allFormations: Formation[] = []\r\n): { metrics: Record<string, number> } | null => {\r\n  if (!formation) return null;\r\n  const unitLookup = indexById(units);\r\n  const formationLookup = indexById(allFormations);\r\n  const resolvedUnits = gatherUnitsForFormation(formation, units, unitLookup, allFormations, formationLookup);\r\n  if (!resolvedUnits.length) return null;\r\n  const metricsArray = resolvedUnits\r\n    .map((unit) => scoreUnitDetailed(unit))\r\n    .filter(Boolean) as { metrics: Record<string, number> }[];\r\n  if (!metricsArray.length) return null;\r\n  const avg = (field: string) =>\r\n    metricsArray.reduce((sum, m) => sum + (m.metrics[field] || 0), 0) / metricsArray.length;\r\n  return {\r\n    metrics: {\r\n      recon: clampScore(avg(\"stealth\") + avg(\"speed\") * 0.5),\r\n      support: clampScore(avg(\"sustainability\") + avg(\"versatility\") * 0.5),\r\n      armor: clampScore(avg(\"survivability\")),\r\n      infantry: clampScore(avg(\"lethality\")),\r\n      logistics: clampScore(avg(\"sustainability\")),\r\n      air: clampScore(avg(\"antiAir\")),\r\n      sustaiment: clampScore(avg(\"sustainability\")),\r\n      speed: clampScore(avg(\"speed\")),\r\n      supplyEfficiency: clampScore(90 - avg(\"mobility\") * 0.3 + avg(\"sustainability\") * 0.2),\r\n      aoSize: clampScore(resolvedUnits.length * 5),\r\n      versatility: clampScore(avg(\"versatility\")),\r\n    },\r\n  };\r\n};\r\n\r\nexport const scoreNationDetailed = (\r\n  nation: Nation | undefined,\r\n  formations: Formation[],\r\n  units: Unit[]\r\n): { metrics: Record<string, number> } | null => {\r\n  if (!nation) return null;\r\n  const formationRefs = nation.formations || [];\r\n  if (!formationRefs.length) return null;\r\n  const formationLookup = indexById(formations);\r\n  const metricsArray = formationRefs\r\n    .map((ref) => resolveFormationReference(ref, formations, formationLookup))\r\n    .map((formation) => scoreFormationDetailed(formation, units, formations))\r\n    .filter(Boolean) as { metrics: Record<string, number> }[];\r\n  if (!metricsArray.length) return null;\r\n  const avg = (field: string) =>\r\n    metricsArray.reduce((sum, m) => sum + (m.metrics[field] || 0), 0) / metricsArray.length;\r\n  return {\r\n    metrics: {\r\n      strategicMomentum: clampScore(avg(\"versatility\") + avg(\"speed\") * 0.5 + avg(\"armor\") * 0.3),\r\n      supplyEfficiency: clampScore(avg(\"supplyEfficiency\") + avg(\"logistics\") * 0.5),\r\n      aoSize: clampScore(metricsArray.length * 10),\r\n      maneuverSpeed: clampScore(avg(\"speed\")),\r\n    },\r\n  };\r\n};\r\n","import type { Unit } from \"../types\";\r\nimport { hostBridge } from \"../lib/hostBridge\";\r\n\r\ntype UnitsEnvelope = {\r\n  units?: Unit[];\r\n};\r\n\r\nclass UnitService {\r\n  private units: Unit[] = [];\r\n  private subscribers = new Set<(units: Unit[]) => void>();\r\n\r\n  constructor() {\r\n    hostBridge.on<UnitsEnvelope>(\"units-data\", (payload) => {\r\n      this.units = Array.isArray(payload?.units) ? payload.units : [];\r\n      this.publish();\r\n    });\r\n  }\r\n\r\n  async loadUnits(): Promise<Unit[]> {\r\n    if (!hostBridge.isAvailable) {\r\n      console.warn(\"[UnitService] Host is unavailable; returning cached units only.\");\r\n      return this.units;\r\n    }\r\n    const payload = await hostBridge.request<undefined, UnitsEnvelope>(\"get-units\", undefined, \"units-data\");\r\n    this.units = Array.isArray(payload?.units) ? payload.units : [];\r\n    this.publish();\r\n    return this.units;\r\n  }\r\n\r\n  async saveUnit(unit: Unit): Promise<void> {\r\n    if (!hostBridge.isAvailable) {\r\n      throw new Error(\"Host is unavailable, cannot persist unit.\");\r\n    }\r\n    await hostBridge.request<{ unit: Unit }, UnitsEnvelope>(\"save-unit\", { unit }, \"units-data\");\r\n  }\r\n\r\n  async deleteUnit(id: number): Promise<void> {\r\n    if (!hostBridge.isAvailable) {\r\n      throw new Error(\"Host is unavailable, cannot delete unit.\");\r\n    }\r\n    await hostBridge.request<{ id: number }, UnitsEnvelope>(\"delete-unit\", { id }, \"units-data\");\r\n  }\r\n\r\n  getUnits(): Unit[] {\r\n    return this.units;\r\n  }\r\n\r\n  subscribe(callback: (units: Unit[]) => void): () => void {\r\n    this.subscribers.add(callback);\r\n    callback(this.units.map((unit) => ({ ...unit })));\r\n    return () => this.subscribers.delete(callback);\r\n  }\r\n\r\n  private publish(): void {\r\n    const snapshot = this.units.map((unit) => ({ ...unit }));\r\n    this.subscribers.forEach((subscriber) => subscriber(snapshot));\r\n  }\r\n}\r\n\r\nexport const unitService = new UnitService();\r\n","import type { Formation } from \"../types\";\r\nimport { hostBridge } from \"../lib/hostBridge\";\r\n\r\ntype FormationEnvelope = {\r\n  formations?: Formation[];\r\n  error?: string;\r\n  details?: string[];\r\n};\r\n\r\nclass FormationService {\r\n  private formations: Formation[] = [];\r\n  private subscribers = new Set<(formations: Formation[]) => void>();\r\n\r\n  constructor() {\r\n    hostBridge.on<FormationEnvelope>(\"formations-data\", (payload) => {\r\n      const next = payload && Array.isArray(payload.formations) ? payload.formations : [];\r\n      this.formations = next;\r\n      this.publish();\r\n    });\r\n  }\r\n\r\n  async loadFormations(): Promise<Formation[]> {\r\n    if (!hostBridge.isAvailable) {\r\n      return this.formations;\r\n    }\r\n    const payload = await hostBridge.request<undefined, FormationEnvelope>(\"get-formations\", undefined, \"formations-data\");\r\n    this.formations = payload && Array.isArray(payload.formations) ? payload.formations : [];\r\n    this.publish();\r\n    return this.formations;\r\n  }\r\n\r\n  async saveFormations(formations: Formation[]): Promise<void> {\r\n    if (!hostBridge.isAvailable) {\r\n      throw new Error(\"Host is unavailable, cannot persist formations.\");\r\n    }\r\n    const response = await hostBridge.request<{ formations: Formation[] }, FormationEnvelope>(\r\n      \"save-formations\",\r\n      { formations },\r\n      \"formations-data\"\r\n    );\r\n    if (response?.error) {\r\n      const detail = Array.isArray(response.details) && response.details.length ? ` ${response.details.join(\" \")}` : \"\";\r\n      throw new Error(`${response.error}${detail}`.trim());\r\n    }\r\n  }\r\n\r\n  getFormations(): Formation[] {\r\n    return this.formations;\r\n  }\r\n\r\n  subscribe(callback: (formations: Formation[]) => void): () => void {\r\n    this.subscribers.add(callback);\r\n    callback(this.formations.map((formation) => ({ ...formation })));\r\n    return () => this.subscribers.delete(callback);\r\n  }\r\n\r\n  private publish(): void {\r\n    const snapshot = this.formations.map((formation) => ({ ...formation }));\r\n    this.subscribers.forEach((subscriber) => subscriber(snapshot));\r\n  }\r\n}\r\n\r\nexport const formationService = new FormationService();\r\n","import type { Nation } from \"../types\";\r\nimport { hostBridge } from \"../lib/hostBridge\";\r\n\r\ntype NationEnvelope = {\r\n  nations?: Nation[];\r\n  error?: string;\r\n  details?: string[];\r\n};\r\n\r\nclass NationService {\r\n  private nations: Nation[] = [];\r\n  private subscribers = new Set<(nations: Nation[]) => void>();\r\n\r\n  constructor() {\r\n    hostBridge.on<NationEnvelope>(\"nations-data\", (payload) => {\r\n      const next = payload && Array.isArray(payload.nations) ? payload.nations : [];\r\n      this.nations = next;\r\n      this.publish();\r\n    });\r\n  }\r\n\r\n  async loadNations(): Promise<Nation[]> {\r\n    if (!hostBridge.isAvailable) {\r\n      return this.nations;\r\n    }\r\n    const payload = await hostBridge.request<undefined, NationEnvelope>(\"get-nations\", undefined, \"nations-data\");\r\n    this.nations = payload && Array.isArray(payload.nations) ? payload.nations : [];\r\n    this.publish();\r\n    return this.nations;\r\n  }\r\n\r\n  async saveNations(nations: Nation[]): Promise<void> {\r\n    if (!hostBridge.isAvailable) {\r\n      throw new Error(\"Host is unavailable, cannot persist nations.\");\r\n    }\r\n    const response = await hostBridge.request<{ nations: Nation[] }, NationEnvelope>(\r\n      \"save-nations\",\r\n      { nations },\r\n      \"nations-data\"\r\n    );\r\n    if (response?.error) {\r\n      const detail = Array.isArray(response.details) && response.details.length ? ` ${response.details.join(\" \")}` : \"\";\r\n      throw new Error(`${response.error}${detail}`.trim());\r\n    }\r\n  }\r\n\r\n  getNations(): Nation[] {\r\n    return this.nations;\r\n  }\r\n\r\n  subscribe(callback: (nations: Nation[]) => void): () => void {\r\n    this.subscribers.add(callback);\r\n    callback(this.nations.map((nation) => ({ ...nation })));\r\n    return () => this.subscribers.delete(callback);\r\n  }\r\n\r\n  private publish(): void {\r\n    const snapshot = this.nations.map((nation) => ({ ...nation }));\r\n    this.subscribers.forEach((subscriber) => subscriber(snapshot));\r\n  }\r\n}\r\n\r\nexport const nationService = new NationService();\r\n","import type { AppSettings } from \"../types\";\r\nimport { hostBridge } from \"../lib/hostBridge\";\r\n\r\nclass SettingsService {\r\n  private settings: AppSettings = {};\r\n  private subscribers = new Set<(settings: AppSettings) => void>();\r\n\r\n  constructor() {\r\n    hostBridge.on<AppSettings | undefined>(\"settings-data\", (payload) => {\r\n      this.settings = payload ? { ...payload } : {};\r\n      this.publish();\r\n    });\r\n  }\r\n\r\n  async loadSettings(): Promise<AppSettings> {\r\n    if (!hostBridge.isAvailable) {\r\n      return this.getSettings();\r\n    }\r\n    const payload = await hostBridge.request<undefined, AppSettings | undefined>(\r\n      \"get-settings\",\r\n      undefined,\r\n      \"settings-data\"\r\n    );\r\n    this.settings = payload ? { ...payload } : {};\r\n    this.publish();\r\n    return this.getSettings();\r\n  }\r\n\r\n  async saveSettings(settings: AppSettings): Promise<void> {\r\n    if (!hostBridge.isAvailable) {\r\n      throw new Error(\"Host is unavailable, cannot persist settings.\");\r\n    }\r\n    await hostBridge.request<AppSettings, AppSettings | undefined>(\"save-settings\", settings, \"settings-data\");\r\n  }\r\n\r\n  getSettings(): AppSettings {\r\n    return { ...this.settings };\r\n  }\r\n\r\n  subscribe(callback: (settings: AppSettings) => void): () => void {\r\n    this.subscribers.add(callback);\r\n    callback(this.getSettings());\r\n    return () => this.subscribers.delete(callback);\r\n  }\r\n\r\n  private publish(): void {\r\n    const snapshot = this.getSettings();\r\n    this.subscribers.forEach((subscriber) => subscriber(snapshot));\r\n  }\r\n}\r\n\r\nexport const settingsService = new SettingsService();\r\n","import type { WeaponTemplate } from \"../types\";\r\nimport { hostBridge } from \"../lib/hostBridge\";\r\nimport { deepClone } from \"../lib/helpers\";\r\n\r\ntype WeaponEnvelope = {\r\n  weapons?: WeaponTemplate[];\r\n};\r\n\r\nclass WeaponLibraryService {\r\n  private weapons: WeaponTemplate[] = [];\r\n  private readonly subscribers = new Set<(weapons: WeaponTemplate[]) => void>();\r\n\r\n  constructor() {\r\n    hostBridge.on<WeaponEnvelope>(\"weapons-data\", (payload) => {\r\n      this.weapons = Array.isArray(payload?.weapons) ? deepClone(payload!.weapons!) : [];\r\n      this.publish();\r\n    });\r\n  }\r\n\r\n  async loadWeapons(): Promise<WeaponTemplate[]> {\r\n    if (!hostBridge.isAvailable) {\r\n      return this.getWeapons();\r\n    }\r\n    const payload = await hostBridge.request<undefined, WeaponEnvelope>(\"get-weapons\", undefined, \"weapons-data\");\r\n    this.weapons = Array.isArray(payload?.weapons) ? deepClone(payload!.weapons!) : [];\r\n    this.publish();\r\n    return this.getWeapons();\r\n  }\r\n\r\n  async saveWeapons(weapons: WeaponTemplate[]): Promise<void> {\r\n    if (!hostBridge.isAvailable) {\r\n      throw new Error(\"Host is unavailable, cannot persist weapons.\");\r\n    }\r\n    await hostBridge.request<{ weapons: WeaponTemplate[] }, WeaponEnvelope>(\r\n      \"save-weapons\",\r\n      { weapons },\r\n      \"weapons-data\"\r\n    );\r\n  }\r\n\r\n  getWeapons(): WeaponTemplate[] {\r\n    return deepClone(this.weapons);\r\n  }\r\n\r\n  subscribe(callback: (weapons: WeaponTemplate[]) => void): () => void {\r\n    this.subscribers.add(callback);\r\n    callback(this.getWeapons());\r\n    return () => this.subscribers.delete(callback);\r\n  }\r\n\r\n  private publish(): void {\r\n    const snapshot = this.getWeapons();\r\n    this.subscribers.forEach((subscriber) => subscriber(snapshot));\r\n  }\r\n}\r\n\r\nexport const weaponLibraryService = new WeaponLibraryService();\r\n","import type { AmmoTemplate } from \"../types\";\r\nimport { hostBridge } from \"../lib/hostBridge\";\r\nimport { deepClone } from \"../lib/helpers\";\r\n\r\ntype AmmoEnvelope = {\r\n  ammo?: AmmoTemplate[];\r\n};\r\n\r\nclass AmmoLibraryService {\r\n  private templates: AmmoTemplate[] = [];\r\n  private readonly subscribers = new Set<(templates: AmmoTemplate[]) => void>();\r\n\r\n  constructor() {\r\n    hostBridge.on<AmmoEnvelope>(\"ammo-data\", (payload) => {\r\n      this.templates = Array.isArray(payload?.ammo) ? deepClone(payload!.ammo!) : [];\r\n      this.publish();\r\n    });\r\n  }\r\n\r\n  async loadTemplates(): Promise<AmmoTemplate[]> {\r\n    if (!hostBridge.isAvailable) {\r\n      return this.getTemplates();\r\n    }\r\n    const payload = await hostBridge.request<undefined, AmmoEnvelope>(\"get-ammo\", undefined, \"ammo-data\");\r\n    this.templates = Array.isArray(payload?.ammo) ? deepClone(payload!.ammo!) : [];\r\n    this.publish();\r\n    return this.getTemplates();\r\n  }\r\n\r\n  async saveTemplates(templates: AmmoTemplate[]): Promise<void> {\r\n    if (!hostBridge.isAvailable) {\r\n      throw new Error(\"Host is unavailable, cannot persist ammo templates.\");\r\n    }\r\n    await hostBridge.request<{ ammo: AmmoTemplate[] }, AmmoEnvelope>(\"save-ammo\", { ammo: templates }, \"ammo-data\");\r\n  }\r\n\r\n  getTemplates(): AmmoTemplate[] {\r\n    return deepClone(this.templates);\r\n  }\r\n\r\n  subscribe(callback: (templates: AmmoTemplate[]) => void): () => void {\r\n    this.subscribers.add(callback);\r\n    callback(this.getTemplates());\r\n    return () => this.subscribers.delete(callback);\r\n  }\r\n\r\n  private publish(): void {\r\n    const snapshot = this.getTemplates();\r\n    this.subscribers.forEach((subscriber) => subscriber(snapshot));\r\n  }\r\n}\r\n\r\nexport const ammoLibraryService = new AmmoLibraryService();\r\n","import type { FireModeTemplate } from \"../types\";\r\nimport { hostBridge } from \"../lib/hostBridge\";\r\nimport { deepClone } from \"../lib/helpers\";\r\n\r\ntype FireModeEnvelope = {\r\n    fireModes?: FireModeTemplate[];\r\n};\r\n\r\nclass FireModeTemplateService {\r\n    private templates: FireModeTemplate[] = [];\r\n    private readonly subscribers = new Set<(templates: FireModeTemplate[]) => void>();\r\n\r\n    constructor() {\r\n        hostBridge.on<FireModeEnvelope>(\"fire-modes-data\", (payload) => {\r\n            this.templates = Array.isArray(payload?.fireModes) ? deepClone(payload!.fireModes!) : [];\r\n            this.publish();\r\n        });\r\n    }\r\n\r\n    async loadTemplates(): Promise<FireModeTemplate[]> {\r\n        if (!hostBridge.isAvailable) {\r\n            return this.getTemplates();\r\n        }\r\n        const payload = await hostBridge.request<undefined, FireModeEnvelope>(\r\n            \"get-fire-modes\",\r\n            undefined,\r\n            \"fire-modes-data\"\r\n        );\r\n        this.templates = Array.isArray(payload?.fireModes) ? deepClone(payload!.fireModes!) : [];\r\n        this.publish();\r\n        return this.getTemplates();\r\n    }\r\n\r\n    async saveTemplates(templates: FireModeTemplate[]): Promise<void> {\r\n        if (!hostBridge.isAvailable) {\r\n            throw new Error(\"Host is unavailable, cannot persist fire mode templates.\");\r\n        }\r\n        await hostBridge.request<{ fireModes: FireModeTemplate[] }, FireModeEnvelope>(\r\n            \"save-fire-modes\",\r\n            { fireModes: templates },\r\n            \"fire-modes-data\"\r\n        );\r\n    }\r\n\r\n    getTemplates(): FireModeTemplate[] {\r\n        return deepClone(this.templates);\r\n    }\r\n\r\n    subscribe(callback: (templates: FireModeTemplate[]) => void): () => void {\r\n        this.subscribers.add(callback);\r\n        callback(this.getTemplates());\r\n        return () => this.subscribers.delete(callback);\r\n    }\r\n\r\n    private publish(): void {\r\n        const snapshot = this.getTemplates();\r\n        this.subscribers.forEach((subscriber) => subscriber(snapshot));\r\n    }\r\n}\r\n\r\nexport const fireModeTemplateService = new FireModeTemplateService();\r\n","import type { WeaponTagMap } from \"../types\";\r\nimport { hostBridge } from \"../lib/hostBridge\";\r\nimport { deepClone } from \"../lib/helpers\";\r\n\r\ntype TagEnvelope = WeaponTagMap | undefined;\r\n\r\nconst emptyMap = (): WeaponTagMap => ({ categories: {}, calibers: {} });\r\n\r\nclass WeaponTagService {\r\n  private tags: WeaponTagMap = emptyMap();\r\n  private readonly subscribers = new Set<(tags: WeaponTagMap) => void>();\r\n\r\n  constructor() {\r\n    hostBridge.on<TagEnvelope>(\"weapon-tags-data\", (payload) => {\r\n      this.tags = payload ? deepClone(payload) : emptyMap();\r\n      this.publish();\r\n    });\r\n  }\r\n\r\n  async loadTags(): Promise<WeaponTagMap> {\r\n    if (!hostBridge.isAvailable) {\r\n      return this.getTags();\r\n    }\r\n    const payload = await hostBridge.request<undefined, TagEnvelope>(\r\n      \"get-weapon-tags\",\r\n      undefined,\r\n      \"weapon-tags-data\"\r\n    );\r\n    this.tags = payload ? deepClone(payload) : emptyMap();\r\n    this.publish();\r\n    return this.getTags();\r\n  }\r\n\r\n  async saveTags(tags: WeaponTagMap): Promise<void> {\r\n    if (!hostBridge.isAvailable) {\r\n      throw new Error(\"Host is unavailable, cannot persist weapon tags.\");\r\n    }\r\n    await hostBridge.request<WeaponTagMap, TagEnvelope>(\"save-weapon-tags\", tags, \"weapon-tags-data\");\r\n  }\r\n\r\n  getTags(): WeaponTagMap {\r\n    return deepClone(this.tags);\r\n  }\r\n\r\n  subscribe(callback: (tags: WeaponTagMap) => void): () => void {\r\n    this.subscribers.add(callback);\r\n    callback(this.getTags());\r\n    return () => this.subscribers.delete(callback);\r\n  }\r\n\r\n  private publish(): void {\r\n    const snapshot = this.getTags();\r\n    this.subscribers.forEach((subscriber) => subscriber(snapshot));\r\n  }\r\n}\r\n\r\nexport const weaponTagService = new WeaponTagService();\r\n","export const TRAJECTORY_OPTIONS = [\r\n    { label: \"Direct (LOS)\", value: \"direct_los\" },\r\n    { label: \"Direct (NLOS)\", value: \"direct_nlos\" },\r\n    { label: \"Indirect (LOS)\", value: \"indirect_los\" },\r\n    { label: \"Indirect (NLOS)\", value: \"indirect_nlos\" },\r\n];\r\n\r\nexport const WEAPON_TRAIT_GROUPS = [\r\n    [\r\n        { label: \"Single Shot (Disposable)\", value: \"single_shot\" },\r\n        { label: \"Suppressed\", value: \"suppressed\" },\r\n    ],\r\n    [\r\n        { label: \"MOR\", value: \"mor\" },\r\n        { label: \"GL\", value: \"gl\" },\r\n        { label: \"AGL\", value: \"agl\" },\r\n        { label: \"LAW\", value: \"law\" },\r\n        { label: \"RR\", value: \"rr\" },\r\n        { label: \"ATGM\", value: \"atgm\" },\r\n        { label: \"MANPADS\", value: \"manpads\" },\r\n    ],\r\n];\r\n\r\nexport const HEAVY_TRAIT_VALUES = new Set([\"law\", \"rr\", \"atgm\", \"manpads\"]);\r\n","import type {\r\n  Equipment,\r\n  Gun,\r\n  GunAmmo,\r\n  GunFireMode,\r\n  Unit,\r\n  UnitGrenades,\r\n  UnitStats,\r\n  WeaponTagMap,\r\n} from \"../types\";\r\nimport { deepClone } from \"../lib/helpers\";\r\nimport { unitService } from \"../services/unitService\";\r\nimport { formationService } from \"../services/formationService\";\r\nimport { nationService } from \"../services/nationService\";\r\nimport { settingsService } from \"../services/settingsService\";\r\nimport { weaponLibraryService } from \"../services/weaponLibraryService\";\r\nimport { ammoLibraryService } from \"../services/ammoLibraryService\";\r\nimport { fireModeTemplateService } from \"../services/fireModeTemplateService\";\r\nimport { weaponTagService } from \"../services/weaponTagService\";\r\nimport {\r\n  HEAVY_TRAIT_VALUES,\r\n  TRAJECTORY_OPTIONS,\r\n  WEAPON_TRAIT_GROUPS,\r\n} from \"../config/weaponOptions\";\r\n\r\nconst createBlankUnit = (): Unit => ({\r\n  name: \"\",\r\n  category: \"\",\r\n  internalCategory: \"\",\r\n  tier: \"\",\r\n  price: \"\",\r\n  description: \"\",\r\n  image: \"\",\r\n  stats: {},\r\n  grenades: {},\r\n  capabilities: { sprint: {} },\r\n  guns: [],\r\n  equipment: [],\r\n});\r\n\r\nconst booleanToSelectValue = (value: boolean | string | undefined): string => {\r\n  if (value === true || value === \"true\") return \"true\";\r\n  if (value === false || value === \"false\") return \"false\";\r\n  return \"\";\r\n};\r\n\r\nconst parseBool = (value: FormDataEntryValue | null): boolean | undefined => {\r\n  if (!value) return undefined;\r\n  if (value.toString() === \"true\") return true;\r\n  if (value.toString() === \"false\") return false;\r\n  return undefined;\r\n};\r\n\r\nexport class UnitEditor {\r\n  private root: HTMLElement;\r\n  private units: Unit[] = [];\r\n\r\n  private form!: HTMLFormElement;\r\n  private unitListEl!: HTMLElement;\r\n  private gunListEl!: HTMLElement;\r\n  private equipmentListEl!: HTMLElement;\r\n  private statusEl!: HTMLElement;\r\n  private summaryEl!: HTMLElement;\r\n  private speedInputEl?: HTMLInputElement | null;\r\n  private speedHintEl?: HTMLElement | null;\r\n  private sprintSpeedInputEl?: HTMLInputElement | null;\r\n  private sprintSpeedHintEl?: HTMLElement | null;\r\n  private grenadeInputs: HTMLInputElement[] = [];\r\n  private grenadeTotalInput?: HTMLInputElement | null;\r\n  private searchInput!: HTMLInputElement;\r\n  private categoryFilter!: HTMLSelectElement;\r\n  private sortModeSelect!: HTMLSelectElement;\r\n\r\n  private workingCopy: Unit = createBlankUnit();\r\n  private currentUnitId?: number;\r\n  private pendingName?: string;\r\n  private metaFormationsEl: HTMLElement | null = null;\r\n  private metaNationsEl: HTMLElement | null = null;\r\n  private metaThemeEl: HTMLElement | null = null;\r\n  private unitCategoryTagListEl: HTMLDataListElement | null = null;\r\n  private unitCaliberTagListEl: HTMLDataListElement | null = null;\r\n  private ammoTemplates: GunAmmo[] = [];\r\n  private fireTemplates: GunFireMode[] = [];\r\n  private ammoLibraryByCaliber = new Map<string, GunAmmo[]>();\r\n  private weaponTemplates: Gun[] = [];\r\n  private hostAmmoTemplates: GunAmmo[] = [];\r\n  private hostFireTemplates: GunFireMode[] = [];\r\n  private fireLibraryTemplates: GunFireMode[] = [];\r\n  private weaponTags: WeaponTagMap = { categories: {}, calibers: {} };\r\n  private weaponTemplateImportSelect: HTMLSelectElement | null = null;\r\n\r\n  constructor(root: HTMLElement) {\r\n    this.root = root;\r\n  }\r\n\r\n  async init(): Promise<void> {\r\n    this.renderLayout();\r\n    this.cacheElements();\r\n    this.bindEvents();\r\n    this.bindMetaFeeds();\r\n    weaponLibraryService.subscribe((weapons) => {\r\n      this.weaponTemplates = deepClone(weapons);\r\n      this.hostFireTemplates = this.weaponTemplates.flatMap((weapon) => weapon.fireModes || []);\r\n      this.updateTemplateLibraries(this.units);\r\n      this.populateWeaponTemplateImport();\r\n    });\r\n    weaponLibraryService.loadWeapons().catch(() => undefined);\r\n\r\n    ammoLibraryService.subscribe((templates) => {\r\n      this.hostAmmoTemplates = deepClone(templates);\r\n      this.updateTemplateLibraries(this.units);\r\n    });\r\n    ammoLibraryService.loadTemplates().catch(() => undefined);\r\n\r\n    fireModeTemplateService.subscribe((templates) => {\r\n      this.fireLibraryTemplates = deepClone(templates);\r\n      this.updateTemplateLibraries(this.units);\r\n    });\r\n    fireModeTemplateService.loadTemplates().catch(() => undefined);\r\n\r\n    weaponTagService.subscribe((tags) => {\r\n      this.weaponTags = tags;\r\n      this.renderWeaponTagDatalists();\r\n    });\r\n    weaponTagService.loadTags().catch(() => undefined);\r\n\r\n    unitService.subscribe((units) => {\r\n      this.units = units;\r\n      this.updateTemplateLibraries(units);\r\n      this.renderUnitList();\r\n      this.syncSelection();\r\n    });\r\n\r\n    await unitService.loadUnits().catch((error) => {\r\n      const message = error instanceof Error ? error.message : String(error);\r\n      this.setStatus(`Failed to load units: ${message}`, \"error\");\r\n    });\r\n\r\n    if (!this.units.length) {\r\n      this.startNewUnit();\r\n    }\r\n  }\r\n\r\n  private renderLayout(): void {\r\n    this.root.innerHTML = `\r\n      <div class=\"workspace\">\r\n        <aside class=\"sidebar\">\r\n          <header class=\"sidebar-header\">\r\n            <div>\r\n              <p class=\"eyebrow\">SQLite source</p>\r\n              <h1>Unit Browser</h1>\r\n            </div>\r\n            <button type=\"button\" class=\"ghost\" data-action=\"refresh-units\">Refresh</button>\r\n          </header>\r\n          <div class=\"sidebar-actions\">\r\n            <input type=\"search\" placeholder=\"Search name or category\" data-role=\"search\" />\r\n            <button type=\"button\" class=\"primary\" data-action=\"new-unit\">+ New unit</button>\r\n          </div>\r\n          <div class=\"sidebar-actions\">\r\n            <select data-role=\"category-filter\">\r\n              <option value=\"\">All categories</option>\r\n              <option value=\"INF\">Infantry</option>\r\n              <option value=\"ARM\">Armor</option>\r\n              <option value=\"LOG\">Logistics</option>\r\n              <option value=\"AIR\">Air</option>\r\n            </select>\r\n            <select data-role=\"sort-mode\">\r\n              <option value=\"name-asc\">Name A &rarr; Z</option>\r\n              <option value=\"name-desc\">Name Z &rarr; A</option>\r\n              <option value=\"price-asc\">Price low &rarr; high</option>\r\n              <option value=\"price-desc\">Price high &rarr; low</option>\r\n            </select>\r\n          </div>\r\n          <div class=\"unit-list\" data-role=\"unit-list\"></div>\r\n        </aside>\r\n        <section class=\"editor\">\r\n          <header class=\"editor-header\">\r\n            <div>\r\n              <p class=\"eyebrow\">Unit Editor</p>\r\n              <h2>Unit Designer</h2>\r\n              <p class=\"muted\" data-role=\"unit-summary\">Select a unit to begin.</p>\r\n            </div>\r\n            <div class=\"editor-actions\">\r\n              <button type=\"button\" class=\"ghost\" data-action=\"reset-unit\">Reset</button>\r\n              <button type=\"button\" class=\"ghost danger\" data-action=\"delete-unit\">Delete</button>\r\n              <button type=\"submit\" class=\"primary\" form=\"unitForm\">Save unit</button>\r\n            </div>\r\n          </header>\r\n          <form id=\"unitForm\" data-role=\"unit-form\" class=\"editor-form\">\r\n            <input type=\"hidden\" name=\"unit-id\" />\r\n            <datalist id=\"unit-category-tags\" data-role=\"unit-category-tags\"></datalist>\r\n            <datalist id=\"unit-caliber-tags\" data-role=\"unit-caliber-tags\"></datalist>\r\n            <section class=\"panel grid-3\">\r\n              <div class=\"field\">\r\n                <label>Name</label>\r\n                <input name=\"name\" autocomplete=\"off\" />\r\n              </div>\r\n              <div class=\"field\">\r\n                <label>Category</label>\r\n                <input name=\"category\" placeholder=\"INF, ARM, LOG\" />\r\n              </div>\r\n              <div class=\"field\">\r\n                <label>Internal category</label>\r\n                <input name=\"internalCategory\" />\r\n              </div>\r\n              <div class=\"field\">\r\n                <label>Tier</label>\r\n                <input name=\"tier\" placeholder=\"Elite, Regular ...\" />\r\n              </div>\r\n              <div class=\"field\">\r\n                <label>Price</label>\r\n                <input name=\"price\" type=\"number\" step=\"1\" min=\"0\" />\r\n              </div>\r\n              <div class=\"field\">\r\n                <label>Image</label>\r\n                <input name=\"image\" placeholder=\"assets/units/pathfinder.png\" />\r\n              </div>\r\n            </section>\r\n            <section class=\"panel\">\r\n              <label>Description</label>\r\n              <textarea name=\"description\" rows=\"4\" placeholder=\"Overview, strengths, doctrine...\"></textarea>\r\n            </section>\r\n            <section class=\"panel\">\r\n              <div class=\"panel-title\">Core stats</div>\r\n              <div class=\"core-stats-grid\">\r\n                <div class=\"field\"><label>Armor (rating)</label><input name=\"stats.armor\" type=\"number\" step=\"0.1\" /></div>\r\n                <div class=\"field\"><label>Health (HP)</label><input name=\"stats.health\" type=\"number\" step=\"0.1\" /></div>\r\n                <div class=\"field\"><label>Squad size (#)</label><input name=\"stats.squadSize\" type=\"number\" step=\"1\" min=\"0\" /></div>\r\n                <div class=\"field\"><label>Visual range (m)</label><input name=\"stats.visualRange\" type=\"number\" step=\"1\" min=\"0\" /></div>\r\n                <div class=\"field\"><label>Stealth (%)</label><input name=\"stats.stealth\" type=\"number\" step=\"1\" min=\"0\" /></div>\r\n                <div class=\"field speed-field\">\r\n                  <label>Speed (m/s)</label>\r\n                  <div class=\"input-with-hint\">\r\n                    <input name=\"stats.speed\" type=\"number\" step=\"0.1\" data-role=\"speed-input\" />\r\n                    <span class=\"unit-hint\" data-role=\"speed-kph\">~ -- kp/h</span>\r\n                  </div>\r\n                </div>\r\n                <div class=\"field\"><label>Weight (kg)</label><input name=\"stats.weight\" type=\"number\" step=\"0.1\" /></div>\r\n              </div>\r\n            </section>\r\n            <section class=\"panel grid-4\">\r\n              <div class=\"panel-title\">Capabilities</div>\r\n              <div class=\"field\">\r\n                <label>Static line jump</label>\r\n                <select name=\"cap.staticLineJump\">\r\n                  <option value=\"\">Unknown</option>\r\n                  <option value=\"true\">Yes</option>\r\n                  <option value=\"false\">No</option>\r\n                </select>\r\n              </div>\r\n              <div class=\"field\">\r\n                <label>HALO/HAHO</label>\r\n                <select name=\"cap.haloHaho\">\r\n                  <option value=\"\">Unknown</option>\r\n                  <option value=\"true\">Yes</option>\r\n                  <option value=\"false\">No</option>\r\n                </select>\r\n              </div>\r\n              <div class=\"field\">\r\n                <label>Laser designator</label>\r\n                <select name=\"cap.laserDesignator\">\r\n                  <option value=\"\">Unknown</option>\r\n                  <option value=\"true\">Yes</option>\r\n                  <option value=\"false\">No</option>\r\n                </select>\r\n              </div>\r\n              <div class=\"field\">\r\n                <label>Sprint distance (m)</label>\r\n                <input name=\"cap.sprint.distance\" type=\"number\" step=\"1\" min=\"0\" />\r\n              </div>\r\n              <div class=\"field\">\r\n                <label>Sprint speed (m/s)</label>\r\n                <div class=\"input-with-hint\">\r\n                  <input name=\"cap.sprint.speed\" type=\"number\" step=\"0.1\" data-role=\"sprint-speed-input\" />\r\n                  <span class=\"unit-hint\" data-role=\"sprint-speed-kph\">~ -- kp/h</span>\r\n                </div>\r\n              </div>\r\n              <div class=\"field\">\r\n                <label>Sprint cooldown (s)</label>\r\n                <input name=\"cap.sprint.cooldown\" type=\"number\" step=\"0.1\" min=\"0\" />\r\n              </div>\r\n            </section>\r\n            <section class=\"panel grid-5\">\r\n              <div class=\"panel-title\">Grenades</div>\r\n              <div class=\"field\"><label>Smoke (qty)</label><input name=\"grenades.smoke\" type=\"number\" step=\"1\" min=\"0\" data-role=\"grenade-input\" /></div>\r\n              <div class=\"field\"><label>Flash (qty)</label><input name=\"grenades.flash\" type=\"number\" step=\"1\" min=\"0\" data-role=\"grenade-input\" /></div>\r\n              <div class=\"field\"><label>Thermite (qty)</label><input name=\"grenades.thermite\" type=\"number\" step=\"1\" min=\"0\" data-role=\"grenade-input\" /></div>\r\n              <div class=\"field\"><label>Frag (qty)</label><input name=\"grenades.frag\" type=\"number\" step=\"1\" min=\"0\" data-role=\"grenade-input\" /></div>\r\n              <div class=\"field grenade-total-field\">\r\n                <label>Total grenades</label>\r\n                <input name=\"grenades.total\" type=\"number\" step=\"1\" min=\"0\" data-role=\"grenade-total\" readonly tabindex=\"-1\" />\r\n              </div>\r\n            </section>\r\n            <section class=\"panel\">\r\n              <div class=\"panel-heading\">\r\n                <h3>Weapons</h3>\r\n                <div class=\"header-actions compact\">\r\n                  <select data-role=\"weapon-template-import\" class=\"ghost small\">\r\n                    <option value=\"\">From templates...</option>\r\n                  </select>\r\n                  <button type=\"button\" class=\"ghost\" data-action=\"add-gun\">Add weapon</button>\r\n                </div>\r\n              </div>\r\n              <div class=\"repeatable-list\" data-role=\"gun-list\">\r\n                <p class=\"empty\">No weapons configured.</p>\r\n              </div>\r\n            </section>\r\n            <section class=\"panel\">\r\n              <div class=\"panel-heading\">\r\n                <h3>Equipment</h3>\r\n                <button type=\"button\" class=\"ghost\" data-action=\"add-equipment\">Add equipment</button>\r\n              </div>\r\n              <div class=\"repeatable-list\" data-role=\"equipment-list\">\r\n                <p class=\"empty\">No equipment entries yet.</p>\r\n              </div>\r\n            </section>\r\n          </form>\r\n          <div class=\"status-bar\" data-role=\"status-bar\">Ready.</div>\r\n          <div class=\"meta-bar\" data-role=\"meta-bar\">\r\n            <span>Formations: <strong data-role=\"meta-formations\">0</strong></span>\r\n            <span>Nations: <strong data-role=\"meta-nations\">0</strong></span>\r\n            <span>Theme: <strong data-role=\"meta-theme\">System</strong></span>\r\n          </div>\r\n        </section>\r\n      </div>\r\n    `;\r\n  }\r\n\r\n  private cacheElements(): void {\r\n    this.form = this.root.querySelector<HTMLFormElement>('[data-role=\"unit-form\"]')!;\r\n    this.unitListEl = this.root.querySelector<HTMLElement>('[data-role=\"unit-list\"]')!;\r\n    this.gunListEl = this.root.querySelector<HTMLElement>('[data-role=\"gun-list\"]')!;\r\n    this.equipmentListEl = this.root.querySelector<HTMLElement>('[data-role=\"equipment-list\"]')!;\r\n    this.statusEl = this.root.querySelector<HTMLElement>('[data-role=\"status-bar\"]')!;\r\n    this.summaryEl = this.root.querySelector<HTMLElement>('[data-role=\"unit-summary\"]')!;\r\n    this.speedInputEl = this.root.querySelector<HTMLInputElement>('[data-role=\"speed-input\"]');\r\n    this.speedHintEl = this.root.querySelector<HTMLElement>('[data-role=\"speed-kph\"]');\r\n    this.sprintSpeedInputEl = this.root.querySelector<HTMLInputElement>('[data-role=\"sprint-speed-input\"]');\r\n    this.sprintSpeedHintEl = this.root.querySelector<HTMLElement>('[data-role=\"sprint-speed-kph\"]');\r\n    this.grenadeInputs = Array.from(this.root.querySelectorAll<HTMLInputElement>('[data-role=\"grenade-input\"]'));\r\n    this.grenadeTotalInput = this.root.querySelector<HTMLInputElement>('[data-role=\"grenade-total\"]');\r\n    this.searchInput = this.root.querySelector<HTMLInputElement>('[data-role=\"search\"]')!;\r\n    this.categoryFilter = this.root.querySelector<HTMLSelectElement>('[data-role=\"category-filter\"]')!;\r\n    this.sortModeSelect = this.root.querySelector<HTMLSelectElement>('[data-role=\"sort-mode\"]')!;\r\n    this.metaFormationsEl = this.root.querySelector<HTMLElement>('[data-role=\"meta-formations\"]');\r\n    this.metaNationsEl = this.root.querySelector<HTMLElement>('[data-role=\"meta-nations\"]');\r\n    this.metaThemeEl = this.root.querySelector<HTMLElement>('[data-role=\"meta-theme\"]');\r\n    this.unitCategoryTagListEl = this.root.querySelector<HTMLDataListElement>('[data-role=\"unit-category-tags\"]');\r\n    this.unitCaliberTagListEl = this.root.querySelector<HTMLDataListElement>('[data-role=\"unit-caliber-tags\"]');\r\n    this.weaponTemplateImportSelect = this.root.querySelector<HTMLSelectElement>('[data-role=\"weapon-template-import\"]');\r\n    this.populateWeaponTemplateImport();\r\n  }\r\n\r\n  private bindEvents(): void {\r\n    this.unitListEl.addEventListener(\"click\", (event) => this.handleUnitListClick(event));\r\n    this.form.addEventListener(\"submit\", (event) => this.handleSubmit(event));\r\n    this.root.addEventListener(\"click\", (event) => this.handleAction(event));\r\n    this.searchInput.addEventListener(\"input\", () => {\r\n      this.renderUnitList();\r\n    });\r\n    this.categoryFilter.addEventListener(\"change\", () => this.renderUnitList());\r\n    this.sortModeSelect.addEventListener(\"change\", () => this.renderUnitList());\r\n    this.speedInputEl?.addEventListener(\"input\", () => this.updateSpeedHint());\r\n    this.updateSpeedHint();\r\n    this.sprintSpeedInputEl?.addEventListener(\"input\", () => this.updateSprintSpeedHint());\r\n    this.updateSprintSpeedHint();\r\n    this.grenadeInputs.forEach((input) => input.addEventListener(\"input\", () => this.updateGrenadeTotal()));\r\n    this.updateGrenadeTotal();\r\n    this.weaponTemplateImportSelect?.addEventListener(\"change\", () => {\r\n      if (!this.weaponTemplateImportSelect) return;\r\n      const index = Number(this.weaponTemplateImportSelect.value);\r\n      if (!Number.isNaN(index)) {\r\n        const template = this.weaponTemplates[index];\r\n        if (template) {\r\n          this.appendGunRow(deepClone(template));\r\n        }\r\n      }\r\n      this.weaponTemplateImportSelect.value = \"\";\r\n    });\r\n  }\r\n\r\n  private bindMetaFeeds(): void {\r\n    formationService.subscribe((formations) => {\r\n      if (this.metaFormationsEl) this.metaFormationsEl.textContent = formations.length.toString();\r\n    });\r\n    nationService.subscribe((nations) => {\r\n      if (this.metaNationsEl) this.metaNationsEl.textContent = nations.length.toString();\r\n    });\r\n    settingsService.subscribe((settings) => {\r\n      if (this.metaThemeEl) this.metaThemeEl.textContent = settings.theme || \"System\";\r\n    });\r\n\r\n    formationService.loadFormations().catch((error) => {\r\n      console.error(\"Failed to load formations\", error);\r\n    });\r\n    nationService.loadNations().catch((error) => {\r\n      console.error(\"Failed to load nations\", error);\r\n    });\r\n    settingsService.loadSettings().catch((error) => {\r\n      console.error(\"Failed to load settings\", error);\r\n    });\r\n  }\r\n\r\n  private handleUnitListClick(event: Event): void {\r\n    const button = (event.target as HTMLElement).closest<HTMLButtonElement>(\".unit-pill\");\r\n    if (!button) return;\r\n    const index = Number(button.dataset.index);\r\n    const unit = this.units[index];\r\n    if (unit) {\r\n      this.loadUnit(unit);\r\n    }\r\n  }\r\n\r\n  private async handleSubmit(event: SubmitEvent): Promise<void> {\r\n    event.preventDefault();\r\n    const unit = this.collectFormData();\r\n    if (!unit.name) {\r\n      this.setStatus(\"Name is required.\", \"error\");\r\n      return;\r\n    }\r\n\r\n    try {\r\n      if (!unit.id) {\r\n        this.pendingName = unit.name.toLowerCase();\r\n      } else {\r\n        this.currentUnitId = unit.id;\r\n      }\r\n      this.setStatus(\"Saving unit...\", \"default\");\r\n      await unitService.saveUnit(unit);\r\n      this.setStatus(\"Unit saved.\", \"success\");\r\n    } catch (error) {\r\n      const message = error instanceof Error ? error.message : String(error);\r\n      this.setStatus(`Failed to save unit: ${message}`, \"error\");\r\n    }\r\n  }\r\n\r\n  private handleAction(event: MouseEvent): void {\r\n    const button = (event.target as HTMLElement).closest<HTMLButtonElement>(\"[data-action]\");\r\n    if (!button) return;\r\n    const action = button.dataset.action;\r\n    if (!action) return;\r\n    event.preventDefault();\r\n\r\n    switch (action) {\r\n      case \"refresh-units\":\r\n        this.setStatus(\"Refreshing from host...\", \"default\");\r\n        unitService.loadUnits().catch((error) => {\r\n          const message = error instanceof Error ? error.message : String(error);\r\n          this.setStatus(`Refresh failed: ${message}`, \"error\");\r\n        });\r\n        break;\r\n      case \"new-unit\":\r\n        this.startNewUnit();\r\n        break;\r\n      case \"reset-unit\":\r\n        this.resetCurrentUnit();\r\n        break;\r\n      case \"add-gun\":\r\n        this.appendGunRow();\r\n        break;\r\n      case \"add-equipment\":\r\n        this.appendEquipmentRow();\r\n        break;\r\n      case \"delete-unit\":\r\n        this.deleteCurrentUnit();\r\n        break;\r\n      case \"remove-gun\": {\r\n        const row = button.closest(\".repeatable-row\");\r\n        row?.remove();\r\n        if (!this.gunListEl.querySelector(\".repeatable-row\")) {\r\n          this.gunListEl.innerHTML = '<p class=\"empty\">No weapons configured.</p>';\r\n        }\r\n        break;\r\n      }\r\n      case \"remove-equipment\": {\r\n        const row = button.closest(\".repeatable-row\");\r\n        row?.remove();\r\n        if (!this.equipmentListEl.querySelector(\".repeatable-row\")) {\r\n          this.equipmentListEl.innerHTML = '<p class=\"empty\">No equipment entries yet.</p>';\r\n        }\r\n        break;\r\n      }\r\n      default:\r\n        break;\r\n    }\r\n  }\r\n\r\n  private async deleteCurrentUnit(): Promise<void> {\r\n    if (!this.currentUnitId) {\r\n      this.setStatus(\"Select a saved unit before deleting.\", \"error\");\r\n      return;\r\n    }\r\n    const confirmed = window.confirm(\"Delete this unit permanently?\");\r\n    if (!confirmed) return;\r\n    try {\r\n      this.setStatus(\"Deleting unit...\", \"default\");\r\n      await unitService.deleteUnit(this.currentUnitId);\r\n      this.currentUnitId = undefined;\r\n      this.startNewUnit();\r\n      this.setStatus(\"Unit removed.\", \"success\");\r\n    } catch (error) {\r\n      const message = error instanceof Error ? error.message : String(error);\r\n      this.setStatus(`Failed to delete unit: ${message}`, \"error\");\r\n    }\r\n  }\r\n\r\n  private renderUnitList(): void {\r\n    if (!this.unitListEl) return;\r\n    this.unitListEl.innerHTML = \"\";\r\n    const search = this.searchInput.value.trim().toLowerCase();\r\n    const categoryFilter = this.categoryFilter.value;\r\n    const items = this.units\r\n      .map((unit, index) => ({ unit, index }))\r\n      .filter(({ unit }) => {\r\n        if (!search) return true;\r\n        const haystack = `${unit.name ?? \"\"} ${unit.category ?? \"\"}`.toLowerCase();\r\n        return haystack.includes(search);\r\n      })\r\n      .filter(({ unit }) => {\r\n        if (!categoryFilter) return true;\r\n        return (unit.category || \"\").toUpperCase() === categoryFilter;\r\n      });\r\n\r\n    const sortMode = this.sortModeSelect.value;\r\n    items.sort((a, b) => {\r\n      switch (sortMode) {\r\n        case \"name-desc\":\r\n          return (b.unit.name || \"\").localeCompare(a.unit.name || \"\");\r\n        case \"price-asc\":\r\n          return (Number(a.unit.price) || 0) - (Number(b.unit.price) || 0);\r\n        case \"price-desc\":\r\n          return (Number(b.unit.price) || 0) - (Number(a.unit.price) || 0);\r\n        case \"name-asc\":\r\n        default:\r\n          return (a.unit.name || \"\").localeCompare(b.unit.name || \"\");\r\n      }\r\n    });\r\n\r\n    if (!items.length) {\r\n      this.unitListEl.innerHTML = '<p class=\"empty\">No units match the current search.</p>';\r\n      return;\r\n    }\r\n\r\n    items.forEach(({ unit, index }) => {\r\n      const btn = document.createElement(\"button\");\r\n      btn.type = \"button\";\r\n      btn.className = \"unit-pill\";\r\n      btn.dataset.index = index.toString();\r\n      if (this.currentUnitId && unit.id === this.currentUnitId) {\r\n        btn.classList.add(\"active\");\r\n      }\r\n      btn.innerHTML = `\r\n        <span class=\"unit-pill-body\">\r\n          <span class=\"title\">${unit.name || \"Unnamed unit\"}</span>\r\n          <span class=\"meta\">${unit.category || \"?\"} &middot; ${unit.tier || \"Tier ?\"} &middot; ${unit.price ?? \"&mdash;\"} pts</span>\r\n        </span>\r\n      `;\r\n      this.unitListEl.appendChild(btn);\r\n    });\r\n  }\r\n\r\n  private loadUnit(unit: Unit): void {\r\n    this.workingCopy = deepClone(unit);\r\n    this.currentUnitId = typeof unit.id === \"number\" ? unit.id : undefined;\r\n    this.pendingName = undefined;\r\n    this.populateForm(this.workingCopy);\r\n    this.setSummary(this.workingCopy.name ? `Editing ${this.workingCopy.name}` : \"Editing unit\");\r\n    this.renderUnitList();\r\n    this.setStatus(\"Unit loaded.\", \"default\");\r\n  }\r\n\r\n  private startNewUnit(): void {\r\n    this.workingCopy = createBlankUnit();\r\n    this.currentUnitId = undefined;\r\n    this.pendingName = undefined;\r\n    this.populateForm(this.workingCopy);\r\n    this.setSummary(\"New unit draft\");\r\n    this.renderUnitList();\r\n    this.setStatus(\"Ready to capture a new unit.\", \"default\");\r\n  }\r\n\r\n  private resetCurrentUnit(): void {\r\n    if (this.currentUnitId) {\r\n      const match = this.units.find((u) => u.id === this.currentUnitId);\r\n      if (match) {\r\n        this.loadUnit(match);\r\n        return;\r\n      }\r\n    }\r\n    this.startNewUnit();\r\n  }\r\n\r\n  private populateForm(unit: Unit): void {\r\n    const setValue = (name: string, value: unknown) => {\r\n      const field = this.form.querySelector<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>(\r\n        `[name=\"${name}\"]`\r\n      );\r\n      if (!field) return;\r\n      field.value = value === undefined || value === null ? \"\" : String(value);\r\n    };\r\n\r\n    setValue(\"unit-id\", unit.id);\r\n    setValue(\"name\", unit.name ?? \"\");\r\n    setValue(\"category\", unit.category ?? \"\");\r\n    setValue(\"internalCategory\", unit.internalCategory ?? \"\");\r\n    setValue(\"tier\", unit.tier ?? \"\");\r\n    setValue(\"price\", unit.price ?? \"\");\r\n    setValue(\"image\", unit.image ?? \"\");\r\n    setValue(\"description\", unit.description ?? \"\");\r\n\r\n    const stats = unit.stats ?? {};\r\n    setValue(\"stats.armor\", stats.armor ?? \"\");\r\n    setValue(\"stats.health\", stats.health ?? \"\");\r\n    setValue(\"stats.squadSize\", stats.squadSize ?? \"\");\r\n    setValue(\"stats.visualRange\", stats.visualRange ?? \"\");\r\n    setValue(\"stats.stealth\", stats.stealth ?? \"\");\r\n    setValue(\"stats.speed\", stats.speed ?? \"\");\r\n    setValue(\"stats.weight\", stats.weight ?? \"\");\r\n    this.updateSpeedHint();\r\n\r\n    const caps = unit.capabilities ?? {};\r\n    setValue(\"cap.staticLineJump\", booleanToSelectValue(caps.staticLineJump));\r\n    setValue(\"cap.haloHaho\", booleanToSelectValue(caps.haloHaho));\r\n    setValue(\"cap.laserDesignator\", booleanToSelectValue(caps.laserDesignator));\r\n    setValue(\"cap.sprint.distance\", caps.sprint?.distance ?? \"\");\r\n    setValue(\"cap.sprint.speed\", caps.sprint?.speed ?? \"\");\r\n    setValue(\"cap.sprint.cooldown\", caps.sprint?.cooldown ?? \"\");\r\n    this.updateSprintSpeedHint();\r\n\r\n    const gren = unit.grenades ?? {};\r\n    setValue(\"grenades.smoke\", gren.smoke ?? \"\");\r\n    setValue(\"grenades.flash\", gren.flash ?? \"\");\r\n    setValue(\"grenades.thermite\", gren.thermite ?? \"\");\r\n    setValue(\"grenades.frag\", gren.frag ?? \"\");\r\n    if (this.grenadeTotalInput) {\r\n      this.grenadeTotalInput.value = gren.total === undefined || gren.total === null ? \"\" : String(gren.total);\r\n    }\r\n    this.updateGrenadeTotal();\r\n\r\n    this.renderGunList(unit.guns ?? []);\r\n    this.renderEquipmentList(unit.equipment ?? []);\r\n  }\r\n\r\n  private renderGunList(guns: Gun[]): void {\r\n    if (!this.gunListEl) return;\r\n    if (!guns.length) {\r\n      this.gunListEl.innerHTML = '<p class=\"empty\">No weapons configured.</p>';\r\n      return;\r\n    }\r\n    this.gunListEl.innerHTML = \"\";\r\n    guns.forEach((gun) => this.appendGunRow(gun));\r\n  }\r\n\r\n  private renderEquipmentList(items: Equipment[]): void {\r\n    if (!this.equipmentListEl) return;\r\n    if (!items.length) {\r\n      this.equipmentListEl.innerHTML = '<p class=\"empty\">No equipment entries yet.</p>';\r\n      return;\r\n    }\r\n    this.equipmentListEl.innerHTML = \"\";\r\n    items.forEach((equipment) => this.appendEquipmentRow(equipment));\r\n  }\r\n\r\n  private appendGunRow(gun?: Gun): void {\r\n    if (!this.gunListEl) return;\r\n    if (this.gunListEl.querySelector(\".empty\")) {\r\n      this.gunListEl.innerHTML = \"\";\r\n    }\r\n    const row = document.createElement(\"div\");\r\n    row.className = \"repeatable-row\";\r\n    row.innerHTML = `\r\n      <div class=\"row-header\">\r\n        <strong data-role=\"row-title\">${gun?.name || \"New weapon\"}</strong>\r\n        <div class=\"row-controls\">\r\n          <button type=\"button\" class=\"ghost small\" data-action=\"toggle-gun\">Collapse</button>\r\n          <button type=\"button\" class=\"ghost danger\" data-action=\"remove-gun\">Remove</button>\r\n        </div>\r\n      </div>\r\n      <div class=\"row-body\">\r\n        <div class=\"repeatable-grid\">\r\n          <label>Name<input data-field=\"name\" value=\"${gun?.name ?? \"\"}\" /></label>\r\n          <label>Category<input data-field=\"category\" list=\"unit-category-tags\" value=\"${gun?.category ?? \"\"}\" /></label>\r\n          <label>Caliber<input data-field=\"caliber\" list=\"unit-caliber-tags\" value=\"${gun?.caliber ?? \"\"}\" /></label>\r\n          <label>Barrel length (cm)<input data-field=\"barrelLength\" type=\"number\" step=\"0.1\" value=\"${gun?.barrelLength ?? \"\"}\" /></label>\r\n          <label>Range (m)<input data-field=\"range\" type=\"number\" step=\"1\" value=\"${gun?.range ?? \"\"}\" /></label>\r\n          <label>Dispersion (%)<input data-field=\"dispersion\" type=\"number\" step=\"0.01\" value=\"${gun?.dispersion ?? \"\"}\" /></label>\r\n          <label>Amount of weapons (#)<input data-field=\"count\" type=\"number\" step=\"1\" min=\"0\" value=\"${gun?.count ?? \"\"}\" /></label>\r\n          <label>Ammo / soldier (#)<input data-field=\"ammoPerSoldier\" type=\"number\" step=\"1\" min=\"0\" value=\"${gun?.ammoPerSoldier ?? \"\"}\" /></label>\r\n          <label>Total ammo (rounds)<input data-field=\"totalAmmo\" type=\"number\" step=\"1\" min=\"0\" value=\"${gun?.totalAmmo ?? \"\"}\" readonly tabindex=\"-1\" /></label>\r\n          <label>Magazine size (rnds)<input data-field=\"magazineSize\" type=\"number\" step=\"1\" min=\"0\" value=\"${gun?.magazineSize ?? \"\"}\" /></label>\r\n          <label>Reload speed (s)<input data-field=\"reloadSpeed\" type=\"number\" step=\"0.1\" value=\"${gun?.reloadSpeed ?? \"\"}\" /></label>\r\n          <label>Target acquisition (s)<input data-field=\"targetAcquisition\" type=\"number\" step=\"0.1\" value=\"${gun?.targetAcquisition ?? \"\"}\" /></label>\r\n        </div>\r\n      </div>\r\n    `;\r\n    const nameInput = row.querySelector<HTMLInputElement>('[data-field=\"name\"]');\r\n    const title = row.querySelector<HTMLSpanElement>('[data-role=\"row-title\"]');\r\n    const rowBody = row.querySelector<HTMLElement>(\".row-body\")!;\r\n    const toggleButton = row.querySelector<HTMLButtonElement>('[data-action=\"toggle-gun\"]');\r\n    nameInput?.addEventListener(\"input\", () => {\r\n      if (title) title.textContent = nameInput.value || \"New weapon\";\r\n    });\r\n    if (toggleButton) {\r\n      // Ensure each collapsible section exposes a stable id for screen readers.\r\n      const ensureId = (): string => {\r\n        if (rowBody.id) return rowBody.id;\r\n        const randomSuffix = typeof crypto !== \"undefined\" && \"randomUUID\" in crypto\r\n          ? crypto.randomUUID()\r\n          : Math.random().toString(36).slice(2, 10);\r\n        rowBody.id = `gun-panel-${randomSuffix}`;\r\n        return rowBody.id;\r\n      };\r\n      // Keep the toggle label + aria-expanded attribute in sync with the collapsed state.\r\n      const syncToggleAria = () => {\r\n        const expanded = !row.classList.contains(\"collapsed\");\r\n        toggleButton.textContent = expanded ? \"Collapse\" : \"Expand\";\r\n        toggleButton.setAttribute(\"aria-expanded\", expanded ? \"true\" : \"false\");\r\n      };\r\n      toggleButton.setAttribute(\"aria-controls\", ensureId());\r\n      syncToggleAria();\r\n      toggleButton.addEventListener(\"click\", (event) => {\r\n        event.preventDefault();\r\n        row.classList.toggle(\"collapsed\");\r\n        syncToggleAria();\r\n      });\r\n    }\r\n    const amountInput = row.querySelector<HTMLInputElement>('[data-field=\"count\"]');\r\n    const ammoPerInput = row.querySelector<HTMLInputElement>('[data-field=\"ammoPerSoldier\"]');\r\n    const totalAmmoInput = row.querySelector<HTMLInputElement>('[data-field=\"totalAmmo\"]');\r\n    const weaponCaliberInput = row.querySelector<HTMLInputElement>('[data-field=\"caliber\"]');\r\n    const recalcTotalAmmo = () => {\r\n      if (!totalAmmoInput || !amountInput || !ammoPerInput) return;\r\n      const amount = Number.parseInt(amountInput.value || \"0\", 10);\r\n      const per = Number.parseInt(ammoPerInput.value || \"0\", 10);\r\n      const total = (Number.isFinite(amount) ? amount : 0) * (Number.isFinite(per) ? per : 0);\r\n      totalAmmoInput.value = total > 0 ? total.toString() : \"\";\r\n    };\r\n    amountInput?.addEventListener(\"input\", recalcTotalAmmo);\r\n    ammoPerInput?.addEventListener(\"input\", recalcTotalAmmo);\r\n    recalcTotalAmmo();\r\n\r\n    const traitButtons: HTMLButtonElement[] = [];\r\n    const ammoBallisticUpdaters: Array<() => void> = [];\r\n    const notifyTraitChange = () => {\r\n      ammoBallisticUpdaters.forEach((fn) => fn());\r\n    };\r\n    const allowBallisticAutomation = (): boolean => {\r\n      return !traitButtons.some(\r\n        (btn) =>\r\n          btn.classList.contains(\"active\") && HEAVY_TRAIT_VALUES.has((btn.dataset.value || \"\").toLowerCase())\r\n      );\r\n    };\r\n\r\n\r\n    const chipRow = document.createElement(\"div\");\r\n    chipRow.className = \"chip-field-row\";\r\n\r\n    const trajectoryField = document.createElement(\"div\");\r\n    trajectoryField.className = \"chip-field\";\r\n    const trajectoryLabel = document.createElement(\"span\");\r\n    trajectoryLabel.className = \"label\";\r\n    trajectoryLabel.textContent = \"Firing trajectories\";\r\n    const trajectoryWrap = document.createElement(\"div\");\r\n    trajectoryWrap.className = \"chip-wrap\";\r\n    const activeTrajectories = new Set((gun?.trajectories || []).map((value) => value.toLowerCase()));\r\n    TRAJECTORY_OPTIONS.forEach((option) => {\r\n      const btn = document.createElement(\"button\");\r\n      btn.type = \"button\";\r\n      btn.className = \"chip-button\";\r\n      btn.dataset.chipGroup = \"trajectory\";\r\n      btn.dataset.value = option.value;\r\n      btn.textContent = option.label;\r\n      if (activeTrajectories.has(option.value.toLowerCase())) {\r\n        btn.classList.add(\"active\");\r\n      }\r\n      btn.addEventListener(\"click\", () => {\r\n        btn.classList.toggle(\"active\");\r\n      });\r\n      trajectoryWrap.appendChild(btn);\r\n    });\r\n    trajectoryField.append(trajectoryLabel, trajectoryWrap);\r\n\r\n    const traitField = document.createElement(\"div\");\r\n    traitField.className = \"chip-field\";\r\n    const traitLabel = document.createElement(\"span\");\r\n    traitLabel.className = \"label\";\r\n    traitLabel.textContent = \"Weapon traits\";\r\n    const traitWrap = document.createElement(\"div\");\r\n    traitWrap.className = \"chip-wrap trait-wrap\";\r\n    const activeTraits = new Set((gun?.traits || []).map((value) => value.toLowerCase()));\r\n    WEAPON_TRAIT_GROUPS.forEach((group, index) => {\r\n      group.forEach((option) => {\r\n        const btn = document.createElement(\"button\");\r\n        btn.type = \"button\";\r\n        btn.className = \"chip-button\";\r\n        btn.dataset.chipGroup = \"trait\";\r\n        btn.dataset.value = option.value;\r\n        btn.textContent = option.label;\r\n        if (activeTraits.has(option.value.toLowerCase())) {\r\n          btn.classList.add(\"active\");\r\n        }\r\n        btn.addEventListener(\"click\", () => {\r\n          btn.classList.toggle(\"active\");\r\n          notifyTraitChange();\r\n        });\r\n        traitButtons.push(btn);\r\n        traitWrap.appendChild(btn);\r\n      });\r\n      if (index === 0) {\r\n        const separator = document.createElement(\"span\");\r\n        separator.className = \"trait-separator\";\r\n        traitWrap.appendChild(separator);\r\n      }\r\n    });\r\n    traitField.append(traitLabel, traitWrap);\r\n\r\n    chipRow.append(trajectoryField, traitField);\r\n    rowBody.appendChild(chipRow);\r\n\r\n    const makePanelId = (prefix: string): string => {\r\n      if (typeof crypto !== \"undefined\" && \"randomUUID\" in crypto) {\r\n        return `${prefix}-${crypto.randomUUID()}`;\r\n      }\r\n      return `${prefix}-${Math.random().toString(36).slice(2, 10)}`;\r\n    };\r\n\r\n    const primeSubpanelToggle = (\r\n      panel: HTMLElement,\r\n      button: HTMLButtonElement,\r\n      label: string\r\n    ): void => {\r\n      const body = panel.querySelector<HTMLElement>(\".subpanel-body\");\r\n      if (!body) return;\r\n      if (!body.id) {\r\n        body.id = makePanelId(label.replace(/\\s+/g, \"-\"));\r\n      }\r\n      const sync = () => {\r\n        const expanded = !panel.classList.contains(\"collapsed\");\r\n        const verb = expanded ? \"Collapse\" : \"Expand\";\r\n        button.textContent = verb;\r\n        button.setAttribute(\"aria-expanded\", expanded ? \"true\" : \"false\");\r\n        button.setAttribute(\"aria-controls\", body.id);\r\n        button.setAttribute(\"aria-label\", `${verb} ${label}`);\r\n      };\r\n      button.addEventListener(\"click\", (event) => {\r\n        event.preventDefault();\r\n        panel.classList.toggle(\"collapsed\");\r\n        sync();\r\n      });\r\n      sync();\r\n    };\r\n\r\n    const ammoSection = document.createElement(\"div\");\r\n    ammoSection.className = \"subpanel\";\r\n    const ammoHeader = document.createElement(\"div\");\r\n    ammoHeader.className = \"subpanel-heading\";\r\n    ammoHeader.innerHTML = `<strong>Ammo types</strong>`;\r\n    const ammoActions = document.createElement(\"div\");\r\n    ammoActions.className = \"header-actions compact\";\r\n    const ammoLibrarySelect = document.createElement(\"select\");\r\n    ammoLibrarySelect.className = \"ghost small\";\r\n    const populateAmmoLibrary = () => {\r\n      ammoLibrarySelect.innerHTML = `<option value=\"\">From library...</option>`;\r\n      this.ammoTemplates.forEach((tpl, index) => {\r\n        const option = document.createElement(\"option\");\r\n        option.value = index.toString();\r\n        option.textContent = tpl.name || `Template ${index + 1}`;\r\n        ammoLibrarySelect.appendChild(option);\r\n      });\r\n    };\r\n    populateAmmoLibrary();\r\n    ammoLibrarySelect.addEventListener(\"focus\", populateAmmoLibrary);\r\n    ammoLibrarySelect.addEventListener(\"change\", () => {\r\n      if (!ammoLibrarySelect.value) return;\r\n      const template = this.ammoTemplates[Number(ammoLibrarySelect.value)];\r\n      if (template) {\r\n        appendAmmoRow(deepClone(template));\r\n        refreshFireAmmoOptions();\r\n      }\r\n      ammoLibrarySelect.value = \"\";\r\n    });\r\n    const addAmmoBtn = document.createElement(\"button\");\r\n    addAmmoBtn.type = \"button\";\r\n    addAmmoBtn.className = \"ghost small\";\r\n    addAmmoBtn.textContent = \"Add ammo\";\r\n    const collapseAmmoBtn = document.createElement(\"button\");\r\n    collapseAmmoBtn.type = \"button\";\r\n    collapseAmmoBtn.className = \"ghost small\";\r\n    collapseAmmoBtn.textContent = \"Collapse\";\r\n    ammoActions.append(ammoLibrarySelect, addAmmoBtn, collapseAmmoBtn);\r\n    ammoHeader.appendChild(ammoActions);\r\n    const ammoList = document.createElement(\"div\");\r\n    ammoList.className = \"subpanel-list ammo-list\";\r\n    const ammoBody = document.createElement(\"div\");\r\n    ammoBody.className = \"subpanel-body\";\r\n    ammoBody.appendChild(ammoList);\r\n\r\n    const parseCaliberMeasurement = (raw?: string | null): number | undefined => {\r\n      if (!raw) return undefined;\r\n      const normalized = raw.replace(\",\", \".\");\r\n      const match = normalized.match(/\\d+(?:\\.\\d+)?/);\r\n      if (!match) return undefined;\r\n      const value = Number.parseFloat(match[0]);\r\n      return Number.isNaN(value) ? undefined : value;\r\n    };\r\n\r\n    const computeAmmoFpsEstimate = (caliberRaw: string, barrelLength: number, grain: number): number => {\r\n      const normalized = caliberRaw.replace(/\\s+/g, \"\");\r\n      const caliberMatch = normalized.match(/(\\d{1,3})(?:[.,](\\d{1,3}))?x(\\d{1,3})/i);\r\n      let diameter = parseCaliberMeasurement(caliberRaw) ?? 5.56;\r\n      if (caliberMatch) {\r\n        const decimalPart = caliberMatch[2] ?? \"\";\r\n        diameter = Number.parseFloat(decimalPart ? `${caliberMatch[1]}.${decimalPart}` : caliberMatch[1]);\r\n      }\r\n      const base = 2000;\r\n      const barrelComponent = barrelLength * 45;\r\n      const grainPenalty = grain * 1.5;\r\n      const caliberTweak = (6 - diameter) * 15;\r\n      const estimate = base + barrelComponent - grainPenalty + caliberTweak;\r\n      return Math.max(300, Math.round(estimate));\r\n    };\r\n\r\n    const getWeaponCaliberValue = (): string => weaponCaliberInput?.value.trim() || \"\";\r\n\r\n    const refreshAmmoCaliberAutoFill = () => {\r\n      const inherited = getWeaponCaliberValue();\r\n      ammoList.querySelectorAll<HTMLInputElement>('input[data-ammo-field=\"caliber\"]').forEach((input) => {\r\n        const fallback = input.dataset.initialCaliber?.trim() || \"\";\r\n        const value = inherited || fallback;\r\n        input.value = value;\r\n        input.placeholder = value || inherited;\r\n        input.dataset.initialCaliber = value;\r\n      });\r\n    };\r\n\r\n    weaponCaliberInput?.addEventListener(\"input\", () => {\r\n      refreshAmmoCaliberAutoFill();\r\n      ammoBallisticUpdaters.forEach((fn) => fn());\r\n    });\r\n\r\n    const fireSection = document.createElement(\"div\");\r\n    fireSection.className = \"subpanel\";\r\n    const fireHeader = document.createElement(\"div\");\r\n    fireHeader.className = \"subpanel-heading\";\r\n    fireHeader.innerHTML = `<strong>Fire modes</strong>`;\r\n    const fireActions = document.createElement(\"div\");\r\n    fireActions.className = \"header-actions compact\";\r\n    const fireLibrarySelect = document.createElement(\"select\");\r\n    fireLibrarySelect.className = \"ghost small\";\r\n    const populateFireLibrary = () => {\r\n      fireLibrarySelect.innerHTML = `<option value=\"\">From library...</option>`;\r\n      this.fireTemplates.forEach((tpl, index) => {\r\n        const option = document.createElement(\"option\");\r\n        option.value = index.toString();\r\n        option.textContent = tpl.name || `Mode ${index + 1}`;\r\n        fireLibrarySelect.appendChild(option);\r\n      });\r\n    };\r\n    populateFireLibrary();\r\n    fireLibrarySelect.addEventListener(\"focus\", populateFireLibrary);\r\n    fireLibrarySelect.addEventListener(\"change\", () => {\r\n      if (!fireLibrarySelect.value) return;\r\n      const template = this.fireTemplates[Number(fireLibrarySelect.value)];\r\n      if (template) {\r\n        appendFireRow(deepClone(template));\r\n        refreshFireAmmoOptions();\r\n      }\r\n      fireLibrarySelect.value = \"\";\r\n    });\r\n    const addFireBtn = document.createElement(\"button\");\r\n    addFireBtn.type = \"button\";\r\n    addFireBtn.className = \"ghost small\";\r\n    addFireBtn.textContent = \"Add fire mode\";\r\n    const collapseFireBtn = document.createElement(\"button\");\r\n    collapseFireBtn.type = \"button\";\r\n    collapseFireBtn.className = \"ghost small\";\r\n    collapseFireBtn.textContent = \"Collapse\";\r\n    fireActions.append(fireLibrarySelect, addFireBtn, collapseFireBtn);\r\n    fireHeader.appendChild(fireActions);\r\n    const fireList = document.createElement(\"div\");\r\n    fireList.className = \"subpanel-list fire-list\";\r\n    const fireBody = document.createElement(\"div\");\r\n    fireBody.className = \"subpanel-body\";\r\n    fireBody.appendChild(fireList);\r\n\r\n    const appendAmmoRow = (ammo?: GunAmmo) => {\r\n      const ammoRow = document.createElement(\"div\");\r\n      ammoRow.className = \"ammo-row\";\r\n      const airburstValue = ammo?.airburst === true || ammo?.airburst === \"true\" ? \"yes\" : \"no\";\r\n      ammoRow.innerHTML = `\r\n        <div class=\"subgrid\">\r\n          <label>Name<input data-ammo-field=\"name\" value=\"${ammo?.name ?? \"\"}\" /></label>\r\n          <label>Type<input data-ammo-field=\"ammoType\" value=\"${ammo?.ammoType ?? \"\"}\" /></label>\r\n          <label>Caliber<input data-ammo-field=\"caliber\" value=\"${ammo?.caliber ?? \"\"}\" readonly tabindex=\"-1\" /></label>\r\n          <label>Caliber notes<input data-ammo-field=\"caliberDesc\" value=\"${ammo?.caliberDesc ?? \"\"}\" /></label>\r\n          <label>Penetration (mm)<input type=\"number\" step=\"0.1\" data-ammo-field=\"penetration\" value=\"${ammo?.penetration ?? \"\"}\" /></label>\r\n          <label>HE value<input type=\"number\" step=\"0.1\" data-ammo-field=\"heDeadliness\" value=\"${ammo?.heDeadliness ?? \"\"}\" /></label>\r\n          <label>Dispersion (%)<input type=\"number\" step=\"0.1\" data-ammo-field=\"dispersion\" value=\"${ammo?.dispersion ?? \"\"}\" /></label>\r\n          <label>Range delta (%)<input type=\"number\" step=\"0.1\" data-ammo-field=\"rangeMod\" value=\"${ammo?.rangeMod ?? \"\"}\" /></label>\r\n          <label>Ammo/Soldier (#)<input type=\"number\" step=\"1\" min=\"0\" data-ammo-field=\"ammoPerSoldier\" value=\"${ammo?.ammoPerSoldier ?? \"\"}\" /></label>\r\n          <label>Grain (gr)<input type=\"number\" step=\"0.1\" data-ammo-field=\"grain\" value=\"${ammo?.grain ?? \"\"}\" /></label>\r\n          <label>Muzzle velocity (fps)<input type=\"number\" step=\"1\" data-ammo-field=\"fps\" value=\"${ammo?.fps ?? \"\"}\" /></label>\r\n          <label>Notes<input data-ammo-field=\"notes\" value=\"${ammo?.notes ?? \"\"}\" /></label>\r\n          <label>Airburst\r\n            <select data-ammo-field=\"airburst\">\r\n              <option value=\"yes\" ${airburstValue === \"yes\" ? \"selected\" : \"\"}>Yes</option>\r\n              <option value=\"no\" ${airburstValue === \"no\" ? \"selected\" : \"\"}>No</option>\r\n            </select>\r\n          </label>\r\n          <label>Sub munitions (#)<input type=\"number\" step=\"1\" min=\"0\" data-ammo-field=\"subCount\" data-airburst-dependent value=\"${ammo?.subCount ?? \"\"}\" /></label>\r\n          <label>Sub damage<input type=\"number\" step=\"0.1\" data-ammo-field=\"subDamage\" data-airburst-dependent value=\"${ammo?.subDamage ?? \"\"}\" /></label>\r\n          <label>Sub penetration (mm)<input type=\"number\" step=\"0.1\" data-ammo-field=\"subPenetration\" data-airburst-dependent value=\"${ammo?.subPenetration ?? \"\"}\" /></label>\r\n        </div>\r\n        <div class=\"row-actions\">\r\n          <button type=\"button\" class=\"ghost small\" data-action=\"remove-ammo\">Remove ammo</button>\r\n        </div>\r\n      `;\r\n      const grainInput = ammoRow.querySelector<HTMLInputElement>('input[data-ammo-field=\"grain\"]');\r\n      const fpsInput = ammoRow.querySelector<HTMLInputElement>('input[data-ammo-field=\"fps\"]');\r\n      const ammoCaliberInput = ammoRow.querySelector<HTMLInputElement>('input[data-ammo-field=\"caliber\"]');\r\n      if (ammoCaliberInput) {\r\n        ammoCaliberInput.readOnly = true;\r\n        ammoCaliberInput.tabIndex = -1;\r\n        ammoCaliberInput.classList.add(\"readonly\");\r\n        if (typeof ammo?.caliber === \"string\" && ammo.caliber.trim()) {\r\n          ammoCaliberInput.dataset.initialCaliber = ammo.caliber.trim();\r\n        }\r\n        const startingValue = getWeaponCaliberValue() || ammoCaliberInput.dataset.initialCaliber || \"\";\r\n        ammoCaliberInput.value = startingValue;\r\n        ammoCaliberInput.placeholder = startingValue || getWeaponCaliberValue();\r\n        ammoCaliberInput.dataset.initialCaliber = startingValue;\r\n      }\r\n      const getBarrelLength = () =>\r\n        parseFloat(row.querySelector<HTMLInputElement>('[data-field=\"barrelLength\"]')?.value || \"0\") || 0;\r\n      const applyBallistics = () => {\r\n        if (!allowBallisticAutomation()) return;\r\n        if (!grainInput || !fpsInput) return;\r\n        const grain = parseFloat(grainInput.value || \"0\");\r\n        const barrel = getBarrelLength();\r\n        const caliberSource = getWeaponCaliberValue() || ammoCaliberInput?.dataset.initialCaliber || \"\";\r\n        if (Number.isNaN(grain) || Number.isNaN(barrel)) return;\r\n        const velocity = computeAmmoFpsEstimate(caliberSource, barrel, grain);\r\n        fpsInput.value = velocity.toString();\r\n      };\r\n      ammoRow.querySelector<HTMLButtonElement>('[data-action=\"remove-ammo\"]')?.addEventListener(\"click\", () => {\r\n        ammoRow.remove();\r\n        const index = ammoBallisticUpdaters.indexOf(applyBallistics);\r\n        if (index >= 0) ammoBallisticUpdaters.splice(index, 1);\r\n        refreshFireAmmoOptions();\r\n      });\r\n      const airburstSelect = ammoRow.querySelector<HTMLSelectElement>('select[data-ammo-field=\"airburst\"]');\r\n      const subInputs = ammoRow.querySelectorAll<HTMLInputElement>('[data-airburst-dependent]');\r\n      const syncAirburstFields = () => {\r\n        const enabled = airburstSelect?.value === \"yes\";\r\n        subInputs.forEach((input) => {\r\n          input.disabled = !enabled;\r\n        });\r\n      };\r\n      airburstSelect?.addEventListener(\"change\", () => {\r\n        syncAirburstFields();\r\n      });\r\n      syncAirburstFields();\r\n      ammoList.appendChild(ammoRow);\r\n      grainInput?.addEventListener(\"input\", applyBallistics);\r\n      row.querySelector<HTMLInputElement>('[data-field=\"barrelLength\"]')?.addEventListener(\"input\", applyBallistics);\r\n      ammoBallisticUpdaters.push(applyBallistics);\r\n      refreshAmmoCaliberAutoFill();\r\n      applyBallistics();\r\n    };\r\n\r\n    const appendFireRow = (mode?: GunFireMode) => {\r\n      const fireRow = document.createElement(\"div\");\r\n      fireRow.className = \"fire-row\";\r\n      fireRow.innerHTML = `\r\n        <div class=\"subgrid\">\r\n          <label>Name<input data-fire-field=\"name\" value=\"${mode?.name ?? \"\"}\" /></label>\r\n          <label>Rounds / burst (#)<input type=\"number\" step=\"1\" min=\"0\" data-fire-field=\"rounds\" value=\"${mode?.rounds ?? \"\"}\" /></label>\r\n          <label>Min range (m)<input type=\"number\" step=\"0.1\" min=\"0\" data-fire-field=\"minRange\" value=\"${mode?.minRange ?? \"\"}\" /></label>\r\n          <label>Max range (m)<input type=\"number\" step=\"0.1\" min=\"0\" data-fire-field=\"maxRange\" value=\"${mode?.maxRange ?? \"\"}\" /></label>\r\n          <label>Cooldown (s)<input type=\"number\" step=\"0.1\" min=\"0\" data-fire-field=\"cooldown\" value=\"${mode?.cooldown ?? \"\"}\" /></label>\r\n          <label>Ammo reference<select data-fire-field=\"ammoRef\"></select></label>\r\n        </div>\r\n        <div class=\"row-actions\">\r\n          <button type=\"button\" class=\"ghost small\" data-action=\"remove-fire\">Remove mode</button>\r\n        </div>\r\n      `;\r\n      fireRow.querySelector<HTMLButtonElement>('[data-action=\"remove-fire\"]')?.addEventListener(\"click\", () => {\r\n        fireRow.remove();\r\n      });\r\n      fireList.appendChild(fireRow);\r\n    };\r\n\r\n    const getAmmoNames = () =>\r\n      Array.from(ammoList.querySelectorAll<HTMLInputElement>('input[data-ammo-field=\"name\"]'))\r\n        .map((input) => input.value.trim())\r\n        .filter(Boolean);\r\n\r\n    const refreshFireAmmoOptions = () => {\r\n      const names = getAmmoNames();\r\n      fireList.querySelectorAll<HTMLSelectElement>('select[data-fire-field=\"ammoRef\"]').forEach((select) => {\r\n        const current = select.value || select.dataset.prefill || \"\";\r\n        select.innerHTML = \"\";\r\n        const empty = document.createElement(\"option\");\r\n        empty.value = \"\";\r\n        empty.textContent = \"None\";\r\n        select.appendChild(empty);\r\n        names.forEach((name) => {\r\n          const opt = document.createElement(\"option\");\r\n          opt.value = name;\r\n          opt.textContent = name;\r\n          select.appendChild(opt);\r\n        });\r\n        if (names.includes(current)) {\r\n          select.value = current;\r\n        } else {\r\n          select.value = \"\";\r\n          if (current) select.dataset.prefill = current;\r\n        }\r\n      });\r\n    };\r\n\r\n    addAmmoBtn.addEventListener(\"click\", () => {\r\n      appendAmmoRow();\r\n      refreshFireAmmoOptions();\r\n    });\r\n    addFireBtn.addEventListener(\"click\", () => {\r\n      appendFireRow();\r\n      refreshFireAmmoOptions();\r\n    });\r\n\r\n    const ammoSource = Array.isArray(gun?.ammoTypes) && gun?.ammoTypes.length ? gun!.ammoTypes! : [undefined];\r\n    ammoSource.forEach((ammo) => appendAmmoRow(ammo));\r\n    const fireSource = Array.isArray(gun?.fireModes) && gun?.fireModes.length ? gun!.fireModes! : [undefined];\r\n    fireSource.forEach((mode) => appendFireRow(mode));\r\n\r\n    ammoList.addEventListener(\"input\", (event) => {\r\n      if ((event.target as HTMLElement).matches('[data-ammo-field=\"name\"]')) {\r\n        refreshFireAmmoOptions();\r\n      }\r\n    });\r\n\r\n    ammoSection.append(ammoHeader, ammoBody);\r\n    fireSection.append(fireHeader, fireBody);\r\n    primeSubpanelToggle(ammoSection, collapseAmmoBtn, \"weapon ammo types\");\r\n    primeSubpanelToggle(fireSection, collapseFireBtn, \"weapon fire modes\");\r\n    rowBody.append(fireSection, ammoSection);\r\n    this.gunListEl.appendChild(row);\r\n    refreshFireAmmoOptions();\r\n  }\r\n\r\n  private appendEquipmentRow(item?: Equipment): void {\r\n    if (!this.equipmentListEl) return;\r\n    if (this.equipmentListEl.querySelector(\".empty\")) {\r\n      this.equipmentListEl.innerHTML = \"\";\r\n    }\r\n    const row = document.createElement(\"div\");\r\n    row.className = \"repeatable-row\";\r\n    row.innerHTML = `\r\n      <div class=\"row-header\">\r\n        <strong data-role=\"row-title\">${item?.name || \"New equipment\"}</strong>\r\n        <button type=\"button\" class=\"ghost\" data-action=\"remove-equipment\">Remove</button>\r\n      </div>\r\n      <div class=\"repeatable-grid\">\r\n        <label>Name<input data-field=\"name\" value=\"${item?.name ?? \"\"}\" /></label>\r\n        <label>Type<input data-field=\"type\" value=\"${item?.type ?? \"\"}\" /></label>\r\n        <label>Description<input data-field=\"description\" value=\"${item?.description ?? \"\"}\" /></label>\r\n        <label>Notes<input data-field=\"notes\" value=\"${item?.notes ?? \"\"}\" /></label>\r\n        <label>Quantity<input data-field=\"count\" type=\"number\" step=\"1\" min=\"0\" value=\"${item?.count ?? \"\"}\" /></label>\r\n      </div>\r\n    `;\r\n    const nameInput = row.querySelector<HTMLInputElement>('[data-field=\"name\"]');\r\n    const title = row.querySelector<HTMLSpanElement>('[data-role=\"row-title\"]');\r\n    nameInput?.addEventListener(\"input\", () => {\r\n      if (title) title.textContent = nameInput.value || \"New equipment\";\r\n    });\r\n    this.equipmentListEl.appendChild(row);\r\n  }\r\n\r\n  private collectFormData(): Unit {\r\n    const data = new FormData(this.form);\r\n    const stats: UnitStats = {};\r\n    const gren: UnitGrenades = {};\r\n\r\n    const unit: Unit = {\r\n      id: this.toInt(data.get(\"unit-id\")),\r\n      name: this.toStringValue(data.get(\"name\")) ?? \"\",\r\n      category: this.toStringValue(data.get(\"category\"))?.toUpperCase(),\r\n      internalCategory: this.toStringValue(data.get(\"internalCategory\")),\r\n      tier: this.toStringValue(data.get(\"tier\")),\r\n      price: this.toInt(data.get(\"price\")),\r\n      image: this.toStringValue(data.get(\"image\")),\r\n      description: this.toStringValue(data.get(\"description\")),\r\n    };\r\n\r\n    const statFields: (keyof UnitStats)[] = [\r\n      \"armor\",\r\n      \"health\",\r\n      \"squadSize\",\r\n      \"visualRange\",\r\n      \"stealth\",\r\n      \"speed\",\r\n      \"weight\",\r\n    ];\r\n    statFields.forEach((key) => {\r\n      const value = this.toNumber(data.get(`stats.${key}`));\r\n      if (value !== undefined) {\r\n        stats[key] = value;\r\n      }\r\n    });\r\n    if (Object.keys(stats).length) unit.stats = stats;\r\n\r\n    const grenadeInputs: (keyof UnitGrenades)[] = [\"smoke\", \"flash\", \"thermite\", \"frag\"];\r\n    grenadeInputs.forEach((key) => {\r\n      const value = this.toInt(data.get(`grenades.${key}`));\r\n      if (value !== undefined) {\r\n        gren[key] = value;\r\n      }\r\n    });\r\n    const grenadeSum = grenadeInputs.reduce((sum, key) => {\r\n      const value = gren[key];\r\n      return sum + (typeof value === \"number\" ? value : 0);\r\n    }, 0);\r\n    if (grenadeSum > 0) {\r\n      gren.total = grenadeSum;\r\n    }\r\n    if (Object.keys(gren).length) unit.grenades = gren;\r\n\r\n    const capabilities: Unit[\"capabilities\"] = {};\r\n    const staticLineJump = parseBool(data.get(\"cap.staticLineJump\"));\r\n    if (staticLineJump !== undefined) capabilities.staticLineJump = staticLineJump;\r\n    const haloHaho = parseBool(data.get(\"cap.haloHaho\"));\r\n    if (haloHaho !== undefined) capabilities.haloHaho = haloHaho;\r\n    const laser = parseBool(data.get(\"cap.laserDesignator\"));\r\n    if (laser !== undefined) capabilities.laserDesignator = laser;\r\n\r\n    const sprintDistance = this.toNumber(data.get(\"cap.sprint.distance\"));\r\n    const sprintSpeed = this.toNumber(data.get(\"cap.sprint.speed\"));\r\n    const sprintCooldown = this.toNumber(data.get(\"cap.sprint.cooldown\"));\r\n    if (sprintDistance !== undefined || sprintSpeed !== undefined || sprintCooldown !== undefined) {\r\n      capabilities.sprint = {\r\n        distance: sprintDistance,\r\n        speed: sprintSpeed,\r\n        cooldown: sprintCooldown,\r\n      };\r\n    }\r\n    if (Object.keys(capabilities).length) unit.capabilities = capabilities;\r\n\r\n    unit.guns = this.collectGunRows();\r\n    unit.equipment = this.collectEquipmentRows();\r\n\r\n    if (this.workingCopy.symbol) {\r\n      unit.symbol = deepClone(this.workingCopy.symbol);\r\n    } else {\r\n      delete unit.symbol;\r\n    }\r\n\r\n    return unit;\r\n  }\r\n\r\n  private collectGunRows(): Gun[] {\r\n    const rows = Array.from(this.gunListEl.querySelectorAll<HTMLElement>(\".repeatable-row\"));\r\n    const guns: Gun[] = [];\r\n    rows.forEach((row) => {\r\n      const gun: Gun = {};\r\n      const str = (key: string) =>\r\n        row.querySelector<HTMLInputElement>(`[data-field=\"${key}\"]`)?.value.trim() ?? \"\";\r\n      const num = (key: string) => this.parseNumberString(str(key));\r\n      const int = (key: string) => this.parseIntegerString(str(key));\r\n\r\n      gun.name = str(\"name\") || undefined;\r\n      gun.category = str(\"category\") || undefined;\r\n      gun.caliber = str(\"caliber\") || undefined;\r\n      gun.barrelLength = num(\"barrelLength\");\r\n      gun.range = num(\"range\");\r\n      gun.dispersion = num(\"dispersion\");\r\n      gun.count = int(\"count\");\r\n      gun.ammoPerSoldier = int(\"ammoPerSoldier\");\r\n      gun.totalAmmo = int(\"totalAmmo\");\r\n      if (!gun.totalAmmo && gun.count && gun.ammoPerSoldier) {\r\n        gun.totalAmmo = gun.count * gun.ammoPerSoldier;\r\n      }\r\n      gun.magazineSize = int(\"magazineSize\");\r\n      gun.reloadSpeed = num(\"reloadSpeed\");\r\n      gun.targetAcquisition = num(\"targetAcquisition\");\r\n\r\n      const ammoRows = Array.from(row.querySelectorAll<HTMLElement>(\".ammo-row\"));\r\n      const ammoTypes: GunAmmo[] = ammoRows\r\n        .map((ammoRow) => {\r\n          const text = (key: string) =>\r\n            ammoRow.querySelector<HTMLInputElement | HTMLSelectElement>(`[data-ammo-field=\"${key}\"]`)?.value.trim() ?? \"\";\r\n          const numberValue = (key: string) => this.parseNumberString(text(key));\r\n          const intValue = (key: string) => this.parseIntegerString(text(key));\r\n          const ammo: GunAmmo = {\r\n            name: text(\"name\") || undefined,\r\n            ammoType: text(\"ammoType\") || undefined,\r\n            caliber: text(\"caliber\") || undefined,\r\n            caliberDesc: text(\"caliberDesc\") || undefined,\r\n            ammoPerSoldier: intValue(\"ammoPerSoldier\"),\r\n            penetration: numberValue(\"penetration\"),\r\n            heDeadliness: numberValue(\"heDeadliness\"),\r\n            dispersion: numberValue(\"dispersion\"),\r\n            rangeMod: numberValue(\"rangeMod\"),\r\n            grain: numberValue(\"grain\"),\r\n            notes: text(\"notes\") || undefined,\r\n            fps: numberValue(\"fps\"),\r\n            subCount: intValue(\"subCount\"),\r\n            subDamage: numberValue(\"subDamage\"),\r\n            subPenetration: numberValue(\"subPenetration\"),\r\n          };\r\n          const airburst = text(\"airburst\");\r\n          if (airburst === \"yes\") ammo.airburst = true;\r\n          else if (airburst === \"no\") ammo.airburst = false;\r\n          const hasContent = Object.values(ammo).some((value) => value !== undefined && value !== \"\");\r\n          return hasContent ? ammo : null;\r\n        })\r\n        .filter((ammo): ammo is GunAmmo => Boolean(ammo));\r\n      if (ammoTypes.length) gun.ammoTypes = ammoTypes;\r\n\r\n      const fireRows = Array.from(row.querySelectorAll<HTMLElement>(\".fire-row\"));\r\n      const fireModes: GunFireMode[] = fireRows\r\n        .map((fireRow) => {\r\n          const text = (key: string) =>\r\n            fireRow.querySelector<HTMLInputElement | HTMLSelectElement>(`[data-fire-field=\"${key}\"]`)?.value.trim() ?? \"\";\r\n          const numberValue = (key: string) => this.parseNumberString(text(key));\r\n          const intValue = (key: string) => this.parseIntegerString(text(key));\r\n          const fire: GunFireMode = {\r\n            name: text(\"name\") || undefined,\r\n            rounds: intValue(\"rounds\"),\r\n            minRange: numberValue(\"minRange\"),\r\n            maxRange: numberValue(\"maxRange\"),\r\n            cooldown: numberValue(\"cooldown\"),\r\n            ammoRef: text(\"ammoRef\") || undefined,\r\n          };\r\n          const hasContent = Object.values(fire).some((value) => value !== undefined && value !== \"\");\r\n          return hasContent ? fire : null;\r\n        })\r\n        .filter((mode): mode is GunFireMode => Boolean(mode));\r\n      if (fireModes.length) gun.fireModes = fireModes;\r\n\r\n      const trajectoryValues = Array.from(\r\n        row.querySelectorAll<HTMLButtonElement>('[data-chip-group=\"trajectory\"]')\r\n      )\r\n        .filter((chip) => chip.classList.contains(\"active\"))\r\n        .map((chip) => chip.dataset.value || \"\")\r\n        .filter(Boolean);\r\n      if (trajectoryValues.length) {\r\n        gun.trajectories = trajectoryValues;\r\n      }\r\n\r\n      const traitValues = Array.from(row.querySelectorAll<HTMLButtonElement>('[data-chip-group=\"trait\"]'))\r\n        .filter((chip) => chip.classList.contains(\"active\"))\r\n        .map((chip) => chip.dataset.value || \"\")\r\n        .filter(Boolean);\r\n      if (traitValues.length) {\r\n        gun.traits = traitValues;\r\n      }\r\n\r\n      if (Object.values(gun).some((value) => value !== undefined && value !== \"\")) {\r\n        guns.push(gun);\r\n      }\r\n    });\r\n    return guns;\r\n  }\r\n\r\n  private collectEquipmentRows(): Equipment[] {\r\n    const rows = Array.from(this.equipmentListEl.querySelectorAll<HTMLElement>(\".repeatable-row\"));\r\n    const items: Equipment[] = [];\r\n    rows.forEach((row) => {\r\n      const equipment: Equipment = {};\r\n      const str = (key: string) =>\r\n        row.querySelector<HTMLInputElement>(`[data-field=\"${key}\"]`)?.value.trim() ?? \"\";\r\n      const int = (key: string) => this.parseIntegerString(str(key));\r\n\r\n      equipment.name = str(\"name\") || undefined;\r\n      equipment.type = str(\"type\") || undefined;\r\n      equipment.description = str(\"description\") || undefined;\r\n      equipment.notes = str(\"notes\") || undefined;\r\n      equipment.count = int(\"count\");\r\n\r\n      if (Object.values(equipment).some((value) => value !== undefined && value !== \"\")) {\r\n        items.push(equipment);\r\n      }\r\n    });\r\n    return items;\r\n  }\r\n\r\n  private syncSelection(): void {\r\n    if (this.currentUnitId) {\r\n      const match = this.units.find((unit) => unit.id === this.currentUnitId);\r\n      if (match) {\r\n        this.loadUnit(match);\r\n        return;\r\n      }\r\n    }\r\n    if (this.pendingName) {\r\n      const match = this.units.find((unit) => unit.name?.toLowerCase() === this.pendingName);\r\n      if (match) {\r\n        this.loadUnit(match);\r\n        return;\r\n      }\r\n    }\r\n  }\r\n\r\n  private toNumber(value: FormDataEntryValue | null): number | undefined {\r\n    if (value === null) return undefined;\r\n    return this.parseNumberString(value.toString());\r\n  }\r\n\r\n  private toInt(value: FormDataEntryValue | null): number | undefined {\r\n    if (value === null) return undefined;\r\n    return this.parseIntegerString(value.toString());\r\n  }\r\n\r\n  private parseNumberString(value: string): number | undefined {\r\n    const trimmed = value.trim();\r\n    if (!trimmed) return undefined;\r\n    const parsed = Number(trimmed);\r\n    return Number.isNaN(parsed) ? undefined : parsed;\r\n  }\r\n\r\n  private parseIntegerString(value: string): number | undefined {\r\n    const trimmed = value.trim();\r\n    if (!trimmed) return undefined;\r\n    const parsed = Number.parseInt(trimmed, 10);\r\n    return Number.isNaN(parsed) ? undefined : parsed;\r\n  }\r\n\r\n  private toStringValue(value: FormDataEntryValue | null): string | undefined {\r\n    if (value === null) return undefined;\r\n    const text = value.toString().trim();\r\n    return text.length ? text : undefined;\r\n  }\r\n\r\n  private renderWeaponTagDatalists(): void {\r\n    if (this.unitCategoryTagListEl) {\r\n      this.unitCategoryTagListEl.innerHTML = this.buildTagOptionMarkup(Object.keys(this.weaponTags.categories || {}));\r\n    }\r\n    if (this.unitCaliberTagListEl) {\r\n      this.unitCaliberTagListEl.innerHTML = this.buildTagOptionMarkup(Object.keys(this.weaponTags.calibers || {}));\r\n    }\r\n  }\r\n\r\n  private buildTagOptionMarkup(values: string[]): string {\r\n    if (!values || !values.length) return \"\";\r\n    return [...values]\r\n      .sort((a, b) => a.localeCompare(b))\r\n      .map((value) => `<option value=\"${value}\"></option>`)\r\n      .join(\"\");\r\n  }\r\n\r\n  private setStatus(message: string, tone: \"default\" | \"success\" | \"error\"): void {\r\n    if (!this.statusEl) return;\r\n    this.statusEl.textContent = message;\r\n    this.statusEl.dataset.tone = tone;\r\n  }\r\n\r\n  private setSummary(message: string): void {\r\n    if (this.summaryEl) {\r\n      this.summaryEl.textContent = message;\r\n    }\r\n  }\r\n\r\n  private updateSpeedHint(): void {\r\n    if (!this.speedHintEl || !this.speedInputEl) return;\r\n    const value = Number.parseFloat(this.speedInputEl.value);\r\n    if (!Number.isFinite(value)) {\r\n      this.speedHintEl.textContent = \"~ -- kp/h\";\r\n      return;\r\n    }\r\n    const kph = value * 3.6;\r\n    this.speedHintEl.textContent = `~ ${kph.toFixed(1)} kp/h`;\r\n  }\r\n\r\n  private updateSprintSpeedHint(): void {\r\n    if (!this.sprintSpeedHintEl || !this.sprintSpeedInputEl) return;\r\n    const value = Number.parseFloat(this.sprintSpeedInputEl.value);\r\n    if (!Number.isFinite(value)) {\r\n      this.sprintSpeedHintEl.textContent = \"~ -- kp/h\";\r\n      return;\r\n    }\r\n    const kph = value * 3.6;\r\n    this.sprintSpeedHintEl.textContent = `~ ${kph.toFixed(1)} kp/h`;\r\n  }\r\n\r\n  private populateWeaponTemplateImport(): void {\r\n    if (!this.weaponTemplateImportSelect) return;\r\n    const select = this.weaponTemplateImportSelect;\r\n    const placeholder = '<option value=\"\">From templates...</option>';\r\n    if (!this.weaponTemplates.length) {\r\n      select.innerHTML = `${placeholder}<option value=\"\" disabled>No templates available</option>`;\r\n      select.disabled = true;\r\n      return;\r\n    }\r\n    select.disabled = false;\r\n    const options = this.weaponTemplates\r\n      .map((weapon, index) => `<option value=\"${index}\">${weapon.name || `Weapon ${index + 1}`}</option>`)\r\n      .join(\"\");\r\n    select.innerHTML = `${placeholder}${options}`;\r\n  }\r\n\r\n  private updateGrenadeTotal(): void {\r\n    if (!this.grenadeTotalInput) return;\r\n    const total = this.grenadeInputs.reduce((sum, input) => {\r\n      const value = Number.parseInt(input.value, 10);\r\n      return sum + (Number.isFinite(value) ? value : 0);\r\n    }, 0);\r\n    this.grenadeTotalInput.value = total > 0 ? total.toString() : \"\";\r\n  }\r\n\r\n  private updateTemplateLibraries(units: Unit[]): void {\r\n    const ammoMap = new Map<string, GunAmmo>();\r\n    const fireMap = new Map<string, GunFireMode>();\r\n    const ammoPerCaliber = new Map<string, GunAmmo[]>();\r\n    const registerAmmo = (ammo: GunAmmo, fallbackName: string, caliberHint?: string | number) => {\r\n      const label = (ammo.name ?? fallbackName).toString().toLowerCase();\r\n      const key = `${label}-${ammo.ammoType || \"\"}`;\r\n      if (!ammoMap.has(key)) ammoMap.set(key, deepClone(ammo));\r\n      const caliberSource =\r\n        caliberHint ?? (typeof ammo.caliber === \"string\" ? ammo.caliber : undefined) ?? \"generic\";\r\n      const calKey = caliberSource.toString().toLowerCase();\r\n      const bucket = ammoPerCaliber.get(calKey) ?? [];\r\n      bucket.push(deepClone(ammo));\r\n      ammoPerCaliber.set(calKey, bucket);\r\n      const genericBucket = ammoPerCaliber.get(\"generic\") ?? [];\r\n      genericBucket.push(deepClone(ammo));\r\n      ammoPerCaliber.set(\"generic\", genericBucket);\r\n    };\r\n\r\n    const registerFire = (mode: GunFireMode, fallbackName: string) => {\r\n      const key = (mode.name ?? fallbackName).toString().toLowerCase();\r\n      if (!fireMap.has(key)) fireMap.set(key, deepClone(mode));\r\n    };\r\n\r\n    this.hostAmmoTemplates.forEach((ammo, index) => {\r\n      registerAmmo(ammo, `hostAmmo${index}`, typeof ammo.caliber === \"string\" ? ammo.caliber : undefined);\r\n    });\r\n\r\n    this.hostFireTemplates.forEach((mode, index) => {\r\n      registerFire(mode, `hostMode${index}`);\r\n    });\r\n\r\n    this.fireLibraryTemplates.forEach((mode, index) => {\r\n      registerFire(mode, `libraryMode${index}`);\r\n    });\r\n\r\n    units.forEach((unit) => {\r\n      (unit.guns || []).forEach((gun) => {\r\n        (gun.ammoTypes || []).forEach((ammo, index) => {\r\n          registerAmmo(ammo, `unitAmmo${index}`, gun.caliber);\r\n        });\r\n        (gun.fireModes || []).forEach((mode, index) => {\r\n          registerFire(mode, `unitMode${index}`);\r\n        });\r\n      });\r\n    });\r\n    this.ammoTemplates = Array.from(ammoMap.values());\r\n    this.fireTemplates = Array.from(fireMap.values());\r\n    this.ammoLibraryByCaliber = ammoPerCaliber;\r\n  }\r\n}\r\n\r\n","import type { Formation, FormationCategory, SubFormationAttachment } from \"../types\";\r\nimport { formationService } from \"../services/formationService\";\r\nimport { unitService } from \"../services/unitService\";\r\n\r\nconst createFormation = (): Formation => ({\r\n  name: \"New Formation\",\r\n  role: \"\",\r\n  hqLocation: \"\",\r\n  commander: \"\",\r\n  readiness: \"\",\r\n  strengthSummary: \"\",\r\n  supportAssets: \"\",\r\n  communications: \"\",\r\n  description: \"\",\r\n  image: \"\",\r\n  categories: [],\r\n  subFormationLinks: [],\r\n});\r\n\r\nexport class FormationsPanel {\r\n  private root: HTMLElement;\r\n  private listEl!: HTMLElement;\r\n  private formEl!: HTMLFormElement;\r\n  private statusEl!: HTMLElement;\r\n  private warningBannerEl!: HTMLElement;\r\n  private loadErrorEl!: HTMLElement;\r\n  private loadErrorTextEl!: HTMLElement;\r\n  private categoryListEl!: HTMLElement;\r\n  private unitsCountEl!: HTMLElement;\r\n  private subFormationListEl!: HTMLElement;\r\n  private formationCountEl: HTMLElement | null = null;\r\n  private formations: Formation[] = [];\r\n  private unitOptions: { id: number; label: string }[] = [];\r\n  private formationOptions: { id: number; name: string }[] = [];\r\n  private selectedIndex = 0;\r\n  private warningMessages: Record<string, string | undefined> = {};\r\n  private unitIdGate = false;\r\n  private formationAttachmentGate = false;\r\n\r\n  constructor(root: HTMLElement) {\r\n    this.root = root;\r\n  }\r\n\r\n  init(): void {\r\n    this.renderLayout();\r\n    this.cacheElements();\r\n    this.bindEvents();\r\n    formationService.subscribe((formations) => {\r\n      const total = formations.length;\r\n      this.formations = total ? formations : [createFormation()];\r\n      this.rebuildFormationOptions();\r\n      if (this.formationCountEl) this.formationCountEl.textContent = total.toString();\r\n      this.renderList();\r\n      this.syncSelection();\r\n    });\r\n    unitService.subscribe((units) => {\r\n      const activeCategories = this.collectCategoriesFromDom();\r\n      if (this.formations[this.selectedIndex]) {\r\n        this.formations[this.selectedIndex].categories = activeCategories;\r\n      }\r\n      const validUnits = units.filter((unit) => typeof unit.id === \"number\" && Number.isFinite(unit.id));\r\n      const invalidCount = units.length - validUnits.length;\r\n      this.unitOptions = validUnits.map((unit) => {\r\n        const id = unit.id as number;\r\n        return {\r\n          id,\r\n          label: unit.name || `Unit ${id}`,\r\n        };\r\n      });\r\n      this.unitIdGate = units.length > 0 && validUnits.length === 0;\r\n      this.warningMessages.units = invalidCount\r\n        ? `${invalidCount} unit${invalidCount === 1 ? \"\" : \"s\"} lack IDs and cannot be assigned. Request IDs from the host.`\r\n        : undefined;\r\n      this.updateWarningBanner();\r\n      this.renderCategories();\r\n    });\r\n    void this.reloadFormations();\r\n  }\r\n\r\n  private renderLayout(): void {\r\n    this.root.innerHTML = `\r\n      <div class=\"workspace\">\r\n        <aside class=\"sidebar\">\r\n          <header class=\"sidebar-header\">\r\n            <div>\r\n              <p class=\"eyebrow\">Force structure</p>\r\n              <h1>Formations Browser</h1>\r\n            </div>\r\n            <button type=\"button\" class=\"ghost\" data-action=\"add-formation\">+ Formation</button>\r\n          </header>\r\n          <div class=\"unit-list\" data-role=\"formation-list\"></div>\r\n          <div class=\"meta-bar compact\">\r\n            <span>Formations: <strong data-role=\"formation-count\">0</strong></span>\r\n            <span>Unique units: <strong data-role=\"formation-units-count\">0</strong></span>\r\n          </div>\r\n        </aside>\r\n        <section class=\"editor\">\r\n          <header class=\"editor-header\">\r\n            <div>\r\n              <p class=\"eyebrow\">Formation Editor</p>\r\n              <h2>Formation Editor</h2>\r\n              <p class=\"muted\">Capture HQ posture, leadership, and subordinate attachments.</p>\r\n            </div>\r\n          </header>\r\n          <div class=\"inline-warning hidden\" data-role=\"formation-warning\"></div>\r\n          <div class=\"inline-error hidden\" data-role=\"formation-load-error\">\r\n            <span data-role=\"formation-load-error-text\"></span>\r\n            <button type=\"button\" class=\"ghost\" data-action=\"retry-formations\">Retry load</button>\r\n          </div>\r\n          <form data-role=\"formation-form\" class=\"editor-form\">\r\n            <section class=\"panel grid-3\">\r\n              <div class=\"field\">\r\n                <label>Name</label>\r\n                <input name=\"name\" autocomplete=\"off\" />\r\n              </div>\r\n              <div class=\"field\">\r\n                <label>Role / mission</label>\r\n                <input name=\"role\" />\r\n              </div>\r\n              <div class=\"field\">\r\n                <label>Headquarters location</label>\r\n                <input name=\"hqLocation\" />\r\n              </div>\r\n            </section>\r\n            <section class=\"panel grid-3\">\r\n              <div class=\"field\">\r\n                <label>Commander</label>\r\n                <input name=\"commander\" />\r\n              </div>\r\n              <div class=\"field\">\r\n                <label>Readiness posture</label>\r\n                <input name=\"readiness\" placeholder=\"90% / 48h stand-up\" />\r\n              </div>\r\n              <div class=\"field\">\r\n                <label>Strength summary</label>\r\n                <input name=\"strengthSummary\" placeholder=\"1,240 personnel / 220 vehicles\" />\r\n              </div>\r\n            </section>\r\n            <section class=\"panel grid-3\">\r\n              <div class=\"field\">\r\n                <label>Support assets</label>\r\n                <input name=\"supportAssets\" placeholder=\"Fires, sustainment, aviation\" />\r\n              </div>\r\n              <div class=\"field\">\r\n                <label>Communications plan</label>\r\n                <input name=\"communications\" placeholder=\"FM 30-41 / SAT 2.5 GHz\" />\r\n              </div>\r\n              <div class=\"field\">\r\n                <label>Image</label>\r\n                <input name=\"image\" placeholder=\"formations/path.png\" />\r\n              </div>\r\n            </section>\r\n            <section class=\"panel\">\r\n              <label>Description</label>\r\n              <textarea name=\"description\" rows=\"4\" placeholder=\"Doctrine, employment concept, and sustainment notes.\"></textarea>\r\n            </section>\r\n            <section class=\"panel\">\r\n              <div class=\"panel-heading\">\r\n                <h3>Categories</h3>\r\n                <button type=\"button\" class=\"ghost\" data-action=\"add-category\">Add category</button>\r\n              </div>\r\n              <div class=\"category-editor\" data-role=\"category-editor\"></div>\r\n            </section>\r\n            <section class=\"panel\">\r\n              <div class=\"panel-heading\">\r\n                <h3>Sub formations</h3>\r\n                <button type=\"button\" class=\"ghost\" data-action=\"add-sub-formation\">Attach formation</button>\r\n              </div>\r\n              <div class=\"sub-formation-list\" data-role=\"sub-formation-list\">\r\n                <p class=\"empty\">No attached formations.</p>\r\n              </div>\r\n            </section>\r\n            <div class=\"form-actions\">\r\n              <button type=\"button\" class=\"ghost danger\" data-action=\"delete-formation\">Delete formation</button>\r\n              <button type=\"submit\" class=\"primary\">Save formation</button>\r\n            </div>\r\n          </form>\r\n          <div class=\"status-bar\" data-role=\"formation-status\">Select a formation.</div>\r\n        </section>\r\n      </div>\r\n    `;\r\n  }\r\n\r\n  private cacheElements(): void {\r\n    this.listEl = this.root.querySelector<HTMLElement>('[data-role=\"formation-list\"]')!;\r\n    this.formEl = this.root.querySelector<HTMLFormElement>('[data-role=\"formation-form\"]')!;\r\n    this.statusEl = this.root.querySelector<HTMLElement>('[data-role=\"formation-status\"]')!;\r\n    this.warningBannerEl = this.root.querySelector<HTMLElement>('[data-role=\"formation-warning\"]')!;\r\n    this.loadErrorEl = this.root.querySelector<HTMLElement>('[data-role=\"formation-load-error\"]')!;\r\n    this.loadErrorTextEl = this.loadErrorEl.querySelector<HTMLElement>('[data-role=\"formation-load-error-text\"]')!;\r\n    this.categoryListEl = this.root.querySelector<HTMLElement>('[data-role=\"category-editor\"]')!;\r\n    this.unitsCountEl = this.root.querySelector<HTMLElement>('[data-role=\"formation-units-count\"]')!;\r\n    this.subFormationListEl = this.root.querySelector<HTMLElement>('[data-role=\"sub-formation-list\"]')!;\r\n    this.formationCountEl = this.root.querySelector<HTMLElement>('[data-role=\"formation-count\"]');\r\n  }\r\n\r\n  private bindEvents(): void {\r\n    this.listEl.addEventListener(\"click\", (event) => {\r\n      const button = (event.target as HTMLElement).closest<HTMLButtonElement>(\"[data-index]\");\r\n      if (!button) return;\r\n      this.selectedIndex = Number(button.dataset.index);\r\n      this.syncSelection();\r\n    });\r\n    this.formEl.addEventListener(\"submit\", (event) => {\r\n      event.preventDefault();\r\n      this.saveFormation();\r\n    });\r\n    this.root.addEventListener(\"click\", (event) => {\r\n      const button = (event.target as HTMLElement).closest<HTMLButtonElement>(\"[data-action]\");\r\n      if (!button) return;\r\n      const action = button.dataset.action;\r\n      if (action === \"add-formation\") {\r\n        this.addFormation();\r\n      } else if (action === \"add-category\") {\r\n        this.appendCategoryRow();\r\n      } else if (action === \"remove-category\") {\r\n        button.closest(\".category-row\")?.remove();\r\n        this.updateUnitsCount(this.collectCategoriesFromDom());\r\n      } else if (action === \"add-sub-formation\") {\r\n        this.appendSubFormationRow();\r\n        this.refreshSubFormationSelects();\r\n      } else if (action === \"remove-sub-formation\") {\r\n        const row = button.closest(\".sub-formation-row\");\r\n        row?.remove();\r\n        if (this.subFormationListEl && !this.subFormationListEl.querySelector(\".sub-formation-row\")) {\r\n          this.subFormationListEl.innerHTML = '<p class=\"empty\">No attached formations.</p>';\r\n        }\r\n      } else if (action === \"retry-formations\") {\r\n        void this.reloadFormations();\r\n      } else if (action === \"delete-formation\") {\r\n        this.deleteFormation();\r\n      }\r\n    });\r\n  }\r\n\r\n  private addFormation(): void {\r\n    this.formations.push(createFormation());\r\n    this.selectedIndex = this.formations.length - 1;\r\n    this.rebuildFormationOptions();\r\n    this.renderList();\r\n    this.syncSelection();\r\n  }\r\n\r\n  private renderList(): void {\r\n    if (!this.formations.length) {\r\n      this.listEl.innerHTML = '<p class=\"empty\">No formations found.</p>';\r\n      return;\r\n    }\r\n    this.listEl.innerHTML = \"\";\r\n    this.formations.forEach((formation, index) => {\r\n      const btn = document.createElement(\"button\");\r\n      btn.type = \"button\";\r\n      btn.dataset.index = index.toString();\r\n      btn.className = `unit-pill${index === this.selectedIndex ? \" active\" : \"\"}`;\r\n      btn.innerHTML = `\r\n        <span class=\"unit-pill-body\">\r\n          <span class=\"title\">${formation.name || \"Untitled formation\"}</span>\r\n          <span class=\"meta\">${formation.categories?.length ?? 0} categories</span>\r\n        </span>\r\n      `;\r\n      this.listEl.appendChild(btn);\r\n    });\r\n  }\r\n\r\n  private deleteFormation(): void {\r\n    if (!this.formations.length) return;\r\n    this.formations.splice(this.selectedIndex, 1);\r\n    const payload = this.formations.slice();\r\n    this.selectedIndex = Math.max(0, this.selectedIndex - 1);\r\n    if (!this.formations.length) {\r\n      this.formations = [createFormation()];\r\n      this.selectedIndex = 0;\r\n    }\r\n    if (this.formationCountEl) {\r\n      this.formationCountEl.textContent = payload.length.toString();\r\n    }\r\n    this.rebuildFormationOptions();\r\n    this.syncSelection();\r\n    formationService\r\n      .saveFormations(payload)\r\n      .then(() => {\r\n        delete this.warningMessages.host;\r\n        this.updateWarningBanner();\r\n        this.setStatus(\"Formation deleted.\", \"success\");\r\n      })\r\n      .catch((error) => {\r\n        const message = error instanceof Error ? error.message : String(error);\r\n        this.warningMessages.host = message;\r\n        this.updateWarningBanner();\r\n        this.setStatus(message, \"error\");\r\n      });\r\n  }\r\n\r\n  private syncSelection(): void {\r\n    if (!this.formations.length) {\r\n      this.formations = [createFormation()];\r\n    }\r\n    if (this.selectedIndex < 0 || this.selectedIndex >= this.formations.length) {\r\n      this.selectedIndex = 0;\r\n    }\r\n    const formation = this.formations[this.selectedIndex];\r\n    const setValue = (name: string, value?: string) => {\r\n      const field = this.formEl.elements.namedItem(name) as HTMLInputElement | HTMLTextAreaElement | null;\r\n      if (field) field.value = value ?? \"\";\r\n    };\r\n\r\n    setValue(\"name\", formation.name);\r\n    setValue(\"role\", formation.role);\r\n    setValue(\"hqLocation\", formation.hqLocation);\r\n    setValue(\"commander\", formation.commander);\r\n    setValue(\"readiness\", formation.readiness);\r\n    setValue(\"strengthSummary\", formation.strengthSummary);\r\n    setValue(\"supportAssets\", formation.supportAssets);\r\n    setValue(\"communications\", formation.communications);\r\n    setValue(\"description\", formation.description);\r\n    setValue(\"image\", formation.image);\r\n    this.renderList();\r\n    this.renderCategories();\r\n    this.renderSubFormationRows();\r\n    this.setStatus(`Editing ${formation.name || \"formation\"}.`, \"default\");\r\n  }\r\n\r\n  private renderCategories(): void {\r\n    this.categoryListEl.innerHTML = \"\";\r\n    const formation = this.formations[this.selectedIndex];\r\n    const categories = formation.categories || [];\r\n    if (!categories.length) {\r\n      const helper = document.createElement(\"p\");\r\n      helper.className = \"empty\";\r\n      helper.textContent = \"No categories yet. Add one to assign units.\";\r\n      this.categoryListEl.appendChild(helper);\r\n    } else {\r\n      categories.forEach((category) => this.appendCategoryRow(category));\r\n    }\r\n    this.updateUnitsCount(categories);\r\n  }\r\n\r\n  private renderSubFormationRows(): void {\r\n    if (!this.subFormationListEl) return;\r\n    this.subFormationListEl.innerHTML = \"\";\r\n    const formation = this.formations[this.selectedIndex];\r\n    const links = this.normalizeSubFormationLinks(formation);\r\n    if (!links.length) {\r\n      this.subFormationListEl.innerHTML = '<p class=\"empty\">No attached formations.</p>';\r\n      return;\r\n    }\r\n    links.forEach((link) => this.appendSubFormationRow(link));\r\n    this.refreshSubFormationSelects();\r\n  }\r\n\r\n  private normalizeSubFormationLinks(formation: Formation): SubFormationAttachment[] {\r\n    const sanitized: SubFormationAttachment[] = [];\r\n    if (Array.isArray(formation.subFormationLinks) && formation.subFormationLinks.length) {\r\n      formation.subFormationLinks.forEach((link) => {\r\n        const parsedId = typeof link.formationId === \"string\" ? Number(link.formationId) : link.formationId;\r\n        if (typeof parsedId === \"number\" && !Number.isNaN(parsedId)) {\r\n          sanitized.push({ ...link, formationId: parsedId });\r\n        }\r\n      });\r\n      return sanitized;\r\n    }\r\n    if (Array.isArray(formation.subFormations) && formation.subFormations.length) {\r\n      formation.subFormations.forEach((id) => {\r\n        if (typeof id === \"number\" && !Number.isNaN(id)) {\r\n          sanitized.push({ formationId: id });\r\n        }\r\n      });\r\n    }\r\n    return sanitized;\r\n  }\r\n\r\n  private appendSubFormationRow(link?: SubFormationAttachment): void {\r\n    if (!this.subFormationListEl) return;\r\n    if (this.subFormationListEl.querySelector(\".empty\")) {\r\n      this.subFormationListEl.innerHTML = \"\";\r\n    }\r\n    const row = document.createElement(\"div\");\r\n    row.className = \"sub-formation-row\";\r\n    row.innerHTML = `\r\n      <div class=\"field\">\r\n        <label>Formation</label>\r\n        <select data-field=\"formation\"></select>\r\n      </div>\r\n      <div class=\"field\">\r\n        <label>Assignment</label>\r\n        <input data-field=\"assignment\" value=\"${link?.assignment ?? \"\"}\" />\r\n      </div>\r\n      <div class=\"field\">\r\n        <label>Strength</label>\r\n        <input data-field=\"strength\" value=\"${link?.strength ?? \"\"}\" />\r\n      </div>\r\n      <div class=\"field\">\r\n        <label>Readiness</label>\r\n        <input data-field=\"readiness\" value=\"${link?.readiness ?? \"\"}\" />\r\n      </div>\r\n      <div class=\"field full-row\">\r\n        <label>Notes</label>\r\n        <input data-field=\"notes\" value=\"${link?.notes ?? \"\"}\" />\r\n      </div>\r\n      <div class=\"row-actions\">\r\n        <button type=\"button\" class=\"ghost\" data-action=\"remove-sub-formation\">Remove</button>\r\n      </div>\r\n    `;\r\n    const select = row.querySelector<HTMLSelectElement>('select[data-field=\"formation\"]');\r\n    if (select) {\r\n      this.populateSubFormationOptions(select, link?.formationId);\r\n    }\r\n    this.subFormationListEl.appendChild(row);\r\n  }\r\n\r\n  private populateSubFormationOptions(select: HTMLSelectElement, selectedId?: number): void {\r\n    const currentId = this.getCurrentFormationIdentity();\r\n    const previousValue = selectedId ?? (select.value ? Number(select.value) : undefined);\r\n    select.innerHTML = \"\";\r\n    const placeholder = document.createElement(\"option\");\r\n    placeholder.value = \"\";\r\n    placeholder.textContent = \"Select formation\";\r\n    select.appendChild(placeholder);\r\n    this.formationOptions\r\n      .filter((option) => (currentId ? option.id !== currentId : true))\r\n      .forEach((option) => {\r\n        const opt = document.createElement(\"option\");\r\n        opt.value = option.id.toString();\r\n        opt.textContent = option.name;\r\n        select.appendChild(opt);\r\n      });\r\n    if (previousValue && !Number.isNaN(previousValue)) {\r\n      select.value = previousValue.toString();\r\n    } else {\r\n      select.value = \"\";\r\n    }\r\n  }\r\n\r\n  private refreshSubFormationSelects(): void {\r\n    if (!this.subFormationListEl) return;\r\n    const selects = Array.from(this.subFormationListEl.querySelectorAll<HTMLSelectElement>('select[data-field=\"formation\"]'));\r\n    selects.forEach((select) => {\r\n      const selected = select.value ? Number(select.value) : undefined;\r\n      this.populateSubFormationOptions(select, selected && !Number.isNaN(selected) ? selected : undefined);\r\n    });\r\n  }\r\n\r\n  private collectSubFormationLinks(): SubFormationAttachment[] {\r\n    if (!this.subFormationListEl) return [];\r\n    const rows = Array.from(this.subFormationListEl.querySelectorAll<HTMLElement>(\".sub-formation-row\"));\r\n    return rows\r\n      .map((row) => {\r\n        const select = row.querySelector<HTMLSelectElement>('select[data-field=\"formation\"]');\r\n        if (!select || !select.value) return null;\r\n        const formationId = Number(select.value);\r\n        if (!Number.isFinite(formationId)) return null;\r\n        const read = (field: string) =>\r\n          row.querySelector<HTMLInputElement>(`[data-field=\"${field}\"]`)?.value.trim() ?? \"\";\r\n        const attachment: SubFormationAttachment = {\r\n          formationId,\r\n          assignment: read(\"assignment\") || undefined,\r\n          strength: read(\"strength\") || undefined,\r\n          readiness: read(\"readiness\") || undefined,\r\n          notes: read(\"notes\") || undefined,\r\n        };\r\n        return attachment;\r\n      })\r\n      .filter((attachment): attachment is SubFormationAttachment => Boolean(attachment));\r\n  }\r\n\r\n  private appendCategoryRow(category?: FormationCategory): void {\r\n    const row = document.createElement(\"div\");\r\n    row.className = \"category-row\";\r\n    row.innerHTML = `\r\n      <div class=\"field\">\r\n        <label>Category name</label>\r\n        <input data-field=\"name\" value=\"${category?.name || \"\"}\" />\r\n      </div>\r\n      <div class=\"field\">\r\n        <label>Assign units</label>\r\n        <select data-field=\"units\" multiple size=\"5\"></select>\r\n      </div>\r\n      <div class=\"row-actions\">\r\n        <button type=\"button\" class=\"ghost\" data-action=\"remove-category\">Remove</button>\r\n      </div>\r\n    `;\r\n    const select = row.querySelector<HTMLSelectElement>('select[data-field=\"units\"]')!;\r\n    const selected = new Set((category?.units || []).map((value) => Number(value)));\r\n    this.populateUnitOptions(select, selected);\r\n    this.categoryListEl.appendChild(row);\r\n  }\r\n\r\n  private populateUnitOptions(select: HTMLSelectElement, selected: Set<number>): void {\r\n    select.innerHTML = \"\";\r\n    if (!this.unitOptions.length) {\r\n      const option = document.createElement(\"option\");\r\n      option.textContent = \"No units available\";\r\n      option.disabled = true;\r\n      select.appendChild(option);\r\n      return;\r\n    }\r\n    this.unitOptions.forEach(({ id, label }) => {\r\n      const option = document.createElement(\"option\");\r\n      option.value = id.toString();\r\n      option.textContent = label;\r\n      if (selected.has(id)) option.selected = true;\r\n      select.appendChild(option);\r\n    });\r\n  }\r\n\r\n  private collectCategoriesFromDom(): FormationCategory[] {\r\n    const rows = Array.from(this.categoryListEl.querySelectorAll<HTMLElement>(\".category-row\"));\r\n    return rows.map((row) => {\r\n      const nameInput = row.querySelector<HTMLInputElement>('input[data-field=\"name\"]');\r\n      const select = row.querySelector<HTMLSelectElement>('select[data-field=\"units\"]');\r\n      const units = select\r\n        ? Array.from(select.selectedOptions)\r\n          .map((opt) => Number(opt.value))\r\n          .filter((value) => !Number.isNaN(value))\r\n        : [];\r\n      return {\r\n        name: (nameInput?.value || \"\").trim(),\r\n        units,\r\n      };\r\n    });\r\n  }\r\n\r\n  private updateUnitsCount(categories: FormationCategory[]): void {\r\n    const unique = new Set<number>();\r\n    categories.forEach((category) => (category.units || []).forEach((unitId) => unique.add(unitId)));\r\n    this.unitsCountEl.textContent = unique.size.toString();\r\n  }\r\n\r\n  private rebuildFormationOptions(): void {\r\n    const validFormations = this.formations.filter((formation) => typeof formation.id === \"number\" && Number.isFinite(formation.id));\r\n    const missingCount = this.formations.length - validFormations.length;\r\n    this.formationOptions = validFormations.map((formation) => {\r\n      const id = formation.id as number;\r\n      return {\r\n        id,\r\n        name: formation.name || `Formation ${id}`,\r\n      };\r\n    });\r\n    this.formationAttachmentGate = this.formations.length > 0 && validFormations.length === 0;\r\n    this.warningMessages.formations = missingCount\r\n      ? `${missingCount} formation${missingCount === 1 ? \"\" : \"s\"} lack IDs and cannot be attached yet. Save them first.`\r\n      : undefined;\r\n    this.updateWarningBanner();\r\n    this.refreshSubFormationSelects();\r\n  }\r\n\r\n  private getCurrentFormationIdentity(): number | undefined {\r\n    const formation = this.formations[this.selectedIndex];\r\n    const formationId = formation && typeof formation.id === \"number\" && Number.isFinite(formation.id) ? formation.id : undefined;\r\n    return formationId;\r\n  }\r\n\r\n  private saveFormation(): void {\r\n    if (!this.formations.length) return;\r\n    if (this.unitIdGate) {\r\n      this.setStatus(\"Cannot save while units are missing IDs. Request the host to assign IDs and try again.\", \"error\");\r\n      return;\r\n    }\r\n    const formation = { ...this.formations[this.selectedIndex] };\r\n    const readValue = (name: string) =>\r\n      (this.formEl.elements.namedItem(name) as HTMLInputElement | HTMLTextAreaElement | null)?.value.trim() ?? \"\";\r\n\r\n    formation.name = readValue(\"name\");\r\n    formation.role = readValue(\"role\") || undefined;\r\n    formation.hqLocation = readValue(\"hqLocation\") || undefined;\r\n    formation.commander = readValue(\"commander\") || undefined;\r\n    formation.readiness = readValue(\"readiness\") || undefined;\r\n    formation.strengthSummary = readValue(\"strengthSummary\") || undefined;\r\n    formation.supportAssets = readValue(\"supportAssets\") || undefined;\r\n    formation.communications = readValue(\"communications\") || undefined;\r\n    formation.description = readValue(\"description\") || undefined;\r\n    formation.image = readValue(\"image\") || undefined;\r\n    formation.categories = this.collectCategoriesFromDom();\r\n    formation.subFormationLinks = this.collectSubFormationLinks();\r\n    formation.subFormations = (formation.subFormationLinks || [])\r\n      .map((link) => link.formationId)\r\n      .filter((value): value is number => typeof value === \"number\" && !Number.isNaN(value));\r\n    this.updateUnitsCount(formation.categories || []);\r\n    this.formations[this.selectedIndex] = formation;\r\n    this.rebuildFormationOptions();\r\n    formationService\r\n      .saveFormations(this.formations)\r\n      .then(() => {\r\n        delete this.warningMessages.host;\r\n        this.updateWarningBanner();\r\n        this.setStatus(\"Formation saved.\", \"success\");\r\n      })\r\n      .catch((error) => {\r\n        const message = error instanceof Error ? error.message : String(error);\r\n        this.warningMessages.host = message;\r\n        this.updateWarningBanner();\r\n        this.setStatus(message, \"error\");\r\n      });\r\n  }\r\n\r\n  private updateWarningBanner(): void {\r\n    if (!this.warningBannerEl) return;\r\n    const messages = Object.values(this.warningMessages).filter((msg): msg is string => Boolean(msg));\r\n    if (!messages.length) {\r\n      this.warningBannerEl.classList.add(\"hidden\");\r\n      this.warningBannerEl.textContent = \"\";\r\n      this.warningBannerEl.setAttribute(\"aria-hidden\", \"true\");\r\n      return;\r\n    }\r\n    this.warningBannerEl.classList.remove(\"hidden\");\r\n    this.warningBannerEl.removeAttribute(\"aria-hidden\");\r\n    this.warningBannerEl.innerHTML = messages.map((msg) => `<p>${msg}</p>`).join(\"\");\r\n  }\r\n\r\n  private setLoadError(message?: string): void {\r\n    if (!this.loadErrorEl) return;\r\n    if (!message) {\r\n      this.loadErrorEl.classList.add(\"hidden\");\r\n      this.loadErrorEl.setAttribute(\"aria-hidden\", \"true\");\r\n      this.loadErrorTextEl.textContent = \"\";\r\n      return;\r\n    }\r\n    this.loadErrorEl.classList.remove(\"hidden\");\r\n    this.loadErrorEl.removeAttribute(\"aria-hidden\");\r\n    this.loadErrorTextEl.textContent = message;\r\n  }\r\n\r\n  private async reloadFormations(): Promise<void> {\r\n    try {\r\n      this.setLoadError();\r\n      await formationService.loadFormations();\r\n    } catch (error) {\r\n      const message = error instanceof Error ? error.message : String(error);\r\n      this.setLoadError(`Failed to load formations: ${message}`);\r\n      this.setStatus(\"Unable to load formations from host.\", \"error\");\r\n    }\r\n  }\r\n\r\n  private setStatus(message: string, tone: \"default\" | \"success\" | \"error\"): void {\r\n    this.statusEl.textContent = message;\r\n    this.statusEl.dataset.tone = tone;\r\n  }\r\n}\r\n","import type { Nation } from \"../types\";\r\nimport { nationService } from \"../services/nationService\";\r\nimport { formationService } from \"../services/formationService\";\r\n\r\nconst createNation = (): Nation => ({\r\n  name: \"New Nation\",\r\n  description: \"\",\r\n  image: \"\",\r\n  formations: [],\r\n});\r\n\r\nexport class NationsPanel {\r\n  private root: HTMLElement;\r\n  private listEl!: HTMLElement;\r\n  private formEl!: HTMLFormElement;\r\n  private statusEl!: HTMLElement;\r\n  private warningEl!: HTMLElement;\r\n  private loadErrorEl!: HTMLElement;\r\n  private loadErrorTextEl!: HTMLElement;\r\n  private formationSelectEl!: HTMLSelectElement;\r\n  private nationCountEl?: HTMLElement;\r\n  private availableFormationCountEl?: HTMLElement;\r\n  private nations: Nation[] = [];\r\n  private formationOptions: { id: number; name: string }[] = [];\r\n  private selectedIndex = 0;\r\n  private formationIdGate = false;\r\n  private formationWarning?: string;\r\n  private hostWarning?: string;\r\n\r\n  constructor(root: HTMLElement) {\r\n    this.root = root;\r\n  }\r\n\r\n  init(): void {\r\n    this.renderLayout();\r\n    this.cacheElements();\r\n    this.bindEvents();\r\n    nationService.subscribe((nations) => {\r\n      this.nations = nations.length ? nations : [createNation()];\r\n      if (this.nationCountEl) this.nationCountEl.textContent = nations.length.toString();\r\n      this.renderList();\r\n      this.syncSelection();\r\n    });\r\n    formationService.subscribe((formations) => {\r\n      const validFormations = formations.filter((formation) => typeof formation.id === \"number\" && Number.isFinite(formation.id));\r\n      const missing = formations.length - validFormations.length;\r\n      this.formationOptions = validFormations.map((formation) => {\r\n        const id = formation.id as number;\r\n        return {\r\n          id,\r\n          name: formation.name || `Formation ${id}`,\r\n        };\r\n      });\r\n      this.formationIdGate = formations.length > 0 && validFormations.length === 0;\r\n      this.formationWarning = missing\r\n        ? `${missing} formation${missing === 1 ? \"\" : \"s\"} are missing IDs. Save formations before assigning them to nations.`\r\n        : undefined;\r\n      this.updateWarningBanner();\r\n      if (this.availableFormationCountEl) this.availableFormationCountEl.textContent = validFormations.length.toString();\r\n      this.renderFormationSelect();\r\n    });\r\n    void this.reloadNations();\r\n  }\r\n\r\n  private renderLayout(): void {\r\n    this.root.innerHTML = `\r\n      <div class=\"workspace\">\r\n        <aside class=\"sidebar\">\r\n          <header class=\"sidebar-header\">\r\n            <div>\r\n              <p class=\"eyebrow\">Doctrine profiles</p>\r\n              <h1>Nation Builder</h1>\r\n              <p class=\"muted\">Bind formations to geopolitical blueprints.</p>\r\n            </div>\r\n            <button type=\"button\" class=\"ghost\" data-action=\"add-nation\">+ Nation</button>\r\n          </header>\r\n          <div class=\"unit-list\" data-role=\"nation-list\"></div>\r\n          <div class=\"meta-bar compact\">\r\n            <span>Nations: <strong data-role=\"nation-count\">0</strong></span>\r\n            <span>Formations ready: <strong data-role=\"nation-formation-count\">0</strong></span>\r\n          </div>\r\n        </aside>\r\n        <section class=\"editor\">\r\n          <header class=\"editor-header\">\r\n            <div>\r\n              <p class=\"eyebrow\">Nation Editor</p>\r\n              <h2>Strategic Profiles</h2>\r\n              <p class=\"muted\">Track doctrine notes, emblems, and attached formations.</p>\r\n            </div>\r\n          </header>\r\n          <div class=\"inline-warning hidden\" data-role=\"nation-warning\"></div>\r\n          <div class=\"inline-error hidden\" data-role=\"nation-load-error\">\r\n            <span data-role=\"nation-load-error-text\"></span>\r\n            <button type=\"button\" class=\"ghost\" data-action=\"retry-nations\">Retry load</button>\r\n          </div>\r\n          <form data-role=\"nation-form\" class=\"editor-form\">\r\n            <section class=\"panel grid-3\">\r\n              <div class=\"field\">\r\n                <label>Name</label>\r\n                <input name=\"name\" autocomplete=\"off\" />\r\n              </div>\r\n              <div class=\"field\">\r\n                <label>Description</label>\r\n                <textarea name=\"description\" rows=\"3\"></textarea>\r\n              </div>\r\n              <div class=\"field\">\r\n                <label>Image</label>\r\n                <input name=\"image\" placeholder=\"nations/emblem.png\" />\r\n              </div>\r\n            </section>\r\n            <section class=\"panel\">\r\n              <div class=\"panel-heading\">\r\n                <h3>Assigned formations</h3>\r\n                <span class=\"muted small\">Ctrl/Cmd + click to multi-select</span>\r\n              </div>\r\n              <select data-role=\"formation-select\" multiple size=\"6\"></select>\r\n            </section>\r\n            <div class=\"form-actions\">\r\n              <button type=\"button\" class=\"ghost danger\" data-action=\"delete-nation\">Delete nation</button>\r\n              <button type=\"submit\" class=\"primary\">Save nation</button>\r\n            </div>\r\n          </form>\r\n          <div class=\"status-bar\" data-role=\"nation-status\">Select a nation.</div>\r\n        </section>\r\n      </div>\r\n    `;\r\n  }\r\n\r\n  private cacheElements(): void {\r\n    this.listEl = this.root.querySelector<HTMLElement>('[data-role=\"nation-list\"]')!;\r\n    this.formEl = this.root.querySelector<HTMLFormElement>('[data-role=\"nation-form\"]')!;\r\n    this.statusEl = this.root.querySelector<HTMLElement>('[data-role=\"nation-status\"]')!;\r\n    this.warningEl = this.root.querySelector<HTMLElement>('[data-role=\"nation-warning\"]')!;\r\n    this.loadErrorEl = this.root.querySelector<HTMLElement>('[data-role=\"nation-load-error\"]')!;\r\n    this.loadErrorTextEl = this.loadErrorEl.querySelector<HTMLElement>('[data-role=\"nation-load-error-text\"]')!;\r\n    this.formationSelectEl = this.root.querySelector<HTMLSelectElement>('[data-role=\"formation-select\"]')!;\r\n    this.nationCountEl = this.root.querySelector<HTMLElement>('[data-role=\"nation-count\"]') ?? undefined;\r\n    this.availableFormationCountEl = this.root.querySelector<HTMLElement>('[data-role=\"nation-formation-count\"]') ?? undefined;\r\n  }\r\n\r\n  private bindEvents(): void {\r\n    this.listEl.addEventListener(\"click\", (event) => {\r\n      const button = (event.target as HTMLElement).closest<HTMLButtonElement>(\"[data-index]\");\r\n      if (!button) return;\r\n      const index = Number(button.dataset.index);\r\n      if (Number.isNaN(index)) return;\r\n      this.selectedIndex = index;\r\n      this.syncSelection();\r\n    });\r\n\r\n    this.formEl.addEventListener(\"submit\", (event) => {\r\n      event.preventDefault();\r\n      this.saveNation();\r\n    });\r\n\r\n    this.root.addEventListener(\"click\", (event) => {\r\n      const button = (event.target as HTMLElement).closest<HTMLButtonElement>(\"[data-action]\");\r\n      if (!button) return;\r\n      const action = button.dataset.action;\r\n      if (action === \"add-nation\") {\r\n        this.addNation();\r\n      } else if (action === \"retry-nations\") {\r\n        void this.reloadNations();\r\n      } else if (action === \"delete-nation\") {\r\n        this.deleteNation();\r\n      }\r\n    });\r\n  }\r\n\r\n  private addNation(): void {\r\n    this.nations.push(createNation());\r\n    this.selectedIndex = this.nations.length - 1;\r\n    if (this.nationCountEl) this.nationCountEl.textContent = this.nations.length.toString();\r\n    this.renderList();\r\n    this.syncSelection();\r\n    this.setStatus(\"New nation ready for details.\", \"success\");\r\n  }\r\n\r\n  private deleteNation(): void {\r\n    if (!this.nations.length) return;\r\n    this.nations.splice(this.selectedIndex, 1);\r\n    const payload = this.nations.slice();\r\n    this.selectedIndex = Math.max(0, this.selectedIndex - 1);\r\n    if (!this.nations.length) {\r\n      this.nations = [createNation()];\r\n      this.selectedIndex = 0;\r\n    }\r\n    if (this.nationCountEl) this.nationCountEl.textContent = payload.length.toString();\r\n    this.syncSelection();\r\n    nationService\r\n      .saveNations(payload)\r\n      .then(() => {\r\n        this.hostWarning = undefined;\r\n        this.updateWarningBanner();\r\n        this.setStatus(\"Nation deleted.\", \"success\");\r\n      })\r\n      .catch((error) => {\r\n        const message = error instanceof Error ? error.message : String(error);\r\n        this.hostWarning = message;\r\n        this.updateWarningBanner();\r\n        this.setStatus(message, \"error\");\r\n      });\r\n  }\r\n\r\n  private renderList(): void {\r\n    if (!this.nations.length) {\r\n      this.listEl.innerHTML = '<p class=\"empty\">No nations defined.</p>';\r\n      return;\r\n    }\r\n    this.listEl.innerHTML = \"\";\r\n    this.nations.forEach((nation, index) => {\r\n      const btn = document.createElement(\"button\");\r\n      btn.type = \"button\";\r\n      btn.dataset.index = index.toString();\r\n      btn.className = `unit-pill${index === this.selectedIndex ? \" active\" : \"\"}`;\r\n      btn.innerHTML = `\r\n        <span class=\"title\">${nation.name || \"Unnamed nation\"}</span>\r\n        <span class=\"meta\">${nation.formations?.length ?? 0} formations</span>\r\n      `;\r\n      this.listEl.appendChild(btn);\r\n    });\r\n  }\r\n\r\n  private syncSelection(): void {\r\n    if (!this.nations.length) {\r\n      this.nations = [createNation()];\r\n    }\r\n    if (this.selectedIndex < 0 || this.selectedIndex >= this.nations.length) {\r\n      this.selectedIndex = 0;\r\n    }\r\n    const nation = this.nations[this.selectedIndex];\r\n    (this.formEl.elements.namedItem(\"name\") as HTMLInputElement).value = nation.name || \"\";\r\n    (this.formEl.elements.namedItem(\"description\") as HTMLTextAreaElement).value = nation.description || \"\";\r\n    (this.formEl.elements.namedItem(\"image\") as HTMLInputElement).value = nation.image || \"\";\r\n    this.renderList();\r\n    this.renderFormationSelect();\r\n    this.setStatus(`Editing ${nation.name || \"nation\"}.`, \"default\");\r\n  }\r\n\r\n  private renderFormationSelect(): void {\r\n    if (!this.formationSelectEl) return;\r\n    const nation = this.nations[this.selectedIndex];\r\n    const selected = new Set((nation?.formations || []).map((value) => Number(value)));\r\n    this.formationSelectEl.innerHTML = \"\";\r\n    if (!this.formationOptions.length) {\r\n      const opt = document.createElement(\"option\");\r\n      opt.disabled = true;\r\n      opt.textContent = this.formationWarning || \"No formations available\";\r\n      this.formationSelectEl.appendChild(opt);\r\n      return;\r\n    }\r\n    this.formationOptions.forEach(({ id, name }) => {\r\n      const option = document.createElement(\"option\");\r\n      option.value = id.toString();\r\n      option.textContent = name;\r\n      if (selected.has(id)) option.selected = true;\r\n      this.formationSelectEl.appendChild(option);\r\n    });\r\n  }\r\n\r\n  private saveNation(): void {\r\n    if (!this.nations.length) return;\r\n    if (this.formationIdGate) {\r\n      this.setStatus(\"Cannot save nations while formations are missing IDs. Save formations first.\", \"error\");\r\n      return;\r\n    }\r\n    const nation = { ...this.nations[this.selectedIndex] };\r\n    nation.name = (this.formEl.elements.namedItem(\"name\") as HTMLInputElement).value.trim();\r\n    nation.description = (this.formEl.elements.namedItem(\"description\") as HTMLTextAreaElement).value.trim();\r\n    nation.image = (this.formEl.elements.namedItem(\"image\") as HTMLInputElement).value.trim();\r\n    nation.formations = Array.from(this.formationSelectEl.selectedOptions)\r\n      .map((option) => Number(option.value))\r\n      .filter((value) => !Number.isNaN(value));\r\n    this.nations[this.selectedIndex] = nation;\r\n    nationService\r\n      .saveNations(this.nations)\r\n      .then(() => {\r\n        this.hostWarning = undefined;\r\n        this.updateWarningBanner();\r\n        this.setStatus(\"Nation saved.\", \"success\");\r\n      })\r\n      .catch((error) => {\r\n        const message = error instanceof Error ? error.message : String(error);\r\n        this.hostWarning = message;\r\n        this.updateWarningBanner();\r\n        this.setStatus(message, \"error\");\r\n      });\r\n  }\r\n\r\n  private updateWarningBanner(): void {\r\n    if (!this.warningEl) return;\r\n    const messages = [this.formationWarning, this.hostWarning].filter((msg): msg is string => Boolean(msg));\r\n    if (!messages.length) {\r\n      this.warningEl.classList.add(\"hidden\");\r\n      this.warningEl.textContent = \"\";\r\n      this.warningEl.setAttribute(\"aria-hidden\", \"true\");\r\n      return;\r\n    }\r\n    this.warningEl.classList.remove(\"hidden\");\r\n    this.warningEl.removeAttribute(\"aria-hidden\");\r\n    this.warningEl.innerHTML = messages.map((msg) => `<p>${msg}</p>`).join(\"\");\r\n  }\r\n\r\n  private setNationLoadError(message?: string): void {\r\n    if (!this.loadErrorEl) return;\r\n    if (!message) {\r\n      this.loadErrorEl.classList.add(\"hidden\");\r\n      this.loadErrorEl.setAttribute(\"aria-hidden\", \"true\");\r\n      this.loadErrorTextEl.textContent = \"\";\r\n      return;\r\n    }\r\n    this.loadErrorEl.classList.remove(\"hidden\");\r\n    this.loadErrorEl.removeAttribute(\"aria-hidden\");\r\n    this.loadErrorTextEl.textContent = message;\r\n  }\r\n\r\n  private async reloadNations(): Promise<void> {\r\n    try {\r\n      this.setNationLoadError();\r\n      await nationService.loadNations();\r\n    } catch (error) {\r\n      const message = error instanceof Error ? error.message : String(error);\r\n      this.setNationLoadError(`Failed to load nations: ${message}`);\r\n      this.setStatus(\"Unable to load nations from host.\", \"error\");\r\n    }\r\n  }\r\n\r\n  private setStatus(message: string, tone: \"default\" | \"success\" | \"error\"): void {\r\n    this.statusEl.textContent = message;\r\n    this.statusEl.dataset.tone = tone;\r\n  }\r\n}\r\n","import type { AppSettings } from \"../types\";\r\n\r\nconst DEFAULT_ACCENT = \"#6dd5fa\";\r\n\r\nconst clamp = (value: number, min: number, max: number) => Math.min(Math.max(value, min), max);\r\n\r\nconst shadeColor = (hex: string, percent: number): string => {\r\n  const normalized = hex.replace(\"#\", \"\");\r\n  if (!/^[0-9a-f]{6}$/i.test(normalized)) return hex;\r\n  const num = parseInt(normalized, 16);\r\n  const r = clamp(((num >> 16) & 0xff) + percent * 255, 0, 255);\r\n  const g = clamp(((num >> 8) & 0xff) + percent * 255, 0, 255);\r\n  const b = clamp((num & 0xff) + percent * 255, 0, 255);\r\n  return `#${((1 << 24) + (Math.round(r) << 16) + (Math.round(g) << 8) + Math.round(b)).toString(16).slice(1)}`;\r\n};\r\n\r\nexport const applyTheme = (settings: AppSettings): void => {\r\n  const root = document.documentElement;\r\n  const theme = settings.theme || \"\";\r\n  if (theme) {\r\n    root.dataset.theme = theme;\r\n  } else {\r\n    root.removeAttribute(\"data-theme\");\r\n  }\r\n  const accent = typeof settings.accentColor === \"string\" && settings.accentColor ? settings.accentColor : DEFAULT_ACCENT;\r\n  root.style.setProperty(\"--accent\", accent);\r\n  root.style.setProperty(\"--accent-dark\", shadeColor(accent, -0.35));\r\n};\r\n","import { hostBridge } from \"../lib/hostBridge\";\r\nimport type { ServerDiagnostics, ServerLogEntry, ServerMetadata } from \"../types\";\r\n\r\ntype MetadataListener = (metadata?: ServerMetadata) => void;\r\ntype LogListener = (entries: ServerLogEntry[]) => void;\r\ntype DiagnosticsListener = (diagnostics?: ServerDiagnostics) => void;\r\n\r\ntype HostInfoPayload = {\r\n    server?: Partial<ServerMetadata> | Record<string, unknown>;\r\n    Server?: Partial<ServerMetadata> | Record<string, unknown>;\r\n};\r\n\r\ntype ServerLogEnvelope = {\r\n    entries?: unknown;\r\n};\r\n\r\nclass ServerService {\r\n    private metadata?: ServerMetadata;\r\n    private logs: ServerLogEntry[] = [];\r\n    private diagnostics?: ServerDiagnostics;\r\n    private readonly metadataListeners = new Set<MetadataListener>();\r\n    private readonly logListeners = new Set<LogListener>();\r\n    private readonly diagnosticsListeners = new Set<DiagnosticsListener>();\r\n    private requestedInitialDiagnostics = false;\r\n\r\n    public readonly isSupported: boolean = hostBridge.isAvailable;\r\n\r\n    constructor() {\r\n        if (!this.isSupported) {\r\n            return;\r\n        }\r\n\r\n        hostBridge.on(\"host-info\", (payload) => this.handleHostInfo(payload as HostInfoPayload));\r\n        hostBridge.on(\"server-logs\", (payload) => this.applyLogSnapshot(payload as ServerLogEnvelope));\r\n        hostBridge.on(\"server-log-event\", (payload) => this.appendLog(payload as Partial<ServerLogEntry>));\r\n    }\r\n\r\n    init(): void {\r\n        if (!this.isSupported) {\r\n            return;\r\n        }\r\n        hostBridge.postMessage(\"host-info-request\");\r\n        hostBridge.postMessage(\"get-server-logs\");\r\n    }\r\n\r\n    subscribeToMetadata(listener: MetadataListener): () => void {\r\n        this.metadataListeners.add(listener);\r\n        listener(this.metadata);\r\n        return () => this.metadataListeners.delete(listener);\r\n    }\r\n\r\n    subscribeToLogs(listener: LogListener): () => void {\r\n        this.logListeners.add(listener);\r\n        listener(this.logs.slice());\r\n        return () => this.logListeners.delete(listener);\r\n    }\r\n\r\n    subscribeToDiagnostics(listener: DiagnosticsListener): () => void {\r\n        this.diagnosticsListeners.add(listener);\r\n        listener(this.diagnostics);\r\n        return () => this.diagnosticsListeners.delete(listener);\r\n    }\r\n\r\n    refreshLogs(): void {\r\n        if (!this.isSupported) {\r\n            return;\r\n        }\r\n        hostBridge.postMessage(\"get-server-logs\");\r\n    }\r\n\r\n    async fetchDiagnostics(): Promise<ServerDiagnostics> {\r\n        if (!this.isSupported) {\r\n            throw new Error(\"Local server is not available in this environment.\");\r\n        }\r\n        if (!this.metadata?.baseUrl) {\r\n            throw new Error(\"Server metadata is not yet available.\");\r\n        }\r\n\r\n        const response = await fetch(`${this.metadata.baseUrl}/api/diagnostics`, {\r\n            headers: this.buildHeaders(),\r\n        });\r\n\r\n        if (!response.ok) {\r\n            throw new Error(`Diagnostics request failed (${response.status})`);\r\n        }\r\n\r\n        const payload = (await response.json()) as ServerDiagnostics;\r\n        this.diagnostics = payload;\r\n        this.notifyDiagnostics();\r\n        return payload;\r\n    }\r\n\r\n    getMetadata(): ServerMetadata | undefined {\r\n        return this.metadata;\r\n    }\r\n\r\n    getLogs(): ServerLogEntry[] {\r\n        return this.logs.slice();\r\n    }\r\n\r\n    private buildHeaders(): HeadersInit {\r\n        const headers: Record<string, string> = {\r\n            Accept: \"application/json\",\r\n        };\r\n        if (this.metadata?.token) {\r\n            headers[\"X-Server-Token\"] = this.metadata.token;\r\n        }\r\n        return headers;\r\n    }\r\n\r\n    private handleHostInfo(payload?: HostInfoPayload): void {\r\n        if (!payload) return;\r\n        const raw = payload.server ?? payload.Server;\r\n        if (!raw) return;\r\n        const bag = raw as Record<string, unknown>;\r\n        const pickString = (...keys: string[]) => {\r\n            for (const key of keys) {\r\n                const value = bag[key];\r\n                if (typeof value === \"string\") {\r\n                    return value;\r\n                }\r\n            }\r\n            return undefined;\r\n        };\r\n        const pickNumber = (...keys: string[]) => {\r\n            for (const key of keys) {\r\n                const value = bag[key];\r\n                if (typeof value === \"number\") {\r\n                    return value;\r\n                }\r\n            }\r\n            return undefined;\r\n        };\r\n\r\n        this.metadata = {\r\n            baseUrl: pickString(\"baseUrl\", \"BaseUrl\"),\r\n            port: pickNumber(\"port\", \"Port\"),\r\n            token: pickString(\"token\", \"Token\"),\r\n            startedAt: pickString(\"startedAt\", \"StartedAt\"),\r\n        };\r\n\r\n        this.notifyMetadata();\r\n        this.primeDiagnostics();\r\n    }\r\n\r\n    private applyLogSnapshot(payload?: ServerLogEnvelope): void {\r\n        if (!payload) {\r\n            this.logs = [];\r\n            this.notifyLogs();\r\n            return;\r\n        }\r\n\r\n        const entries = Array.isArray(payload.entries) ? payload.entries : [];\r\n        this.logs = entries.map((entry) => this.normalizeLog(entry as Partial<ServerLogEntry>));\r\n        this.notifyLogs();\r\n    }\r\n\r\n    private appendLog(payload?: Partial<ServerLogEntry>): void {\r\n        if (!payload) return;\r\n        const entry = this.normalizeLog(payload);\r\n        this.logs = [...this.logs.slice(-499), entry];\r\n        this.notifyLogs();\r\n    }\r\n\r\n    private normalizeLog(entry: Partial<ServerLogEntry>): ServerLogEntry {\r\n        const timestamp = typeof entry.timestamp === \"string\" ? entry.timestamp : new Date().toISOString();\r\n        return {\r\n            timestamp,\r\n            level: entry.level ?? \"Information\",\r\n            category: entry.category ?? \"server\",\r\n            message: entry.message ?? \"(no message provided)\",\r\n            exception: entry.exception ?? null,\r\n            statusCode: typeof entry.statusCode === \"number\" ? entry.statusCode : null,\r\n            durationMs: typeof entry.durationMs === \"number\" ? entry.durationMs : null,\r\n        };\r\n    }\r\n\r\n    private notifyMetadata(): void {\r\n        this.metadataListeners.forEach((listener) => {\r\n            try {\r\n                listener(this.metadata);\r\n            } catch (error) {\r\n                console.error(\"[serverService] Metadata listener failed\", error);\r\n            }\r\n        });\r\n    }\r\n\r\n    private notifyLogs(): void {\r\n        const snapshot = this.logs.slice();\r\n        this.logListeners.forEach((listener) => {\r\n            try {\r\n                listener(snapshot);\r\n            } catch (error) {\r\n                console.error(\"[serverService] Log listener failed\", error);\r\n            }\r\n        });\r\n    }\r\n\r\n    private notifyDiagnostics(): void {\r\n        this.diagnosticsListeners.forEach((listener) => {\r\n            try {\r\n                listener(this.diagnostics);\r\n            } catch (error) {\r\n                console.error(\"[serverService] Diagnostics listener failed\", error);\r\n            }\r\n        });\r\n    }\r\n\r\n    private primeDiagnostics(): void {\r\n        if (this.requestedInitialDiagnostics) return;\r\n        if (!this.metadata?.baseUrl) return;\r\n        this.requestedInitialDiagnostics = true;\r\n        this.fetchDiagnostics().catch((error) => {\r\n            this.requestedInitialDiagnostics = false;\r\n            console.warn(\"[serverService] Initial diagnostics fetch failed\", error);\r\n        });\r\n    }\r\n}\r\n\r\nexport const serverService = new ServerService();","import type { AppSettings, ServerDiagnostics, ServerLogEntry, ServerMetadata } from \"../types\";\r\nimport { settingsService } from \"../services/settingsService\";\r\nimport { applyTheme } from \"../lib/theme\";\r\nimport { serverService } from \"../services/serverService\";\r\n\r\nexport class SettingsPanel {\r\n  private root: HTMLElement;\r\n  private formEl!: HTMLFormElement;\r\n  private statusEl!: HTMLElement;\r\n  private settings: AppSettings = {};\r\n  private serverConsoleEl!: HTMLElement;\r\n  private serverStatusPill!: HTMLElement;\r\n  private serverMetaEl!: HTMLElement;\r\n  private serverLogView!: HTMLElement;\r\n  private serverDiagOutputEl!: HTMLElement;\r\n  private serverConsoleStatusEl!: HTMLElement;\r\n  private serverRefreshBtn?: HTMLButtonElement;\r\n  private serverDiagBtn?: HTMLButtonElement;\r\n  private serverFilterInput?: HTMLInputElement;\r\n  private serverAutoScrollToggle?: HTMLInputElement;\r\n  private serverLogs: ServerLogEntry[] = [];\r\n  private serverMetadata?: ServerMetadata;\r\n  private serverDiagnostics?: ServerDiagnostics;\r\n  private autoScroll = true;\r\n  private readonly unsubscribers: Array<() => void> = [];\r\n\r\n  constructor(root: HTMLElement) {\r\n    this.root = root;\r\n  }\r\n\r\n  init(): void {\r\n    this.renderLayout();\r\n    this.cacheElements();\r\n    this.bindEvents();\r\n    settingsService.subscribe((settings) => {\r\n      this.settings = settings;\r\n      this.syncForm();\r\n    });\r\n    settingsService.loadSettings().catch((error) => {\r\n      this.setStatus(error instanceof Error ? error.message : String(error), \"error\");\r\n    });\r\n  }\r\n\r\n  private renderLayout(): void {\r\n    this.root.innerHTML = `\r\n      <div class=\"panel settings-panel\">\r\n        <div class=\"panel-heading\">\r\n          <h3>Application Settings</h3>\r\n          <p class=\"muted\">Customize theme, locale, and experimental flags.</p>\r\n        </div>\r\n        <form class=\"grid-3\" data-role=\"settings-form\">\r\n          <div class=\"field\">\r\n            <label>Theme</label>\r\n            <select name=\"theme\">\r\n              <option value=\"\">System Default</option>\r\n              <option value=\"light\">Light</option>\r\n              <option value=\"dark\">Dark</option>\r\n              <option value=\"midnight\">Midnight</option>\r\n              <option value=\"aurora\">Aurora</option>\r\n              <option value=\"terminal\">Terminal</option>\r\n            </select>\r\n          </div>\r\n          <div class=\"field\">\r\n            <label>Locale</label>\r\n            <input name=\"locale\" placeholder=\"en-US\" />\r\n          </div>\r\n          <div class=\"field\">\r\n            <label>Accent color</label>\r\n            <input name=\"accentColor\" type=\"color\" value=\"#6dd5fa\" />\r\n          </div>\r\n          <div class=\"field\">\r\n            <label>\r\n              <input type=\"checkbox\" name=\"enableExperimental\" />\r\n              Enable experimental modules\r\n            </label>\r\n          </div>\r\n          <div class=\"field full\">\r\n            <button type=\"submit\" class=\"primary\">Save settings</button>\r\n          </div>\r\n        </form>\r\n        <div class=\"status-bar compact\" data-role=\"settings-status\">Adjust settings and save.</div>\r\n        <div class=\"panel server-console\" data-role=\"server-console\">\r\n          <div class=\"panel-heading spaced\">\r\n            <div>\r\n              <h3>Local Server Console</h3>\r\n              <p class=\"muted\">Inspect embedded API health, logs, and diagnostics output.</p>\r\n            </div>\r\n            <span class=\"pill\" data-role=\"server-status-pill\">Host offline</span>\r\n          </div>\r\n          <div class=\"server-console-actions\">\r\n            <button type=\"button\" class=\"ghost\" data-role=\"refresh-logs\">Refresh logs</button>\r\n            <button type=\"button\" class=\"ghost\" data-role=\"run-diagnostics\">Run diagnostics</button>\r\n            <label class=\"inline\">\r\n              <input type=\"checkbox\" data-role=\"auto-scroll\" checked />\r\n              Autoscroll\r\n            </label>\r\n            <input type=\"search\" placeholder=\"Filter logs\" data-role=\"log-filter\" />\r\n          </div>\r\n          <div class=\"server-meta\" data-role=\"server-meta\">Server details unavailable.</div>\r\n          <div class=\"server-log-view\" data-role=\"server-log-view\">\r\n            <p class=\"muted\">No log entries yet.</p>\r\n          </div>\r\n          <pre class=\"server-diagnostics-output\" data-role=\"server-diagnostics-output\">Run diagnostics to capture database and payload summaries.</pre>\r\n          <div class=\"status-bar compact\" data-role=\"server-console-status\">Server console idle.</div>\r\n        </div>\r\n      </div>\r\n    `;\r\n  }\r\n\r\n  private cacheElements(): void {\r\n    this.formEl = this.root.querySelector<HTMLFormElement>('[data-role=\"settings-form\"]')!;\r\n    this.statusEl = this.root.querySelector<HTMLElement>('[data-role=\"settings-status\"]')!;\r\n    this.serverConsoleEl = this.root.querySelector<HTMLElement>('[data-role=\"server-console\"]')!;\r\n    this.serverStatusPill = this.root.querySelector<HTMLElement>('[data-role=\"server-status-pill\"]')!;\r\n    this.serverMetaEl = this.root.querySelector<HTMLElement>('[data-role=\"server-meta\"]')!;\r\n    this.serverLogView = this.root.querySelector<HTMLElement>('[data-role=\"server-log-view\"]')!;\r\n    this.serverDiagOutputEl = this.root.querySelector<HTMLElement>('[data-role=\"server-diagnostics-output\"]')!;\r\n    this.serverConsoleStatusEl = this.root.querySelector<HTMLElement>('[data-role=\"server-console-status\"]')!;\r\n    this.serverRefreshBtn = this.root.querySelector<HTMLButtonElement>('[data-role=\"refresh-logs\"]') ?? undefined;\r\n    this.serverDiagBtn = this.root.querySelector<HTMLButtonElement>('[data-role=\"run-diagnostics\"]') ?? undefined;\r\n    this.serverFilterInput = this.root.querySelector<HTMLInputElement>('[data-role=\"log-filter\"]') ?? undefined;\r\n    this.serverAutoScrollToggle = this.root.querySelector<HTMLInputElement>('[data-role=\"auto-scroll\"]') ?? undefined;\r\n  }\r\n\r\n  private bindEvents(): void {\r\n    this.formEl.addEventListener(\"submit\", (event) => {\r\n      event.preventDefault();\r\n      this.persist();\r\n    });\r\n    this.bindServerConsoleEvents();\r\n  }\r\n\r\n  private bindServerConsoleEvents(): void {\r\n    if (!this.serverConsoleEl) return;\r\n    this.serverRefreshBtn?.addEventListener(\"click\", () => serverService.refreshLogs());\r\n    this.serverDiagBtn?.addEventListener(\"click\", () => {\r\n      void this.runDiagnostics();\r\n    });\r\n    this.serverFilterInput?.addEventListener(\"input\", () => this.renderServerLogs());\r\n    if (this.serverAutoScrollToggle) {\r\n      this.autoScroll = this.serverAutoScrollToggle.checked;\r\n      this.serverAutoScrollToggle.addEventListener(\"change\", (event) => {\r\n        this.autoScroll = (event.target as HTMLInputElement).checked;\r\n      });\r\n    }\r\n    this.wireServerConsole();\r\n    this.renderServerMeta();\r\n    this.renderServerLogs();\r\n    this.renderDiagnostics();\r\n  }\r\n\r\n  private wireServerConsole(): void {\r\n    if (!this.serverConsoleEl) return;\r\n    if (!serverService.isSupported) {\r\n      this.serverConsoleEl.classList.add(\"is-disabled\");\r\n      this.serverStatusPill.textContent = \"Host unavailable\";\r\n      this.serverRefreshBtn?.setAttribute(\"disabled\", \"true\");\r\n      this.serverDiagBtn?.setAttribute(\"disabled\", \"true\");\r\n      this.setServerConsoleStatus(\"Embedded server unavailable in browser preview.\", \"error\");\r\n      return;\r\n    }\r\n\r\n    this.unsubscribers.forEach((fn) => fn());\r\n    this.unsubscribers.length = 0;\r\n\r\n    this.unsubscribers.push(\r\n      serverService.subscribeToMetadata((metadata) => {\r\n        this.serverMetadata = metadata;\r\n        this.renderServerMeta();\r\n      })\r\n    );\r\n\r\n    this.unsubscribers.push(\r\n      serverService.subscribeToLogs((logs) => {\r\n        this.serverLogs = logs;\r\n        this.renderServerLogs();\r\n        this.setServerConsoleStatus(`Received ${logs.length} log entries.`, \"default\");\r\n      })\r\n    );\r\n\r\n    this.unsubscribers.push(\r\n      serverService.subscribeToDiagnostics((diagnostics) => {\r\n        this.serverDiagnostics = diagnostics;\r\n        this.renderDiagnostics();\r\n      })\r\n    );\r\n\r\n    serverService.refreshLogs();\r\n  }\r\n\r\n  private syncForm(): void {\r\n    (this.formEl.elements.namedItem(\"theme\") as HTMLSelectElement).value = this.settings.theme || \"\";\r\n    (this.formEl.elements.namedItem(\"locale\") as HTMLInputElement).value = this.settings.locale || \"\";\r\n    (this.formEl.elements.namedItem(\"accentColor\") as HTMLInputElement).value =\r\n      typeof this.settings.accentColor === \"string\" && this.settings.accentColor.startsWith(\"#\")\r\n        ? this.settings.accentColor\r\n        : \"#6dd5fa\";\r\n    (this.formEl.elements.namedItem(\"enableExperimental\") as HTMLInputElement).checked =\r\n      Boolean(this.settings.enableExperimental);\r\n  }\r\n\r\n  private persist(): void {\r\n    const payload: AppSettings = {\r\n      theme: (this.formEl.elements.namedItem(\"theme\") as HTMLSelectElement).value || undefined,\r\n      locale: (this.formEl.elements.namedItem(\"locale\") as HTMLInputElement).value || undefined,\r\n      accentColor: (this.formEl.elements.namedItem(\"accentColor\") as HTMLInputElement).value || undefined,\r\n      enableExperimental: (this.formEl.elements.namedItem(\"enableExperimental\") as HTMLInputElement).checked,\r\n    };\r\n    applyTheme(payload);\r\n    settingsService\r\n      .saveSettings(payload)\r\n      .then(() => this.setStatus(\"Settings saved.\", \"success\"))\r\n      .catch((error) => this.setStatus(error instanceof Error ? error.message : String(error), \"error\"));\r\n  }\r\n\r\n  private renderServerMeta(): void {\r\n    if (!this.serverMetaEl) return;\r\n    if (!serverService.isSupported) {\r\n      this.serverMetaEl.innerHTML = `<p class=\"muted\">Server features are unavailable while running in the browser.</p>`;\r\n      return;\r\n    }\r\n\r\n    if (!this.serverMetadata) {\r\n      this.serverMetaEl.innerHTML = `<p class=\"muted\">Awaiting handshake from the desktop host...</p>`;\r\n      this.serverStatusPill.textContent = \"Awaiting host\";\r\n      return;\r\n    }\r\n\r\n    const started = this.serverMetadata.startedAt ? new Date(this.serverMetadata.startedAt).toLocaleString() : \"Unknown\";\r\n    const baseUrl = this.serverMetadata.baseUrl ?? \"n/a\";\r\n    const port = this.serverMetadata.port ?? 0;\r\n    this.serverStatusPill.textContent = `Online - Port ${port}`;\r\n\r\n    this.serverMetaEl.innerHTML = `\r\n      <dl class=\"server-meta-grid\">\r\n        <div><dt>Base URL</dt><dd>${baseUrl}</dd></div>\r\n        <div><dt>Port</dt><dd>${port}</dd></div>\r\n        <div><dt>Started</dt><dd>${started}</dd></div>\r\n      </dl>\r\n      <p class=\"muted\">Auth token protected - bridge events stream live into the console.</p>\r\n    `;\r\n\r\n    this.serverRefreshBtn?.removeAttribute(\"disabled\");\r\n    this.serverDiagBtn?.removeAttribute(\"disabled\");\r\n  }\r\n\r\n  private renderServerLogs(): void {\r\n    if (!this.serverLogView) return;\r\n    if (!this.serverLogs.length) {\r\n      this.serverLogView.innerHTML = `<p class=\"muted\">No log entries yet.</p>`;\r\n      return;\r\n    }\r\n\r\n    const filter = this.serverFilterInput?.value?.trim().toLowerCase();\r\n    const entries = filter\r\n      ? this.serverLogs.filter((entry) =>\r\n        [entry.level, entry.category, entry.message, entry.exception ?? \"\"]\r\n          .filter(Boolean)\r\n          .some((value) => String(value).toLowerCase().includes(filter))\r\n      )\r\n      : this.serverLogs;\r\n\r\n    if (!entries.length) {\r\n      this.serverLogView.innerHTML = `<p class=\"muted\">No log entries match \"${filter}\".</p>`;\r\n      return;\r\n    }\r\n\r\n    this.serverLogView.innerHTML = entries\r\n      .map((entry) => {\r\n        const timestamp = new Date(entry.timestamp).toLocaleTimeString();\r\n        const level = entry.level?.toUpperCase?.() ?? \"INFO\";\r\n        const metaParts = [entry.category, entry.statusCode ? `HTTP ${entry.statusCode}` : undefined, entry.durationMs ? `${entry.durationMs.toFixed(1)} ms` : undefined]\r\n          .filter(Boolean)\r\n          .join(\" | \");\r\n        const exception = entry.exception ? `<div class=\"log-exception\">${entry.exception}</div>` : \"\";\r\n        return `\r\n          <article class=\"log-entry\" data-level=\"${level.toLowerCase()}\">\r\n            <header>\r\n              <span class=\"log-time\">${timestamp}</span>\r\n              <span class=\"log-level\">${level}</span>\r\n              ${metaParts ? `<span class=\"log-meta\">${metaParts}</span>` : \"\"}\r\n            </header>\r\n            <p>${entry.message}</p>\r\n            ${exception}\r\n          </article>\r\n        `;\r\n      })\r\n      .join(\"\");\r\n\r\n    if (this.autoScroll) {\r\n      this.serverLogView.scrollTop = this.serverLogView.scrollHeight;\r\n    }\r\n  }\r\n\r\n  private renderDiagnostics(): void {\r\n    if (!this.serverDiagOutputEl) return;\r\n    if (!this.serverDiagnostics) {\r\n      this.serverDiagOutputEl.textContent = \"Run diagnostics to inspect database + backup metadata.\";\r\n      return;\r\n    }\r\n\r\n    const { backupFiles, ...rest } = this.serverDiagnostics;\r\n    const payload = {\r\n      ...rest,\r\n      backupFiles,\r\n    };\r\n    this.serverDiagOutputEl.textContent = JSON.stringify(payload, null, 2);\r\n  }\r\n\r\n  private async runDiagnostics(): Promise<void> {\r\n    if (!serverService.isSupported) return;\r\n    if (this.serverDiagBtn) {\r\n      this.serverDiagBtn.disabled = true;\r\n      this.serverDiagBtn.textContent = \"Running...\";\r\n    }\r\n\r\n    try {\r\n      const diagnostics = await serverService.fetchDiagnostics();\r\n      this.serverDiagnostics = diagnostics;\r\n      this.renderDiagnostics();\r\n      this.setServerConsoleStatus(\"Diagnostics snapshot captured.\", \"success\");\r\n    } catch (error) {\r\n      const message = error instanceof Error ? error.message : String(error);\r\n      this.serverDiagOutputEl.textContent = `Diagnostics failed: ${message}`;\r\n      this.setServerConsoleStatus(message, \"error\");\r\n    } finally {\r\n      if (this.serverDiagBtn) {\r\n        this.serverDiagBtn.disabled = false;\r\n        this.serverDiagBtn.textContent = \"Run diagnostics\";\r\n      }\r\n    }\r\n  }\r\n\r\n  private setServerConsoleStatus(message: string, tone: \"default\" | \"success\" | \"error\"): void {\r\n    if (!this.serverConsoleStatusEl) return;\r\n    this.serverConsoleStatusEl.textContent = message;\r\n    this.serverConsoleStatusEl.dataset.tone = tone;\r\n  }\r\n\r\n  private setStatus(message: string, tone: \"default\" | \"success\" | \"error\"): void {\r\n    this.statusEl.textContent = message;\r\n    this.statusEl.dataset.tone = tone;\r\n  }\r\n}\r\n","import type { WeaponWorkbench } from \"./weaponWorkbench\";\r\n\r\nexport class TemplatesPanel {\r\n\tprivate root: HTMLElement;\r\n\tprivate workbench?: WeaponWorkbench;\r\n\r\n\tconstructor(root: HTMLElement) {\r\n\t\tthis.root = root;\r\n\t}\r\n\r\n\tasync init(): Promise<void> {\r\n\t\tthis.root.innerHTML = `\r\n\t\t\t<div class=\"panel weapon-panel\">\r\n\t\t\t\t<div class=\"panel-heading\">\r\n\t\t\t\t\t<h3>Weapon Templates</h3>\r\n\t\t\t\t\t<p class=\"muted small\">Manage reusable weapons, ammo, and fire modes</p>\r\n\t\t\t\t</div>\r\n\t\t\t\t<div data-role=\"weapon-workbench\"></div>\r\n\t\t\t</div>\r\n\t\t`;\r\n\t\tconst container = this.root.querySelector<HTMLElement>('[data-role=\"weapon-workbench\"]');\r\n\t\tif (!container) {\r\n\t\t\tthrow new Error(\"Failed to initialize weapon workbench container\");\r\n\t\t}\r\n\t\tcontainer.innerHTML = `<p class=\"muted small\">Loading weapon workbench...</p>`;\r\n\t\tawait this.mountWorkbench(container);\r\n\t}\r\n\r\n\tprivate async mountWorkbench(container: HTMLElement): Promise<void> {\r\n\t\ttry {\r\n\t\t\tconst module = await import(\"./weaponWorkbench\");\r\n\t\t\tthis.workbench = new module.WeaponWorkbench(container);\r\n\t\t\tawait Promise.resolve(this.workbench.init());\r\n\t\t} catch (error) {\r\n\t\t\tcontainer.innerHTML = `<p class=\"muted small\">Failed to load weapon workbench. Check console.</p>`;\r\n\t\t\tconsole.error(\"Failed to load weapon workbench\", error);\r\n\t\t}\r\n\t}\r\n}\r\n\r\n","import { valueOrNA } from \"../lib/helpers\";\r\nimport { serverService } from \"../services/serverService\";\r\nimport type { ServerDiagnostics, ServerLogEntry, ServerMetadata } from \"../types\";\r\n\r\nexport class DiagnosticsPanel {\r\n  private readonly root: HTMLElement;\r\n  private statusEl?: HTMLElement;\r\n  private summaryEl?: HTMLElement;\r\n  private logsEl?: HTMLElement;\r\n  private filesEl?: HTMLElement;\r\n\r\n  constructor(container: HTMLElement) {\r\n    this.root = container;\r\n  }\r\n\r\n  init(): void {\r\n    this.root.innerHTML = `\r\n      <div class=\"diagnostics-panel\">\r\n        <div class=\"panel-header\">\r\n          <div>\r\n            <p class=\"eyebrow\">Runtime Diagnostics</p>\r\n            <h2>Host Health Monitor</h2>\r\n            <p class=\"muted\">Inspect WebView host, local API server, and storage consistency.</p>\r\n          </div>\r\n          <div class=\"header-actions\">\r\n            <button type=\"button\" class=\"ghost\" data-role=\"refresh-logs\">Refresh logs</button>\r\n            <button type=\"button\" class=\"primary\" data-role=\"refresh-diagnostics\">Refresh diagnostics</button>\r\n          </div>\r\n        </div>\r\n        <div class=\"diagnostics-grid\">\r\n          <section class=\"diagnostic-card\">\r\n            <header>\r\n              <span class=\"label\">Server status</span>\r\n              <span class=\"badge\" data-role=\"status-indicator\">Pending...</span>\r\n            </header>\r\n            <dl data-role=\"metadata\"></dl>\r\n          </section>\r\n          <section class=\"diagnostic-card\" data-role=\"summary\">\r\n            <header>\r\n              <span class=\"label\">Database snapshot</span>\r\n            </header>\r\n            <div class=\"grid-2\" data-role=\"summary-body\"></div>\r\n          </section>\r\n        </div>\r\n        <section class=\"diagnostic-card\">\r\n          <header>\r\n            <span class=\"label\">JSON backups</span>\r\n          </header>\r\n          <div class=\"file-grid\" data-role=\"files\"></div>\r\n        </section>\r\n        <section class=\"diagnostic-card\">\r\n          <header>\r\n            <span class=\"label\">Server log tail</span>\r\n          </header>\r\n          <div class=\"log-table\" data-role=\"logs\"></div>\r\n        </section>\r\n      </div>\r\n    `;\r\n\r\n    this.statusEl = this.root.querySelector<HTMLElement>(\"[data-role='status-indicator']\") ?? undefined;\r\n    this.summaryEl = this.root.querySelector<HTMLElement>(\"[data-role='summary-body']\") ?? undefined;\r\n    this.logsEl = this.root.querySelector<HTMLElement>(\"[data-role='logs']\") ?? undefined;\r\n    this.filesEl = this.root.querySelector<HTMLElement>(\"[data-role='files']\") ?? undefined;\r\n\r\n    this.root.querySelector<HTMLButtonElement>(\"[data-role='refresh-diagnostics']\")?.addEventListener(\"click\", () => {\r\n      this.setStatus(\"Refreshing...\");\r\n      serverService\r\n        .fetchDiagnostics()\r\n        .then(() => this.setStatus(\"Healthy\"))\r\n        .catch((error) => {\r\n          console.error(\"Failed to refresh diagnostics\", error);\r\n          this.setStatus(\"Error\");\r\n        });\r\n    });\r\n\r\n    this.root.querySelector<HTMLButtonElement>(\"[data-role='refresh-logs']\")?.addEventListener(\"click\", () => {\r\n      serverService.refreshLogs();\r\n    });\r\n\r\n    serverService.subscribeToMetadata((metadata) => this.renderMetadata(metadata));\r\n    serverService.subscribeToDiagnostics((diagnostics) => this.renderDiagnostics(diagnostics));\r\n    serverService.subscribeToLogs((entries) => this.renderLogs(entries));\r\n\r\n    if (serverService.isSupported) {\r\n      serverService.fetchDiagnostics().catch(() => undefined);\r\n    } else {\r\n      this.setStatus(\"Unavailable\");\r\n    }\r\n  }\r\n\r\n  private setStatus(text: string): void {\r\n    if (this.statusEl) {\r\n      this.statusEl.textContent = text;\r\n    }\r\n  }\r\n\r\n  private renderMetadata(metadata?: ServerMetadata): void {\r\n    const target = this.root.querySelector<HTMLElement>(\"[data-role='metadata']\");\r\n    if (!target) return;\r\n\r\n    target.innerHTML = \"\";\r\n    if (!metadata) {\r\n      const empty = document.createElement(\"p\");\r\n      empty.className = \"muted\";\r\n      empty.textContent = \"Waiting for host handshake...\";\r\n      target.appendChild(empty);\r\n      this.setStatus(\"Pending\");\r\n      return;\r\n    }\r\n\r\n    const entries: Array<[string, string | number | undefined]> = [\r\n      [\"Base URL\", metadata.baseUrl],\r\n      [\"Port\", metadata.port],\r\n      [\"Started\", metadata.startedAt],\r\n      [\"Token\", metadata.token?.slice(0, 6) ? `${metadata.token.slice(0, 6)}` : undefined],\r\n    ];\r\n\r\n    entries.forEach(([label, value]) => {\r\n      const row = document.createElement(\"div\");\r\n      row.className = \"meta-row\";\r\n      row.innerHTML = `<span>${label}</span><strong>${valueOrNA(value)}</strong>`;\r\n      target.appendChild(row);\r\n    });\r\n\r\n    this.setStatus(\"Connected\");\r\n  }\r\n\r\n  private renderDiagnostics(diagnostics?: ServerDiagnostics): void {\r\n    if (!this.summaryEl || !diagnostics) {\r\n      if (this.summaryEl) this.summaryEl.innerHTML = \"<p class='muted'>No diagnostics yet.</p>\";\r\n      if (this.filesEl) this.filesEl.innerHTML = \"\";\r\n      return;\r\n    }\r\n\r\n    const rows = [\r\n      { label: \"Database\", value: diagnostics.databasePath },\r\n      { label: \"Schema\", value: diagnostics.schemaPath },\r\n      { label: \"JSON root\", value: diagnostics.jsonBackupDirectory },\r\n      { label: \"App state\", value: diagnostics.appStateUpdatedAtUtc ?? \"Unknown\" },\r\n      { label: \"DB Size\", value: diagnostics.databaseSizeBytes ? `${diagnostics.databaseSizeBytes.toLocaleString()} bytes` : \"Unknown\" },\r\n      { label: \"Pending logs\", value: String(diagnostics.pendingLogEntries ?? 0) },\r\n    ];\r\n\r\n    this.summaryEl.innerHTML = rows\r\n      .map((row) => `<div><span class=\"label\">${row.label}</span><strong>${valueOrNA(row.value)}</strong></div>`)\r\n      .join(\"\");\r\n\r\n    if (this.filesEl) {\r\n      this.filesEl.innerHTML = diagnostics.backupFiles\r\n        .map((file) => {\r\n          const status = file.exists ? \"ok\" : \"miss\";\r\n          const size = file.sizeBytes ? `${file.sizeBytes.toLocaleString()} B` : \"--\";\r\n          const timestamp = file.lastWriteTimeUtc ?? \"--\";\r\n          return `\r\n            <article class=\"file-card ${status}\">\r\n              <header>\r\n                <span>${file.name}</span>\r\n                <span class=\"tag\">${file.exists ? \"Present\" : \"Missing\"}</span>\r\n              </header>\r\n              <p class=\"path\">${file.path}</p>\r\n              <footer>\r\n                <span>${size}</span>\r\n                <span>${timestamp}</span>\r\n              </footer>\r\n            </article>\r\n          `;\r\n        })\r\n        .join(\"\");\r\n    }\r\n  }\r\n\r\n  private renderLogs(entries: ServerLogEntry[]): void {\r\n    if (!this.logsEl) return;\r\n    if (!entries.length) {\r\n      this.logsEl.innerHTML = \"<p class='muted'>No recent log entries.</p>\";\r\n      return;\r\n    }\r\n\r\n    const latest = entries.slice(-50).reverse();\r\n    this.logsEl.innerHTML = latest\r\n      .map((entry) => {\r\n        const status = entry.level?.toLowerCase() ?? \"info\";\r\n        return `\r\n          <article class=\"log-row ${status}\">\r\n            <div>\r\n              <span class=\"timestamp\">${entry.timestamp}</span>\r\n              <strong>${entry.category ?? \"server\"}</strong>\r\n              <span>${entry.level}</span>\r\n            </div>\r\n            <p>${entry.message}</p>\r\n          </article>\r\n        `;\r\n      })\r\n      .join(\"\");\r\n  }\r\n}\r\n","import \"./styles/.generated/main.css\";\r\nimport { hostBridge } from \"./lib/hostBridge\";\r\nimport { UnitEditor } from \"./modules/unitEditor\";\r\nimport { FormationsPanel } from \"./modules/formationsPanel\";\r\nimport { NationsPanel } from \"./modules/nationsPanel\";\r\nimport { SettingsPanel } from \"./modules/settingsPanel\";\r\nimport { TemplatesPanel } from \"./modules/templatesPanel\";\r\nimport { DiagnosticsPanel } from \"./modules/diagnosticsPanel\";\r\nimport { unitService } from \"./services/unitService\";\r\nimport { formationService } from \"./services/formationService\";\r\nimport { nationService } from \"./services/nationService\";\r\nimport { settingsService } from \"./services/settingsService\";\r\nimport { serverService } from \"./services/serverService\";\r\nimport { applyTheme } from \"./lib/theme\";\r\n\r\ntype PanelController = {\r\n  init: () => void | Promise<void>;\r\n};\r\n\r\ntype PanelDefinition = {\r\n  key: string;\r\n  label: string;\r\n  description: string;\r\n  group: \"Editors\" | \"Insights\" | \"Settings\";\r\n  factory: (container: HTMLElement) => PanelController | Promise<PanelController>;\r\n};\r\n\r\ntype PanelInstance = {\r\n  node: HTMLElement;\r\n  controller?: PanelController;\r\n  initialized: boolean;\r\n  loading?: Promise<void>;\r\n};\r\n\r\nconst panels: PanelDefinition[] = [\r\n  {\r\n    key: \"nations\",\r\n    label: \"Nations\",\r\n    description: \"Assign formations to nations\",\r\n    group: \"Editors\",\r\n    factory: (container) => new NationsPanel(container),\r\n  },\r\n  {\r\n    key: \"formations\",\r\n    label: \"Formations\",\r\n    description: \"Structure categories per formation\",\r\n    group: \"Editors\",\r\n    factory: (container) => new FormationsPanel(container),\r\n  },\r\n  {\r\n    key: \"units\",\r\n    label: \"Units\",\r\n    description: \"Edit and score tactical units\",\r\n    group: \"Editors\",\r\n    factory: (container) => new UnitEditor(container),\r\n  },\r\n  {\r\n    key: \"templates\",\r\n    label: \"Templates\",\r\n    description: \"Manage weapon & ammo presets\",\r\n    group: \"Editors\",\r\n    factory: (container) => new TemplatesPanel(container),\r\n  },\r\n  {\r\n    key: \"insights\",\r\n    label: \"Insights\",\r\n    description: \"Force readiness overview\",\r\n    group: \"Insights\",\r\n    factory: (container) => import(\"./modules/statsPanel\").then(({ StatsPanel }) => new StatsPanel(container)),\r\n  },\r\n  {\r\n    key: \"diagnostics\",\r\n    label: \"Diagnostics\",\r\n    description: \"Local host status\",\r\n    group: \"Insights\",\r\n    factory: (container) => new DiagnosticsPanel(container),\r\n  },\r\n  {\r\n    key: \"settings\",\r\n    label: \"Settings\",\r\n    description: \"Application preferences\",\r\n    group: \"Settings\",\r\n    factory: (container) => new SettingsPanel(container),\r\n  },\r\n];\r\n\r\nconst root = document.querySelector<HTMLDivElement>(\"#app\");\r\n\r\nif (root) {\r\n  root.innerHTML = `\r\n    <div class=\"app-layout\">\r\n      <aside class=\"primary-nav\">\r\n        <div class=\"brand\">\r\n          <span class=\"eyebrow\">Operations Toolbar</span>\r\n          <h1>Philly's RTS Toolkit</h1>\r\n        </div>\r\n        <nav class=\"nav-sections\" data-role=\"nav-container\"></nav>\r\n      </aside>\r\n      <main class=\"view-host\" data-role=\"view-host\"></main>\r\n    </div>\r\n  `;\r\n\r\n  const navContainer = root.querySelector<HTMLElement>('[data-role=\"nav-container\"]')!;\r\n  const host = root.querySelector<HTMLElement>('[data-role=\"view-host\"]')!;\r\n  const panelRegistry = new Map<string, PanelDefinition>();\r\n  const panelInstances = new Map<string, PanelInstance>();\r\n  const navBadges = new Map<string, HTMLElement>();\r\n  const navButtons = new Map<string, HTMLButtonElement>();\r\n  const groupLists = new Map<string, HTMLElement>();\r\n\r\n  const setPanelPlaceholder = (node: HTMLElement, message: string) => {\r\n    node.innerHTML = `<div class=\"panel-placeholder\"><p class=\"muted small\">${message}</p></div>`;\r\n  };\r\n\r\n  panels.forEach((panel) => {\r\n    panelRegistry.set(panel.key, panel);\r\n    let list = groupLists.get(panel.group);\r\n    if (!list) {\r\n      const section = document.createElement(\"div\");\r\n      section.className = \"nav-section\";\r\n      const label = document.createElement(\"p\");\r\n      label.className = \"section-label\";\r\n      label.textContent = panel.group;\r\n      list = document.createElement(\"div\");\r\n      list.className = \"nav-list\";\r\n      section.append(label, list);\r\n      navContainer.appendChild(section);\r\n      groupLists.set(panel.group, list);\r\n    }\r\n    const button = document.createElement(\"button\");\r\n    button.type = \"button\";\r\n    button.className = \"nav-chip\";\r\n    button.dataset.panel = panel.key;\r\n    button.innerHTML = `\r\n      <div class=\"nav-chip-head\">\r\n        <span class=\"label\">${panel.label}</span>\r\n        <span class=\"badge\" data-panel-count=\"${panel.key}\">--</span>\r\n      </div>\r\n      <span class=\"meta\">${panel.description}</span>\r\n    `;\r\n    list!.appendChild(button);\r\n    navButtons.set(panel.key, button);\r\n    const badge = button.querySelector<HTMLElement>(`[data-panel-count=\"${panel.key}\"]`);\r\n    if (badge) navBadges.set(panel.key, badge);\r\n\r\n    const section = document.createElement(\"section\");\r\n    section.className = \"view-panel\";\r\n    section.dataset.panel = panel.key;\r\n    section.hidden = true;\r\n    host.appendChild(section);\r\n\r\n    panelInstances.set(panel.key, { node: section, initialized: false });\r\n  });\r\n\r\n  const ensurePanelInitialized = async (panelKey: string) => {\r\n    const instance = panelInstances.get(panelKey);\r\n    const definition = panelRegistry.get(panelKey);\r\n    if (!instance || !definition) return;\r\n    if (instance.initialized) return;\r\n    if (instance.loading) return instance.loading;\r\n\r\n    setPanelPlaceholder(instance.node, \"Loading module...\");\r\n\r\n    const loadPromise = Promise.resolve()\r\n      .then(() => definition.factory(instance.node))\r\n      .then((controller) => {\r\n        instance.controller = controller;\r\n        return controller.init();\r\n      })\r\n      .then(() => {\r\n        instance.initialized = true;\r\n      })\r\n      .catch((error) => {\r\n        console.error(`Failed to init ${definition.key}`, error);\r\n        setPanelPlaceholder(instance.node, \"Failed to load panel. Check console for details.\");\r\n      })\r\n      .finally(() => {\r\n        instance.loading = undefined;\r\n      });\r\n\r\n    instance.loading = loadPromise;\r\n    return loadPromise;\r\n  };\r\n\r\n  const activatePanel = (panelKey: string | undefined) => {\r\n    if (!panelKey) return;\r\n    navButtons.forEach((button, key) => {\r\n      const isActive = key === panelKey;\r\n      button.classList.toggle(\"active\", isActive);\r\n    });\r\n    panelInstances.forEach((instance, key) => {\r\n      const isActive = key === panelKey;\r\n      instance.node.classList.toggle(\"active\", isActive);\r\n      instance.node.hidden = !isActive;\r\n    });\r\n    ensurePanelInitialized(panelKey).catch(() => undefined);\r\n  };\r\n\r\n  navContainer.addEventListener(\"click\", (event) => {\r\n    const button = (event.target as HTMLElement).closest<HTMLButtonElement>(\".nav-chip\");\r\n    if (!button) return;\r\n    const panelKey = button.dataset.panel;\r\n    if (!panelKey) return;\r\n    activatePanel(panelKey);\r\n  });\r\n\r\n  activatePanel(panels[0]?.key);\r\n\r\n  const updateBadge = (key: string, value: string) => {\r\n    const el = navBadges.get(key);\r\n    if (el) el.textContent = value;\r\n  };\r\n\r\n  unitService.subscribe((units) => updateBadge(\"units\", `${units.length} units`));\r\n  formationService.subscribe((formations) => updateBadge(\"formations\", `${formations.length} groups`));\r\n  nationService.subscribe((nations) => updateBadge(\"nations\", `${nations.length} nations`));\r\n  settingsService.subscribe((settings) => {\r\n    updateBadge(\"settings\", settings.theme ? settings.theme : \"System\");\r\n    applyTheme(settings);\r\n  });\r\n  updateBadge(\"insights\", \"Live metrics\");\r\n  updateBadge(\"diagnostics\", serverService.isSupported ? \"Host monitor\" : \"Unavailable\");\r\n\r\n  unitService.loadUnits().catch(() => undefined);\r\n  formationService.loadFormations().catch(() => undefined);\r\n  nationService.loadNations().catch(() => undefined);\r\n  settingsService.loadSettings().catch(() => undefined);\r\n}\r\n\r\nif (hostBridge.isAvailable) {\r\n  hostBridge.postMessage(\"host-info-request\");\r\n  hostBridge.waitFor<{ version?: string; mode?: string }>(\"host-info\", 2000).then((info) => {\r\n    console.info(\"[Host]\", info);\r\n  });\r\n}\r\n\r\nserverService.init();\r\n"],"file":"assets/index-CSKnxx71.js"}