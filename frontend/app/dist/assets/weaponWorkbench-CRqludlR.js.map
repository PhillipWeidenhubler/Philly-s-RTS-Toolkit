{"version":3,"file":"weaponWorkbench-CRqludlR.js","sources":["../../src/modules/weaponWorkbench.ts"],"sourcesContent":["import type { AmmoTemplate, FireModeTemplate, WeaponTagMap, WeaponTemplate } from \"../types\";\r\nimport { deepClone } from \"../lib/helpers\";\r\nimport { weaponLibraryService } from \"../services/weaponLibraryService\";\r\nimport { ammoLibraryService } from \"../services/ammoLibraryService\";\r\nimport { weaponTagService } from \"../services/weaponTagService\";\r\nimport { fireModeTemplateService } from \"../services/fireModeTemplateService\";\r\nimport { TRAJECTORY_OPTIONS, WEAPON_TRAIT_GROUPS } from \"../config/weaponOptions\";\r\n\r\nconst createWeaponTemplate = (): WeaponTemplate => ({\r\n  name: \"Untitled Weapon\",\r\n  category: \"\",\r\n  caliber: \"\",\r\n  range: \"\",\r\n  muzzleVelocity: \"\",\r\n  dispersion: \"\",\r\n  barrelLength: \"\",\r\n  reloadSpeed: \"\",\r\n  targetAcquisition: \"\",\r\n  ammoTypes: [],\r\n  fireModes: [],\r\n  trajectories: [],\r\n  traits: [],\r\n  notes: \"\",\r\n});\r\n\r\nconst createAmmoTemplate = (): AmmoTemplate => ({\r\n  name: \"New Template\",\r\n  caliber: \"\",\r\n  caliberDesc: \"\",\r\n  ammoType: \"\",\r\n  penetration: \"\",\r\n  heDeadliness: \"\",\r\n  dispersion: \"\",\r\n  rangeMod: \"\",\r\n  grain: \"\",\r\n  notes: \"\",\r\n  airburst: false,\r\n  subCount: \"\",\r\n  subDamage: \"\",\r\n  subPenetration: \"\",\r\n  fps: \"\",\r\n});\r\n\r\nconst createFireTemplate = (): FireModeTemplate => ({\r\n  name: \"New Mode\",\r\n  rounds: \"\",\r\n  minRange: \"\",\r\n  maxRange: \"\",\r\n  cooldown: \"\",\r\n  ammoRef: \"\",\r\n  notes: \"\",\r\n});\r\n\r\ntype TagScope = \"categories\" | \"calibers\";\r\ntype TagEntry = { id: string; name: string; color: string };\r\ntype WeaponAmmoEntry = NonNullable<WeaponTemplate[\"ammoTypes\"]>[number];\r\ntype WeaponFireModeEntry = NonNullable<WeaponTemplate[\"fireModes\"]>[number];\r\n\r\nexport class WeaponWorkbench {\r\n  private root: HTMLElement;\r\n  private weapons: WeaponTemplate[] = [];\r\n  private ammo: AmmoTemplate[] = [];\r\n  private fireTemplates: FireModeTemplate[] = [];\r\n  private tags: WeaponTagMap = { categories: {}, calibers: {} };\r\n  private tagDraft: Record<TagScope, TagEntry[]> = { categories: [], calibers: [] };\r\n\r\n  private selectedWeapon = 0;\r\n  private selectedAmmo = 0;\r\n  private selectedFire = 0;\r\n  private weaponSearchTerm = \"\";\r\n  private ammoSearchTerm = \"\";\r\n  private fireSearchTerm = \"\";\r\n\r\n  private weaponListEl!: HTMLElement;\r\n  private weaponFormEl!: HTMLFormElement;\r\n  private weaponStatusEl!: HTMLElement;\r\n  private weaponSearchInput!: HTMLInputElement;\r\n\r\n  private ammoListEl!: HTMLElement;\r\n  private ammoFormEl!: HTMLFormElement;\r\n  private ammoStatusEl!: HTMLElement;\r\n  private ammoSearchInput!: HTMLInputElement;\r\n\r\n  private fireListEl!: HTMLElement;\r\n  private fireFormEl!: HTMLFormElement;\r\n  private fireStatusEl!: HTMLElement;\r\n  private fireSearchInput!: HTMLInputElement;\r\n\r\n  private categoryTagListEl!: HTMLElement;\r\n  private caliberTagListEl!: HTMLElement;\r\n  private tagStatusEl!: HTMLElement;\r\n\r\n  private weaponAmmoListEl!: HTMLElement;\r\n  private weaponFireListEl!: HTMLElement;\r\n  private weaponAmmoImportSelect!: HTMLSelectElement;\r\n  private weaponFireImportSelect!: HTMLSelectElement;\r\n  private weaponTrajectoryWrapEl!: HTMLElement;\r\n  private weaponTraitWrapEl!: HTMLElement;\r\n  private weaponCategoryTagListEl!: HTMLDataListElement;\r\n  private weaponCaliberTagListEl!: HTMLDataListElement;\r\n  private weaponAmmoBallisticUpdaters: Array<() => void> = [];\r\n\r\n  constructor(root: HTMLElement) {\r\n    this.root = root;\r\n  }\r\n\r\n  init(): void {\r\n    this.renderLayout();\r\n    this.cacheElements();\r\n    this.bindEvents();\r\n\r\n    weaponLibraryService.subscribe((weapons) => {\r\n      this.weapons = deepClone(weapons);\r\n      if (!this.weapons.length) {\r\n        this.weapons = [createWeaponTemplate()];\r\n      }\r\n      if (this.selectedWeapon >= this.weapons.length) {\r\n        this.selectedWeapon = Math.max(0, this.weapons.length - 1);\r\n      }\r\n      this.renderWeaponList();\r\n      this.populateWeaponForm();\r\n    });\r\n\r\n    ammoLibraryService.subscribe((templates) => {\r\n      this.ammo = deepClone(templates);\r\n      if (!this.ammo.length) {\r\n        this.ammo = [createAmmoTemplate()];\r\n      }\r\n      if (this.selectedAmmo >= this.ammo.length) {\r\n        this.selectedAmmo = Math.max(0, this.ammo.length - 1);\r\n      }\r\n      this.renderAmmoList();\r\n      this.populateAmmoForm();\r\n      this.populateWeaponAmmoImport();\r\n    });\r\n\r\n    weaponTagService.subscribe((tags) => {\r\n      this.tags = tags;\r\n      this.tagDraft = {\r\n        categories: this.mapToEntries(tags.categories),\r\n        calibers: this.mapToEntries(tags.calibers),\r\n      };\r\n      this.renderTagLists();\r\n      this.renderWeaponTagSuggestions();\r\n    });\r\n\r\n    fireModeTemplateService.subscribe((templates) => {\r\n      this.fireTemplates = deepClone(templates);\r\n      if (!this.fireTemplates.length) {\r\n        this.fireTemplates = [createFireTemplate()];\r\n      }\r\n      if (this.selectedFire >= this.fireTemplates.length) {\r\n        this.selectedFire = Math.max(0, this.fireTemplates.length - 1);\r\n      }\r\n      this.renderFireList();\r\n      this.populateFireForm();\r\n      this.populateWeaponFireImport();\r\n    });\r\n\r\n    weaponLibraryService.loadWeapons().catch((error) => {\r\n      this.setWeaponStatus(error instanceof Error ? error.message : String(error), \"error\");\r\n    });\r\n    ammoLibraryService.loadTemplates().catch((error) => {\r\n      this.setAmmoStatus(error instanceof Error ? error.message : String(error), \"error\");\r\n    });\r\n    fireModeTemplateService.loadTemplates().catch((error) => {\r\n      this.setFireStatus(error instanceof Error ? error.message : String(error), \"error\");\r\n    });\r\n    weaponTagService.loadTags().catch((error) => {\r\n      this.setTagStatus(error instanceof Error ? error.message : String(error), \"error\");\r\n    });\r\n  }\r\n\r\n  private renderLayout(): void {\r\n    this.root.innerHTML = `\r\n      <div class=\"weapon-workbench\">\r\n        <section class=\"panel collapsible collapsed\" data-panel=\"weapon-panel\" id=\"weapon-panel\">\r\n          <div class=\"panel-heading\">\r\n            <h3>Weapon Library</h3>\r\n            <div class=\"header-actions\">\r\n              <button type=\"button\" class=\"ghost small\" data-action=\"toggle-panel\" data-panel-target=\"weapon-panel\">Expand</button>\r\n              <button type=\"button\" class=\"ghost\" data-action=\"weapon-new\">+ Weapon</button>\r\n              <button type=\"button\" class=\"primary\" data-action=\"weapon-save-all\">Save weapons</button>\r\n            </div>\r\n          </div>\r\n          <div class=\"split-layout panel-collapse-target\">\r\n            <div class=\"list-pane\">\r\n              <div class=\"list-actions\">\r\n                <input type=\"search\" placeholder=\"Search weapons\" data-role=\"weapon-search\" />\r\n              </div>\r\n              <div class=\"list-scroll\" data-role=\"weapon-list\"></div>\r\n            </div>\r\n            <form class=\"detail-pane weapon-form\" data-role=\"weapon-form\">\r\n              <datalist id=\"weapon-category-tags\" data-role=\"weapon-category-tags\"></datalist>\r\n              <datalist id=\"weapon-caliber-tags\" data-role=\"weapon-caliber-tags\"></datalist>\r\n              <div class=\"grid-3\">\r\n                <div class=\"field\">\r\n                  <label>Name</label>\r\n                  <input name=\"weapon-name\" required />\r\n                </div>\r\n                <div class=\"field\">\r\n                  <label>Category</label>\r\n                  <input name=\"weapon-category\" list=\"weapon-category-tags\" />\r\n                </div>\r\n                <div class=\"field\">\r\n                  <label>Caliber</label>\r\n                  <input name=\"weapon-caliber\" list=\"weapon-caliber-tags\" />\r\n                </div>\r\n              </div>\r\n              <div class=\"grid-3\">\r\n                <div class=\"field\">\r\n                  <label>Range</label>\r\n                  <input name=\"weapon-range\" />\r\n                </div>\r\n                <div class=\"field\">\r\n                  <label>Muzzle velocity</label>\r\n                  <input name=\"weapon-mv\" />\r\n                </div>\r\n                <div class=\"field\">\r\n                  <label>Dispersion</label>\r\n                  <input name=\"weapon-dispersion\" />\r\n                </div>\r\n              </div>\r\n              <div class=\"grid-3\">\r\n                <div class=\"field\">\r\n                  <label>Barrel length</label>\r\n                  <input name=\"weapon-barrel\" />\r\n                </div>\r\n                <div class=\"field\">\r\n                  <label>Reload speed</label>\r\n                  <input name=\"weapon-reload\" />\r\n                </div>\r\n                <div class=\"field\">\r\n                  <label>Target acquisition</label>\r\n                  <input name=\"weapon-acquisition\" />\r\n                </div>\r\n              </div>\r\n              <div class=\"chip-field-row\">\r\n                <div class=\"chip-field\">\r\n                  <span class=\"label\">Firing trajectories</span>\r\n                  <div class=\"chip-wrap\" data-role=\"weapon-trajectories\"></div>\r\n                </div>\r\n                <div class=\"chip-field\">\r\n                  <span class=\"label\">Weapon traits</span>\r\n                  <div class=\"chip-wrap trait-wrap\" data-role=\"weapon-traits\"></div>\r\n                </div>\r\n              </div>\r\n              <div class=\"field\">\r\n                <label>Notes</label>\r\n                <textarea name=\"weapon-notes\" rows=\"3\"></textarea>\r\n              </div>\r\n              <div class=\"subpanel collapsed\" data-subpanel=\"weapon-ammo\">\r\n                <div class=\"subpanel-heading\">\r\n                  <strong>Ammo types</strong>\r\n                  <div class=\"header-actions compact\">\r\n                    <select data-role=\"weapon-ammo-import\" class=\"ghost small\">\r\n                      <option value=\"\">From templates...</option>\r\n                    </select>\r\n                    <button type=\"button\" class=\"ghost small\" data-action=\"weapon-ammo-add\">Add ammo</button>\r\n                    <button type=\"button\" class=\"ghost small\" data-action=\"weapon-ammo-collapse\">Expand</button>\r\n                  </div>\r\n                </div>\r\n                <div class=\"subpanel-body\">\r\n                  <div class=\"subpanel-list\" data-role=\"weapon-ammo-list\"></div>\r\n                </div>\r\n              </div>\r\n              <div class=\"subpanel collapsed\" data-subpanel=\"weapon-fire\">\r\n                <div class=\"subpanel-heading\">\r\n                  <strong>Fire modes</strong>\r\n                  <div class=\"header-actions compact\">\r\n                    <select data-role=\"weapon-fire-import\" class=\"ghost small\">\r\n                      <option value=\"\">From templates...</option>\r\n                    </select>\r\n                    <button type=\"button\" class=\"ghost small\" data-action=\"weapon-fire-add\">Add fire mode</button>\r\n                    <button type=\"button\" class=\"ghost small\" data-action=\"weapon-fire-collapse\">Expand</button>\r\n                  </div>\r\n                </div>\r\n                <div class=\"subpanel-body\">\r\n                  <div class=\"subpanel-list\" data-role=\"weapon-fire-list\"></div>\r\n                </div>\r\n              </div>\r\n              <div class=\"form-actions\">\r\n                <button type=\"button\" class=\"ghost danger\" data-action=\"weapon-delete\">Delete</button>\r\n                <button type=\"submit\" class=\"primary\">Apply changes</button>\r\n              </div>\r\n            </form>\r\n          </div>\r\n          <div class=\"status-bar panel-collapse-target\" data-role=\"weapon-status\">Load weapon data to begin.</div>\r\n        </section>\r\n\r\n        <section class=\"panel collapsible collapsed\" data-panel=\"ammo-panel\" id=\"ammo-panel\">\r\n          <div class=\"panel-heading\">\r\n            <h3>Ammo Templates</h3>\r\n            <div class=\"header-actions\">\r\n              <button type=\"button\" class=\"ghost small\" data-action=\"toggle-panel\" data-panel-target=\"ammo-panel\">Expand</button>\r\n              <button type=\"button\" class=\"ghost\" data-action=\"ammo-new\">+ Template</button>\r\n              <button type=\"button\" class=\"primary\" data-action=\"ammo-save-all\">Save ammo</button>\r\n            </div>\r\n          </div>\r\n          <div class=\"split-layout panel-collapse-target\">\r\n            <div class=\"list-pane\">\r\n              <div class=\"list-actions\">\r\n                <input type=\"search\" placeholder=\"Search ammo\" data-role=\"ammo-search\" />\r\n              </div>\r\n              <div class=\"list-scroll\" data-role=\"ammo-list\"></div>\r\n            </div>\r\n            <form class=\"detail-pane\" data-role=\"ammo-form\">\r\n              <div class=\"grid-3\">\r\n                <div class=\"field\">\r\n                  <label>Name</label>\r\n                  <input name=\"ammo-name\" required />\r\n                </div>\r\n                <div class=\"field\">\r\n                  <label>Caliber</label>\r\n                  <input name=\"ammo-caliber\" required />\r\n                </div>\r\n                <div class=\"field\">\r\n                  <label>Caliber desc</label>\r\n                  <input name=\"ammo-caliber-desc\" />\r\n                </div>\r\n              </div>\r\n              <div class=\"grid-3\">\r\n                <div class=\"field\">\r\n                  <label>Type</label>\r\n                  <input name=\"ammo-type\" />\r\n                </div>\r\n                <div class=\"field\">\r\n                  <label>Penetration</label>\r\n                  <input name=\"ammo-pen\" />\r\n                </div>\r\n              </div>\r\n              <div class=\"grid-3\">\r\n                <div class=\"field\">\r\n                  <label>HE deadliness</label>\r\n                  <input name=\"ammo-he\" />\r\n                </div>\r\n                <div class=\"field\">\r\n                  <label>Dispersion</label>\r\n                  <input name=\"ammo-dispersion\" />\r\n                </div>\r\n                <div class=\"field\">\r\n                  <label>Range modifier</label>\r\n                  <input name=\"ammo-range-mod\" />\r\n                </div>\r\n              </div>\r\n              <div class=\"grid-3\">\r\n                <div class=\"field\">\r\n                  <label>Grain</label>\r\n                  <input name=\"ammo-grain\" />\r\n                </div>\r\n                <div class=\"field\">\r\n                  <label>FPS</label>\r\n                  <input name=\"ammo-fps\" />\r\n                </div>\r\n                <div class=\"field toggle-field\">\r\n                  <label>Airburst</label>\r\n                  <label class=\"toggle-pill\">\r\n                    <input type=\"checkbox\" name=\"ammo-airburst\" />\r\n                    <span class=\"toggle-track\"></span>\r\n                    <span class=\"toggle-label\">Enabled</span>\r\n                  </label>\r\n                </div>\r\n              </div>\r\n              <div class=\"grid-3\">\r\n                <div class=\"field\">\r\n                  <label>Sub munition count</label>\r\n                  <input name=\"ammo-sub-count\" />\r\n                </div>\r\n                <div class=\"field\">\r\n                  <label>Sub munition damage</label>\r\n                  <input name=\"ammo-sub-damage\" />\r\n                </div>\r\n                <div class=\"field\">\r\n                  <label>Sub munition penetration</label>\r\n                  <input name=\"ammo-sub-pen\" />\r\n                </div>\r\n              </div>\r\n              <div class=\"field\">\r\n                <label>Notes</label>\r\n                <textarea name=\"ammo-notes\" rows=\"3\"></textarea>\r\n              </div>\r\n              <div class=\"form-actions\">\r\n                <button type=\"button\" class=\"ghost danger\" data-action=\"ammo-delete\">Delete</button>\r\n                <button type=\"submit\" class=\"primary\">Apply changes</button>\r\n              </div>\r\n            </form>\r\n          </div>\r\n          <div class=\"status-bar panel-collapse-target\" data-role=\"ammo-status\">Synchronize ammo templates to edit.</div>\r\n        </section>\r\n\r\n        <section class=\"panel collapsible collapsed\" data-panel=\"fire-panel\" id=\"fire-panel\">\r\n          <div class=\"panel-heading\">\r\n            <h3>Fire Mode Templates</h3>\r\n            <div class=\"header-actions\">\r\n              <button type=\"button\" class=\"ghost small\" data-action=\"toggle-panel\" data-panel-target=\"fire-panel\">Expand</button>\r\n              <button type=\"button\" class=\"ghost\" data-action=\"fire-new\">+ Mode</button>\r\n              <button type=\"button\" class=\"primary\" data-action=\"fire-save-all\">Save modes</button>\r\n            </div>\r\n          </div>\r\n          <div class=\"split-layout panel-collapse-target\">\r\n            <div class=\"list-pane\">\r\n              <div class=\"list-actions\">\r\n                <input type=\"search\" placeholder=\"Search fire modes\" data-role=\"fire-search\" />\r\n              </div>\r\n              <div class=\"list-scroll\" data-role=\"fire-list\"></div>\r\n            </div>\r\n            <form class=\"detail-pane\" data-role=\"fire-form\">\r\n              <div class=\"grid-3\">\r\n                <div class=\"field\">\r\n                  <label>Name</label>\r\n                  <input name=\"fire-name\" required />\r\n                </div>\r\n                <div class=\"field\">\r\n                  <label>Rounds per burst</label>\r\n                  <input name=\"fire-rounds\" type=\"number\" min=\"0\" step=\"1\" />\r\n                </div>\r\n                <div class=\"field\">\r\n                  <label>Min range (m)</label>\r\n                  <input name=\"fire-min-range\" type=\"number\" min=\"0\" step=\"0.1\" />\r\n                </div>\r\n              </div>\r\n              <div class=\"grid-3\">\r\n                <div class=\"field\">\r\n                  <label>Max range (m)</label>\r\n                  <input name=\"fire-max-range\" type=\"number\" min=\"0\" step=\"0.1\" />\r\n                </div>\r\n                <div class=\"field\">\r\n                  <label>Cooldown (s)</label>\r\n                  <input name=\"fire-cooldown\" type=\"number\" min=\"0\" step=\"0.1\" />\r\n                </div>\r\n                <div class=\"field\">\r\n                  <label>Ammo reference</label>\r\n                  <input name=\"fire-ammo\" />\r\n                </div>\r\n              </div>\r\n              <div class=\"field\">\r\n                <label>Notes</label>\r\n                <textarea name=\"fire-notes\" rows=\"3\"></textarea>\r\n              </div>\r\n              <div class=\"form-actions\">\r\n                <button type=\"button\" class=\"ghost danger\" data-action=\"fire-delete\">Delete</button>\r\n                <button type=\"submit\" class=\"primary\">Apply changes</button>\r\n              </div>\r\n            </form>\r\n          </div>\r\n          <div class=\"status-bar panel-collapse-target\" data-role=\"fire-status\">Draft firing solutions for reuse.</div>\r\n        </section>\r\n\r\n        <section class=\"panel\">\r\n          <div class=\"panel-heading\">\r\n            <h3>Weapon Tags</h3>\r\n            <div class=\"header-actions\">\r\n              <button type=\"button\" class=\"primary\" data-action=\"tags-save\">Save tags</button>\r\n            </div>\r\n          </div>\r\n          <div class=\"tag-grid\">\r\n            <div>\r\n              <h4>Categories</h4>\r\n              <div data-role=\"tag-categories\"></div>\r\n              <button type=\"button\" class=\"ghost\" data-action=\"add-tag\" data-scope=\"categories\">Add category tag</button>\r\n            </div>\r\n            <div>\r\n              <h4>Calibers</h4>\r\n              <div data-role=\"tag-calibers\"></div>\r\n              <button type=\"button\" class=\"ghost\" data-action=\"add-tag\" data-scope=\"calibers\">Add caliber tag</button>\r\n            </div>\r\n          </div>\r\n          <div class=\"status-bar\" data-role=\"tag-status\">Define colors for quick filtering.</div>\r\n        </section>\r\n      </div>\r\n    `;\r\n    this.initializeAccessibilityState();\r\n  }\r\n\r\n  // Prime collapse controls so screen readers announce each panel correctly.\r\n  private initializeAccessibilityState(): void {\r\n    [\"weapon-panel\", \"ammo-panel\", \"fire-panel\"].forEach((panelId) => this.syncPanelToggleState(panelId));\r\n    this.root\r\n      .querySelectorAll<HTMLButtonElement>('[data-action=\"weapon-ammo-collapse\"], [data-action=\"weapon-fire-collapse\"]')\r\n      .forEach((button) => this.syncSubpanelToggle(button));\r\n  }\r\n\r\n  private cacheElements(): void {\r\n    this.weaponListEl = this.root.querySelector<HTMLElement>('[data-role=\"weapon-list\"]')!;\r\n    this.weaponFormEl = this.root.querySelector<HTMLFormElement>('[data-role=\"weapon-form\"]')!;\r\n    this.weaponStatusEl = this.root.querySelector<HTMLElement>('[data-role=\"weapon-status\"]')!;\r\n    this.weaponSearchInput = this.root.querySelector<HTMLInputElement>('[data-role=\"weapon-search\"]')!;\r\n    this.ammoListEl = this.root.querySelector<HTMLElement>('[data-role=\"ammo-list\"]')!;\r\n    this.ammoFormEl = this.root.querySelector<HTMLFormElement>('[data-role=\"ammo-form\"]')!;\r\n    this.ammoStatusEl = this.root.querySelector<HTMLElement>('[data-role=\"ammo-status\"]')!;\r\n    this.ammoSearchInput = this.root.querySelector<HTMLInputElement>('[data-role=\"ammo-search\"]')!;\r\n    this.fireListEl = this.root.querySelector<HTMLElement>('[data-role=\"fire-list\"]')!;\r\n    this.fireSearchInput = this.root.querySelector<HTMLInputElement>('[data-role=\"fire-search\"]')!;\r\n    this.fireFormEl = this.root.querySelector<HTMLFormElement>('[data-role=\"fire-form\"]')!;\r\n    this.fireStatusEl = this.root.querySelector<HTMLElement>('[data-role=\"fire-status\"]')!;\r\n    this.categoryTagListEl = this.root.querySelector<HTMLElement>('[data-role=\"tag-categories\"]')!;\r\n    this.caliberTagListEl = this.root.querySelector<HTMLElement>('[data-role=\"tag-calibers\"]')!;\r\n    this.tagStatusEl = this.root.querySelector<HTMLElement>('[data-role=\"tag-status\"]')!;\r\n    this.weaponAmmoListEl = this.root.querySelector<HTMLElement>('[data-role=\"weapon-ammo-list\"]')!;\r\n    this.weaponFireListEl = this.root.querySelector<HTMLElement>('[data-role=\"weapon-fire-list\"]')!;\r\n    this.weaponAmmoImportSelect = this.root.querySelector<HTMLSelectElement>('[data-role=\"weapon-ammo-import\"]')!;\r\n    this.weaponFireImportSelect = this.root.querySelector<HTMLSelectElement>('[data-role=\"weapon-fire-import\"]')!;\r\n    this.weaponTrajectoryWrapEl = this.root.querySelector<HTMLElement>('[data-role=\"weapon-trajectories\"]')!;\r\n    this.weaponTraitWrapEl = this.root.querySelector<HTMLElement>('[data-role=\"weapon-traits\"]')!;\r\n    this.weaponCategoryTagListEl = this.root.querySelector<HTMLDataListElement>('[data-role=\"weapon-category-tags\"]')!;\r\n    this.weaponCaliberTagListEl = this.root.querySelector<HTMLDataListElement>('[data-role=\"weapon-caliber-tags\"]')!;\r\n    this.populateWeaponAmmoImport();\r\n    this.populateWeaponFireImport();\r\n  }\r\n\r\n  private bindEvents(): void {\r\n    this.weaponListEl.addEventListener(\"click\", (event) => {\r\n      const button = (event.target as HTMLElement).closest<HTMLButtonElement>('[data-index]');\r\n      if (!button) return;\r\n      this.selectedWeapon = Number(button.dataset.index);\r\n      this.populateWeaponForm();\r\n      this.renderWeaponList();\r\n    });\r\n\r\n    this.weaponFormEl.addEventListener(\"submit\", (event) => {\r\n      event.preventDefault();\r\n      this.applyWeaponChanges();\r\n    });\r\n\r\n    this.ammoListEl.addEventListener(\"click\", (event) => {\r\n      const button = (event.target as HTMLElement).closest<HTMLButtonElement>('[data-index]');\r\n      if (!button) return;\r\n      this.selectedAmmo = Number(button.dataset.index);\r\n      this.populateAmmoForm();\r\n      this.renderAmmoList();\r\n    });\r\n\r\n    this.ammoFormEl.addEventListener(\"submit\", (event) => {\r\n      event.preventDefault();\r\n      this.applyAmmoChanges();\r\n    });\r\n\r\n    this.ammoFormEl.querySelector<HTMLInputElement>('[name=\"ammo-airburst\"]')?.addEventListener(\"change\", () => {\r\n      this.syncAmmoTemplateAirburstFields();\r\n    });\r\n\r\n    this.fireListEl.addEventListener(\"click\", (event) => {\r\n      const button = (event.target as HTMLElement).closest<HTMLButtonElement>('[data-index]');\r\n      if (!button) return;\r\n      this.selectedFire = Number(button.dataset.index);\r\n      this.populateFireForm();\r\n      this.renderFireList();\r\n    });\r\n\r\n    this.fireFormEl.addEventListener(\"submit\", (event) => {\r\n      event.preventDefault();\r\n      this.applyFireChanges();\r\n    });\r\n\r\n    this.root.addEventListener(\"click\", (event) => this.handleButtonActions(event));\r\n    this.root.addEventListener(\"input\", (event) => this.handleTagInput(event));\r\n\r\n    this.weaponSearchInput.addEventListener(\"input\", (event) => {\r\n      this.weaponSearchTerm = (event.target as HTMLInputElement).value.trim().toLowerCase();\r\n      this.renderWeaponList();\r\n    });\r\n\r\n    this.ammoSearchInput.addEventListener(\"input\", (event) => {\r\n      this.ammoSearchTerm = (event.target as HTMLInputElement).value.trim().toLowerCase();\r\n      this.renderAmmoList();\r\n    });\r\n\r\n    this.fireSearchInput.addEventListener(\"input\", (event) => {\r\n      this.fireSearchTerm = (event.target as HTMLInputElement).value.trim().toLowerCase();\r\n      this.renderFireList();\r\n    });\r\n\r\n    this.weaponAmmoImportSelect.addEventListener(\"change\", () => {\r\n      const index = Number(this.weaponAmmoImportSelect.value);\r\n      if (!Number.isNaN(index)) {\r\n        const template = this.ammo[index];\r\n        if (template) {\r\n          this.appendWeaponAmmoRow(deepClone(template));\r\n          this.refreshWeaponFireAmmoOptions();\r\n        }\r\n      }\r\n      this.weaponAmmoImportSelect.value = \"\";\r\n    });\r\n\r\n    this.weaponFireImportSelect.addEventListener(\"change\", () => {\r\n      const index = Number(this.weaponFireImportSelect.value);\r\n      if (!Number.isNaN(index)) {\r\n        const template = this.fireTemplates[index];\r\n        if (template) {\r\n          this.appendWeaponFireRow(deepClone(template));\r\n          this.refreshWeaponFireAmmoOptions();\r\n        }\r\n      }\r\n      this.weaponFireImportSelect.value = \"\";\r\n    });\r\n\r\n    this.weaponFormEl.querySelector<HTMLInputElement>('[name=\"weapon-caliber\"]')?.addEventListener(\"input\", () => {\r\n      this.refreshWeaponAmmoCaliberAutoFill();\r\n      this.weaponAmmoBallisticUpdaters.forEach((fn) => fn());\r\n    });\r\n\r\n    this.weaponFormEl.querySelector<HTMLInputElement>('[name=\"weapon-barrel\"]')?.addEventListener(\"input\", () => {\r\n      this.weaponAmmoBallisticUpdaters.forEach((fn) => fn());\r\n    });\r\n  }\r\n\r\n  private handleButtonActions(event: Event): void {\r\n    const button = (event.target as HTMLElement).closest<HTMLButtonElement>('[data-action]');\r\n    if (!button) return;\r\n    const action = button.dataset.action;\r\n    switch (action) {\r\n      case \"weapon-new\":\r\n        this.weapons.push(createWeaponTemplate());\r\n        this.selectedWeapon = this.weapons.length - 1;\r\n        this.renderWeaponList();\r\n        this.populateWeaponForm();\r\n        break;\r\n      case \"weapon-delete\":\r\n        if (this.weapons.length > 1) {\r\n          this.weapons.splice(this.selectedWeapon, 1);\r\n          this.selectedWeapon = Math.max(0, this.selectedWeapon - 1);\r\n          this.renderWeaponList();\r\n          this.populateWeaponForm();\r\n        }\r\n        break;\r\n      case \"weapon-save-all\":\r\n        this.applyWeaponChanges();\r\n        weaponLibraryService\r\n          .saveWeapons(this.weapons)\r\n          .then(() => this.setWeaponStatus(\"Weapon library saved.\", \"success\"))\r\n          .catch((error) => this.setWeaponStatus(error instanceof Error ? error.message : String(error), \"error\"));\r\n        break;\r\n      case \"weapon-ammo-add\":\r\n        this.appendWeaponAmmoRow();\r\n        this.refreshWeaponFireAmmoOptions();\r\n        break;\r\n      case \"weapon-ammo-collapse\":\r\n        this.toggleSubpanel(button);\r\n        break;\r\n      case \"weapon-fire-add\":\r\n        this.appendWeaponFireRow();\r\n        this.refreshWeaponFireAmmoOptions();\r\n        break;\r\n      case \"weapon-fire-collapse\":\r\n        this.toggleSubpanel(button);\r\n        break;\r\n      case \"toggle-panel\":\r\n        this.togglePanel(button.dataset.panelTarget);\r\n        break;\r\n      case \"ammo-new\":\r\n        this.ammo.push(createAmmoTemplate());\r\n        this.selectedAmmo = this.ammo.length - 1;\r\n        this.renderAmmoList();\r\n        this.populateAmmoForm();\r\n        break;\r\n      case \"ammo-delete\":\r\n        if (this.ammo.length > 1) {\r\n          this.ammo.splice(this.selectedAmmo, 1);\r\n          this.selectedAmmo = Math.max(0, this.selectedAmmo - 1);\r\n          this.renderAmmoList();\r\n          this.populateAmmoForm();\r\n        }\r\n        break;\r\n      case \"ammo-save-all\":\r\n        this.applyAmmoChanges();\r\n        ammoLibraryService\r\n          .saveTemplates(this.ammo)\r\n          .then(() => this.setAmmoStatus(\"Ammo templates saved.\", \"success\"))\r\n          .catch((error) => this.setAmmoStatus(error instanceof Error ? error.message : String(error), \"error\"));\r\n        break;\r\n      case \"fire-new\":\r\n        this.fireTemplates.push(createFireTemplate());\r\n        this.selectedFire = this.fireTemplates.length - 1;\r\n        this.renderFireList();\r\n        this.populateFireForm();\r\n        break;\r\n      case \"fire-delete\":\r\n        if (this.fireTemplates.length > 1) {\r\n          this.fireTemplates.splice(this.selectedFire, 1);\r\n          this.selectedFire = Math.max(0, this.selectedFire - 1);\r\n          this.renderFireList();\r\n          this.populateFireForm();\r\n        }\r\n        break;\r\n      case \"fire-save-all\":\r\n        this.applyFireChanges();\r\n        fireModeTemplateService\r\n          .saveTemplates(this.fireTemplates)\r\n          .then(() => this.setFireStatus(\"Fire mode templates saved.\", \"success\"))\r\n          .catch((error) => this.setFireStatus(error instanceof Error ? error.message : String(error), \"error\"));\r\n        break;\r\n      case \"add-tag\": {\r\n        const scope = (button.dataset.scope as TagScope) || \"categories\";\r\n        this.tagDraft[scope].push({ id: this.makeId(), name: \"\", color: \"#5bc0ff\" });\r\n        this.renderTagLists();\r\n        break;\r\n      }\r\n      case \"remove-tag\": {\r\n        const scope = (button.dataset.scope as TagScope) || \"categories\";\r\n        const id = button.dataset.id;\r\n        this.tagDraft[scope] = this.tagDraft[scope].filter((entry) => entry.id !== id);\r\n        this.renderTagLists();\r\n        break;\r\n      }\r\n      case \"tags-save\": {\r\n        const payload = this.buildTagPayload();\r\n        weaponTagService\r\n          .saveTags(payload)\r\n          .then(() => this.setTagStatus(\"Tags saved.\", \"success\"))\r\n          .catch((error) => this.setTagStatus(error instanceof Error ? error.message : String(error), \"error\"));\r\n        break;\r\n      }\r\n      default:\r\n        break;\r\n    }\r\n  }\r\n\r\n  private buildTagPayload(): WeaponTagMap {\r\n    const toMap = (entries: TagEntry[]): Record<string, string> => {\r\n      return entries.reduce<Record<string, string>>((acc, entry) => {\r\n        const key = entry.name.trim();\r\n        if (!key) return acc;\r\n        acc[key] = entry.color || \"#5bc0ff\";\r\n        return acc;\r\n      }, {});\r\n    };\r\n    return {\r\n      categories: toMap(this.tagDraft.categories),\r\n      calibers: toMap(this.tagDraft.calibers),\r\n    };\r\n  }\r\n\r\n  private renderWeaponList(): void {\r\n    this.weaponListEl.innerHTML = \"\";\r\n    this.weapons.forEach((weapon, index) => {\r\n      if (\r\n        this.weaponSearchTerm &&\r\n        !(weapon.name || \"\")\r\n          .toLowerCase()\r\n          .includes(this.weaponSearchTerm) &&\r\n        !(weapon.category || \"\")\r\n          .toLowerCase()\r\n          .includes(this.weaponSearchTerm)\r\n      ) {\r\n        return;\r\n      }\r\n      const button = document.createElement(\"button\");\r\n      button.type = \"button\";\r\n      button.dataset.index = index.toString();\r\n      button.className = `list-pill${index === this.selectedWeapon ? \" active\" : \"\"}`;\r\n      button.innerHTML = `\r\n        <span class=\"title\">${weapon.name || \"Untitled\"}</span>\r\n        <span class=\"meta\">${weapon.category || \"Unknown\"}</span>\r\n      `;\r\n      this.weaponListEl.appendChild(button);\r\n    });\r\n  }\r\n\r\n  private populateWeaponForm(): void {\r\n    const weapon = this.weapons[this.selectedWeapon] ?? createWeaponTemplate();\r\n    this.weaponFormEl.querySelector<HTMLInputElement>('[name=\"weapon-name\"]')!.value = weapon.name || \"\";\r\n    this.weaponFormEl.querySelector<HTMLInputElement>('[name=\"weapon-category\"]')!.value = weapon.category || \"\";\r\n    this.weaponFormEl.querySelector<HTMLInputElement>('[name=\"weapon-caliber\"]')!.value = weapon.caliber || \"\";\r\n    this.weaponFormEl.querySelector<HTMLInputElement>('[name=\"weapon-range\"]')!.value = weapon.range?.toString() || \"\";\r\n    this.weaponFormEl.querySelector<HTMLInputElement>('[name=\"weapon-mv\"]')!.value = weapon.muzzleVelocity?.toString() || \"\";\r\n    this.weaponFormEl.querySelector<HTMLInputElement>('[name=\"weapon-dispersion\"]')!.value = weapon.dispersion?.toString() || \"\";\r\n    this.weaponFormEl.querySelector<HTMLInputElement>('[name=\"weapon-barrel\"]')!.value = weapon.barrelLength?.toString() || \"\";\r\n    this.weaponFormEl.querySelector<HTMLInputElement>('[name=\"weapon-reload\"]')!.value = weapon.reloadSpeed?.toString() || \"\";\r\n    this.weaponFormEl.querySelector<HTMLInputElement>('[name=\"weapon-acquisition\"]')!.value = weapon.targetAcquisition?.toString() || \"\";\r\n    this.renderWeaponTrajectoryChips(weapon.trajectories || []);\r\n    this.renderWeaponTraitChips(weapon.traits || []);\r\n    this.weaponFormEl.querySelector<HTMLTextAreaElement>('[name=\"weapon-notes\"]')!.value = weapon.notes || \"\";\r\n    this.renderWeaponAmmoRows(weapon.ammoTypes || []);\r\n    this.renderWeaponFireRows(weapon.fireModes || []);\r\n  }\r\n\r\n  private applyWeaponChanges(): void {\r\n    const weapon = this.weapons[this.selectedWeapon] ?? createWeaponTemplate();\r\n    const data = new FormData(this.weaponFormEl);\r\n    weapon.name = (data.get(\"weapon-name\")?.toString().trim() || \"Untitled Weapon\").trim();\r\n    weapon.category = data.get(\"weapon-category\")?.toString().trim() || \"\";\r\n    weapon.caliber = data.get(\"weapon-caliber\")?.toString().trim() || \"\";\r\n    weapon.range = data.get(\"weapon-range\")?.toString().trim() || \"\";\r\n    weapon.muzzleVelocity = data.get(\"weapon-mv\")?.toString().trim() || \"\";\r\n    weapon.dispersion = data.get(\"weapon-dispersion\")?.toString().trim() || \"\";\r\n    weapon.barrelLength = data.get(\"weapon-barrel\")?.toString().trim() || \"\";\r\n    weapon.reloadSpeed = data.get(\"weapon-reload\")?.toString().trim() || \"\";\r\n    weapon.targetAcquisition = data.get(\"weapon-acquisition\")?.toString().trim() || \"\";\r\n    weapon.trajectories = this.collectChipSelections(this.weaponTrajectoryWrapEl);\r\n    weapon.traits = this.collectChipSelections(this.weaponTraitWrapEl);\r\n    weapon.notes = data.get(\"weapon-notes\")?.toString();\r\n    weapon.ammoTypes = this.collectWeaponAmmoRows();\r\n    weapon.fireModes = this.collectWeaponFireRows();\r\n\r\n    this.weapons[this.selectedWeapon] = weapon;\r\n    this.renderWeaponList();\r\n  }\r\n\r\n  private renderWeaponAmmoRows(ammoList: WeaponAmmoEntry[]): void {\r\n    if (!this.weaponAmmoListEl) return;\r\n    this.weaponAmmoListEl.innerHTML = \"\";\r\n    this.weaponAmmoBallisticUpdaters = [];\r\n    const source = ammoList && ammoList.length ? ammoList : [undefined];\r\n    source.forEach((ammo) => this.appendWeaponAmmoRow(ammo));\r\n    this.refreshWeaponFireAmmoOptions();\r\n  }\r\n\r\n  private renderWeaponFireRows(modes: WeaponFireModeEntry[]): void {\r\n    if (!this.weaponFireListEl) return;\r\n    this.weaponFireListEl.innerHTML = \"\";\r\n    const source = modes && modes.length ? modes : [undefined];\r\n    source.forEach((mode) => this.appendWeaponFireRow(mode));\r\n    this.refreshWeaponFireAmmoOptions();\r\n  }\r\n\r\n  private syncPanelToggleState(panelId?: string): void {\r\n    if (!panelId) return;\r\n    const panel = this.root.querySelector<HTMLElement>(`[data-panel=\"${panelId}\"]`);\r\n    if (!panel) return;\r\n    if (!panel.id) {\r\n      panel.id = panelId;\r\n    }\r\n    const expanded = !panel.classList.contains(\"collapsed\");\r\n    const heading = panel.querySelector(\"h3\")?.textContent?.trim() || panelId;\r\n    this.root\r\n      .querySelectorAll<HTMLButtonElement>(`[data-action=\"toggle-panel\"][data-panel-target=\"${panelId}\"]`)\r\n      .forEach((btn) => {\r\n        btn.textContent = expanded ? \"Collapse\" : \"Expand\";\r\n        btn.setAttribute(\"aria-expanded\", expanded ? \"true\" : \"false\");\r\n        btn.setAttribute(\"aria-controls\", panel.id);\r\n        btn.setAttribute(\"aria-label\", `${expanded ? \"Collapse\" : \"Expand\"} ${heading}`);\r\n      });\r\n  }\r\n\r\n  private syncSubpanelToggle(button: HTMLButtonElement): void {\r\n    const panel = button.closest<HTMLElement>(\".subpanel\");\r\n    if (!panel) return;\r\n    const body = panel.querySelector<HTMLElement>(\".subpanel-body\");\r\n    if (!body) return;\r\n    if (!body.id) {\r\n      const base = panel.dataset.subpanel || `subpanel-${this.makeId()}`;\r\n      body.id = `${base}-body`;\r\n    }\r\n    const expanded = !panel.classList.contains(\"collapsed\");\r\n    const heading = panel.querySelector(\"strong\")?.textContent?.trim() || \"section\";\r\n    button.textContent = expanded ? \"Collapse\" : \"Expand\";\r\n    button.setAttribute(\"aria-expanded\", expanded ? \"true\" : \"false\");\r\n    button.setAttribute(\"aria-controls\", body.id);\r\n    button.setAttribute(\"aria-label\", `${expanded ? \"Collapse\" : \"Expand\"} ${heading}`);\r\n  }\r\n\r\n  private togglePanel(panelId?: string): void {\r\n    if (!panelId) return;\r\n    const panel = this.root.querySelector<HTMLElement>(`[data-panel=\"${panelId}\"]`);\r\n    if (!panel) return;\r\n    panel.classList.toggle(\"collapsed\");\r\n    this.syncPanelToggleState(panelId);\r\n  }\r\n\r\n  private toggleSubpanel(button: HTMLButtonElement): void {\r\n    const panel = button.closest<HTMLElement>(\".subpanel\");\r\n    if (!panel) return;\r\n    panel.classList.toggle(\"collapsed\");\r\n    this.syncSubpanelToggle(button);\r\n  }\r\n\r\n  private collectChipSelections(container?: HTMLElement): string[] {\r\n    if (!container) return [];\r\n    return Array.from(container.querySelectorAll<HTMLButtonElement>(\"[data-value]\"))\r\n      .filter((btn) => btn.classList.contains(\"active\"))\r\n      .map((btn) => btn.dataset.value?.trim() || \"\")\r\n      .filter(Boolean);\r\n  }\r\n\r\n  private renderWeaponTrajectoryChips(selected: string[]): void {\r\n    if (!this.weaponTrajectoryWrapEl) return;\r\n    const active = new Set((selected || []).map((value) => value.toLowerCase()));\r\n    this.weaponTrajectoryWrapEl.innerHTML = \"\";\r\n    TRAJECTORY_OPTIONS.forEach((option) => {\r\n      const btn = document.createElement(\"button\");\r\n      btn.type = \"button\";\r\n      btn.className = \"chip-button\";\r\n      btn.dataset.chipGroup = \"trajectory\";\r\n      btn.dataset.value = option.value;\r\n      btn.textContent = option.label;\r\n      if (active.has(option.value.toLowerCase())) {\r\n        btn.classList.add(\"active\");\r\n      }\r\n      btn.addEventListener(\"click\", () => btn.classList.toggle(\"active\"));\r\n      this.weaponTrajectoryWrapEl.appendChild(btn);\r\n    });\r\n  }\r\n\r\n  private renderWeaponTraitChips(selected: string[]): void {\r\n    if (!this.weaponTraitWrapEl) return;\r\n    const active = new Set((selected || []).map((value) => value.toLowerCase()));\r\n    this.weaponTraitWrapEl.innerHTML = \"\";\r\n    WEAPON_TRAIT_GROUPS.forEach((group, index) => {\r\n      group.forEach((option) => {\r\n        const btn = document.createElement(\"button\");\r\n        btn.type = \"button\";\r\n        btn.className = \"chip-button\";\r\n        btn.dataset.chipGroup = \"trait\";\r\n        btn.dataset.value = option.value;\r\n        btn.textContent = option.label;\r\n        if (active.has(option.value.toLowerCase())) {\r\n          btn.classList.add(\"active\");\r\n        }\r\n        btn.addEventListener(\"click\", () => btn.classList.toggle(\"active\"));\r\n        this.weaponTraitWrapEl.appendChild(btn);\r\n      });\r\n      if (index === 0) {\r\n        const separator = document.createElement(\"span\");\r\n        separator.className = \"trait-separator\";\r\n        this.weaponTraitWrapEl.appendChild(separator);\r\n      }\r\n    });\r\n  }\r\n\r\n  private appendWeaponAmmoRow(ammo?: WeaponAmmoEntry): void {\r\n    if (!this.weaponAmmoListEl) return;\r\n    const toValue = (value: unknown) => this.toInputValue(value);\r\n    const row = document.createElement(\"div\");\r\n    row.className = \"ammo-row\";\r\n    row.dataset.role = \"weapon-ammo-row\";\r\n    const airburstValue = ammo?.airburst === true || ammo?.airburst === \"true\" ? \"yes\" : \"no\";\r\n    row.innerHTML = `\r\n      <div class=\"subgrid\">\r\n        <label>Name<input data-ammo-field=\"name\" value=\"${toValue(ammo?.name)}\" /></label>\r\n        <label>Type<input data-ammo-field=\"ammoType\" value=\"${toValue(ammo?.ammoType)}\" /></label>\r\n        <label>Caliber<input data-ammo-field=\"caliber\" value=\"${toValue(ammo?.caliber)}\" readonly tabindex=\"-1\" /></label>\r\n        <label>Caliber notes<input data-ammo-field=\"caliberDesc\" value=\"${toValue(ammo?.caliberDesc)}\" /></label>\r\n        <label>Penetration (mm)<input data-ammo-field=\"penetration\" type=\"number\" step=\"0.1\" value=\"${toValue(ammo?.penetration)}\" /></label>\r\n        <label>HE value<input data-ammo-field=\"heDeadliness\" type=\"number\" step=\"0.1\" value=\"${toValue(ammo?.heDeadliness)}\" /></label>\r\n        <label>Dispersion (%)<input data-ammo-field=\"dispersion\" type=\"number\" step=\"0.1\" value=\"${toValue(ammo?.dispersion)}\" /></label>\r\n        <label>Range delta (%)<input data-ammo-field=\"rangeMod\" type=\"number\" step=\"0.1\" value=\"${toValue(ammo?.rangeMod)}\" /></label>\r\n        <label>Ammo/Soldier<input data-ammo-field=\"ammoPerSoldier\" type=\"number\" min=\"0\" step=\"1\" value=\"${toValue(ammo?.ammoPerSoldier)}\" /></label>\r\n        <label>Grain<input data-ammo-field=\"grain\" type=\"number\" step=\"0.1\" value=\"${toValue(ammo?.grain)}\" /></label>\r\n        <label>Muzzle velocity (fps)<input data-ammo-field=\"fps\" type=\"number\" step=\"1\" value=\"${toValue(ammo?.fps)}\" /></label>\r\n        <label>Notes<input data-ammo-field=\"notes\" value=\"${toValue(ammo?.notes)}\" /></label>\r\n        <label>Airburst\r\n          <select data-ammo-field=\"airburst\">\r\n            <option value=\"yes\" ${airburstValue === \"yes\" ? \"selected\" : \"\"}>Yes</option>\r\n            <option value=\"no\" ${airburstValue === \"no\" ? \"selected\" : \"\"}>No</option>\r\n          </select>\r\n        </label>\r\n        <label>Sub munitions (#)<input data-ammo-field=\"subCount\" type=\"number\" min=\"0\" step=\"1\" data-airburst-dependent value=\"${toValue(ammo?.subCount)}\" /></label>\r\n        <label>Sub damage<input data-ammo-field=\"subDamage\" type=\"number\" step=\"0.1\" data-airburst-dependent value=\"${toValue(ammo?.subDamage)}\" /></label>\r\n        <label>Sub penetration (mm)<input data-ammo-field=\"subPenetration\" type=\"number\" step=\"0.1\" data-airburst-dependent value=\"${toValue(ammo?.subPenetration)}\" /></label>\r\n      </div>\r\n      <div class=\"row-actions\">\r\n        <button type=\"button\" class=\"ghost small\" data-action=\"remove-weapon-ammo\">Remove</button>\r\n      </div>\r\n    `;\r\n    const grainInput = row.querySelector<HTMLInputElement>('input[data-ammo-field=\"grain\"]');\r\n    const fpsInput = row.querySelector<HTMLInputElement>('input[data-ammo-field=\"fps\"]');\r\n    const ammoCaliberInput = row.querySelector<HTMLInputElement>('input[data-ammo-field=\"caliber\"]');\r\n    if (ammoCaliberInput) {\r\n      ammoCaliberInput.readOnly = true;\r\n      ammoCaliberInput.tabIndex = -1;\r\n      ammoCaliberInput.classList.add(\"readonly\");\r\n      if (typeof ammo?.caliber === \"string\" && ammo.caliber.trim()) {\r\n        ammoCaliberInput.dataset.initialCaliber = ammo.caliber.trim();\r\n      }\r\n      const startingValue = this.getWeaponFormCaliber() || ammoCaliberInput.dataset.initialCaliber || \"\";\r\n      ammoCaliberInput.value = startingValue;\r\n      ammoCaliberInput.placeholder = startingValue || this.getWeaponFormCaliber();\r\n      ammoCaliberInput.dataset.initialCaliber = startingValue;\r\n    }\r\n    const applyBallistics = () => {\r\n      if (!grainInput || !fpsInput) return;\r\n      const grain = Number.parseFloat(grainInput.value || \"0\");\r\n      if (Number.isNaN(grain)) return;\r\n      const barrel = this.getWeaponFormBarrelLength();\r\n      const caliberSource = this.getWeaponFormCaliber() || ammoCaliberInput?.dataset.initialCaliber || \"\";\r\n      const velocity = this.computeAmmoFpsEstimate(caliberSource, barrel, grain);\r\n      fpsInput.value = velocity.toString();\r\n    };\r\n    const removeButton = row.querySelector<HTMLButtonElement>('[data-action=\"remove-weapon-ammo\"]');\r\n    removeButton?.addEventListener(\"click\", () => {\r\n      row.remove();\r\n      const index = this.weaponAmmoBallisticUpdaters.indexOf(applyBallistics);\r\n      if (index >= 0) this.weaponAmmoBallisticUpdaters.splice(index, 1);\r\n      this.refreshWeaponFireAmmoOptions();\r\n    });\r\n    const airburstSelect = row.querySelector<HTMLSelectElement>('select[data-ammo-field=\"airburst\"]');\r\n    const subInputs = row.querySelectorAll<HTMLInputElement>('[data-airburst-dependent]');\r\n    const syncAirburst = () => {\r\n      const enabled = airburstSelect?.value === \"yes\";\r\n      subInputs.forEach((input) => {\r\n        input.disabled = !enabled;\r\n      });\r\n    };\r\n    airburstSelect?.addEventListener(\"change\", syncAirburst);\r\n    syncAirburst();\r\n    row.addEventListener(\"input\", (event) => {\r\n      if ((event.target as HTMLElement).matches('[data-ammo-field=\"name\"]')) {\r\n        this.refreshWeaponFireAmmoOptions();\r\n      }\r\n    });\r\n    grainInput?.addEventListener(\"input\", applyBallistics);\r\n    this.weaponAmmoBallisticUpdaters.push(applyBallistics);\r\n    this.weaponAmmoListEl.appendChild(row);\r\n    this.refreshWeaponAmmoCaliberAutoFill();\r\n    applyBallistics();\r\n  }\r\n\r\n  private appendWeaponFireRow(mode?: WeaponFireModeEntry): void {\r\n    if (!this.weaponFireListEl) return;\r\n    const toValue = (value: unknown) => this.toInputValue(value);\r\n    const row = document.createElement(\"div\");\r\n    row.className = \"fire-row\";\r\n    row.dataset.role = \"weapon-fire-row\";\r\n    row.innerHTML = `\r\n      <div class=\"subgrid\">\r\n        <label>Name<input data-fire-field=\"name\" value=\"${toValue(mode?.name)}\" /></label>\r\n        <label>Rounds / burst<input data-fire-field=\"rounds\" type=\"number\" min=\"0\" step=\"1\" value=\"${toValue(mode?.rounds)}\" /></label>\r\n        <label>Min range (m)<input data-fire-field=\"minRange\" type=\"number\" min=\"0\" step=\"0.1\" value=\"${toValue(mode?.minRange)}\" /></label>\r\n        <label>Max range (m)<input data-fire-field=\"maxRange\" type=\"number\" min=\"0\" step=\"0.1\" value=\"${toValue(mode?.maxRange)}\" /></label>\r\n        <label>Cooldown (s)<input data-fire-field=\"cooldown\" type=\"number\" min=\"0\" step=\"0.1\" value=\"${toValue(mode?.cooldown)}\" /></label>\r\n        <label>Ammo reference<select data-fire-field=\"ammoRef\"></select></label>\r\n        <label>Notes<input data-fire-field=\"notes\" value=\"${toValue(mode?.notes)}\" /></label>\r\n      </div>\r\n      <div class=\"row-actions\">\r\n        <button type=\"button\" class=\"ghost small\" data-action=\"remove-weapon-fire\">Remove</button>\r\n      </div>\r\n    `;\r\n    row.querySelector<HTMLButtonElement>('[data-action=\"remove-weapon-fire\"]')?.addEventListener(\"click\", () => {\r\n      row.remove();\r\n      this.refreshWeaponFireAmmoOptions();\r\n    });\r\n    this.weaponFireListEl.appendChild(row);\r\n    const select = row.querySelector<HTMLSelectElement>('select[data-fire-field=\"ammoRef\"]');\r\n    if (select) {\r\n      if (mode?.ammoRef) {\r\n        select.dataset.prefill = mode.ammoRef;\r\n      }\r\n    }\r\n  }\r\n\r\n  private collectWeaponAmmoRows(): WeaponAmmoEntry[] {\r\n    if (!this.weaponAmmoListEl) return [];\r\n    const rows = Array.from(this.weaponAmmoListEl.querySelectorAll<HTMLElement>('[data-role=\"weapon-ammo-row\"]'));\r\n    return rows\r\n      .map((row) => {\r\n        const read = (field: string, selector = \"input\") =>\r\n          (row.querySelector<HTMLInputElement | HTMLSelectElement>(`${selector}[data-ammo-field=\"${field}\"]`)?.value || \"\").trim();\r\n        const ammo: WeaponAmmoEntry = {\r\n          name: read(\"name\") || undefined,\r\n          ammoType: read(\"ammoType\") || undefined,\r\n          caliber: read(\"caliber\") || undefined,\r\n          caliberDesc: read(\"caliberDesc\") || undefined,\r\n          penetration: read(\"penetration\") || undefined,\r\n          heDeadliness: read(\"heDeadliness\") || undefined,\r\n          dispersion: read(\"dispersion\") || undefined,\r\n          rangeMod: read(\"rangeMod\") || undefined,\r\n          ammoPerSoldier: read(\"ammoPerSoldier\") || undefined,\r\n          grain: read(\"grain\") || undefined,\r\n          fps: read(\"fps\") || undefined,\r\n          notes: read(\"notes\") || undefined,\r\n          subCount: read(\"subCount\") || undefined,\r\n          subDamage: read(\"subDamage\") || undefined,\r\n          subPenetration: read(\"subPenetration\") || undefined,\r\n        };\r\n        const airburst = read(\"airburst\", \"select\");\r\n        if (airburst === \"yes\" || airburst === \"true\") ammo.airburst = true;\r\n        else if (airburst === \"no\" || airburst === \"false\" || airburst === \"\") ammo.airburst = false;\r\n        else delete ammo.airburst;\r\n        return ammo;\r\n      })\r\n      .filter((ammo) => Object.values(ammo).some((value) => value !== undefined && value !== \"\"));\r\n  }\r\n\r\n  private collectWeaponFireRows(): WeaponFireModeEntry[] {\r\n    if (!this.weaponFireListEl) return [];\r\n    const rows = Array.from(this.weaponFireListEl.querySelectorAll<HTMLElement>('[data-role=\"weapon-fire-row\"]'));\r\n    return rows\r\n      .map((row) => {\r\n        const read = (field: string) =>\r\n          (row.querySelector<HTMLInputElement | HTMLSelectElement>(`[data-fire-field=\"${field}\"]`)?.value || \"\").trim();\r\n        const mode: WeaponFireModeEntry = {\r\n          name: read(\"name\") || undefined,\r\n          rounds: read(\"rounds\") || undefined,\r\n          minRange: read(\"minRange\") || undefined,\r\n          maxRange: read(\"maxRange\") || undefined,\r\n          cooldown: read(\"cooldown\") || undefined,\r\n          ammoRef: read(\"ammoRef\") || undefined,\r\n          notes: read(\"notes\") || undefined,\r\n        };\r\n        return mode;\r\n      })\r\n      .filter((mode) => Object.values(mode).some((value) => value !== undefined && value !== \"\"));\r\n  }\r\n\r\n  private refreshWeaponFireAmmoOptions(): void {\r\n    if (!this.weaponFireListEl || !this.weaponAmmoListEl) return;\r\n    const names = Array.from(this.weaponAmmoListEl.querySelectorAll<HTMLInputElement>('input[data-ammo-field=\"name\"]'))\r\n      .map((input) => input.value.trim())\r\n      .filter(Boolean);\r\n    this.weaponFireListEl.querySelectorAll<HTMLSelectElement>('select[data-fire-field=\"ammoRef\"]').forEach((select) => {\r\n      const current = select.value || select.dataset.prefill || \"\";\r\n      select.innerHTML = \"\";\r\n      const empty = document.createElement(\"option\");\r\n      empty.value = \"\";\r\n      empty.textContent = \"None\";\r\n      select.appendChild(empty);\r\n      names.forEach((name) => {\r\n        const opt = document.createElement(\"option\");\r\n        opt.value = name;\r\n        opt.textContent = name;\r\n        select.appendChild(opt);\r\n      });\r\n      if (current && names.includes(current)) {\r\n        select.value = current;\r\n      } else {\r\n        select.value = \"\";\r\n        if (current) select.dataset.prefill = current;\r\n      }\r\n    });\r\n  }\r\n\r\n  private populateWeaponAmmoImport(): void {\r\n    if (!this.weaponAmmoImportSelect) return;\r\n    this.weaponAmmoImportSelect.innerHTML = '<option value=\"\">From templates...</option>';\r\n    this.ammo.forEach((template, index) => {\r\n      const option = document.createElement(\"option\");\r\n      option.value = index.toString();\r\n      option.textContent = `${template.name || \"Template\"}  ${template.caliber || \"?\"}`;\r\n      this.weaponAmmoImportSelect.appendChild(option);\r\n    });\r\n  }\r\n\r\n  private populateWeaponFireImport(): void {\r\n    if (!this.weaponFireImportSelect) return;\r\n    this.weaponFireImportSelect.innerHTML = '<option value=\"\">From templates...</option>';\r\n    this.fireTemplates.forEach((template, index) => {\r\n      const option = document.createElement(\"option\");\r\n      option.value = index.toString();\r\n      option.textContent = template.name || `Mode ${index + 1}`;\r\n      this.weaponFireImportSelect.appendChild(option);\r\n    });\r\n  }\r\n\r\n  private renderAmmoList(): void {\r\n    this.ammoListEl.innerHTML = \"\";\r\n    let rendered = 0;\r\n    const term = this.ammoSearchTerm;\r\n    this.ammo.forEach((template, index) => {\r\n      if (\r\n        term &&\r\n        !(template.name || \"\").toLowerCase().includes(term) &&\r\n        !(template.caliber || \"\").toLowerCase().includes(term)\r\n      ) {\r\n        return;\r\n      }\r\n      const button = document.createElement(\"button\");\r\n      button.type = \"button\";\r\n      button.dataset.index = index.toString();\r\n      button.className = `list-pill${index === this.selectedAmmo ? \" active\" : \"\"}`;\r\n      button.innerHTML = `\r\n        <span class=\"title\">${template.name || \"Template\"}</span>\r\n        <span class=\"meta\">${template.caliber || \"Unknown\"}</span>\r\n      `;\r\n      this.ammoListEl.appendChild(button);\r\n      rendered += 1;\r\n    });\r\n    if (!rendered) {\r\n      const empty = document.createElement(\"p\");\r\n      empty.className = \"empty\";\r\n      empty.textContent = \"No templates match the search.\";\r\n      this.ammoListEl.appendChild(empty);\r\n    }\r\n  }\r\n\r\n  private populateAmmoForm(): void {\r\n    const template = this.ammo[this.selectedAmmo] ?? createAmmoTemplate();\r\n    this.ammoFormEl.querySelector<HTMLInputElement>('[name=\"ammo-name\"]')!.value = template.name || \"\";\r\n    this.ammoFormEl.querySelector<HTMLInputElement>('[name=\"ammo-caliber\"]')!.value = template.caliber || \"\";\r\n    this.ammoFormEl.querySelector<HTMLInputElement>('[name=\"ammo-caliber-desc\"]')!.value = template.caliberDesc || \"\";\r\n    this.ammoFormEl.querySelector<HTMLInputElement>('[name=\"ammo-type\"]')!.value = template.ammoType || \"\";\r\n    this.ammoFormEl.querySelector<HTMLInputElement>('[name=\"ammo-pen\"]')!.value = template.penetration?.toString() || \"\";\r\n    this.ammoFormEl.querySelector<HTMLInputElement>('[name=\"ammo-he\"]')!.value = template.heDeadliness?.toString() || \"\";\r\n    this.ammoFormEl.querySelector<HTMLInputElement>('[name=\"ammo-dispersion\"]')!.value = template.dispersion?.toString() || \"\";\r\n    this.ammoFormEl.querySelector<HTMLInputElement>('[name=\"ammo-range-mod\"]')!.value = template.rangeMod?.toString() || \"\";\r\n    this.ammoFormEl.querySelector<HTMLInputElement>('[name=\"ammo-grain\"]')!.value = template.grain?.toString() || \"\";\r\n    this.ammoFormEl.querySelector<HTMLInputElement>('[name=\"ammo-fps\"]')!.value = template.fps?.toString() || \"\";\r\n    this.ammoFormEl.querySelector<HTMLInputElement>('[name=\"ammo-sub-count\"]')!.value = template.subCount?.toString() || \"\";\r\n    this.ammoFormEl.querySelector<HTMLInputElement>('[name=\"ammo-sub-damage\"]')!.value = template.subDamage?.toString() || \"\";\r\n    this.ammoFormEl.querySelector<HTMLInputElement>('[name=\"ammo-sub-pen\"]')!.value = template.subPenetration?.toString() || \"\";\r\n    (this.ammoFormEl.querySelector<HTMLInputElement>('[name=\"ammo-airburst\"]') as HTMLInputElement).checked = Boolean(template.airburst);\r\n    this.ammoFormEl.querySelector<HTMLTextAreaElement>('[name=\"ammo-notes\"]')!.value = template.notes || \"\";\r\n    this.syncAmmoTemplateAirburstFields();\r\n  }\r\n\r\n  private applyAmmoChanges(): void {\r\n    const template = this.ammo[this.selectedAmmo] ?? createAmmoTemplate();\r\n    const data = new FormData(this.ammoFormEl);\r\n    template.name = data.get(\"ammo-name\")?.toString().trim() || \"New Template\";\r\n    template.caliber = data.get(\"ammo-caliber\")?.toString().trim() || \"\";\r\n    template.caliberDesc = data.get(\"ammo-caliber-desc\")?.toString().trim() || \"\";\r\n    template.ammoType = data.get(\"ammo-type\")?.toString().trim() || \"\";\r\n    delete template.ammoPerSoldier;\r\n    template.penetration = data.get(\"ammo-pen\")?.toString().trim() || \"\";\r\n    template.heDeadliness = data.get(\"ammo-he\")?.toString().trim() || \"\";\r\n    template.dispersion = data.get(\"ammo-dispersion\")?.toString().trim() || \"\";\r\n    template.rangeMod = data.get(\"ammo-range-mod\")?.toString().trim() || \"\";\r\n    template.grain = data.get(\"ammo-grain\")?.toString().trim() || \"\";\r\n    template.fps = data.get(\"ammo-fps\")?.toString().trim() || \"\";\r\n    template.subCount = data.get(\"ammo-sub-count\")?.toString().trim() || \"\";\r\n    template.subDamage = data.get(\"ammo-sub-damage\")?.toString().trim() || \"\";\r\n    template.subPenetration = data.get(\"ammo-sub-pen\")?.toString().trim() || \"\";\r\n    template.airburst = Boolean(data.get(\"ammo-airburst\"));\r\n    template.notes = data.get(\"ammo-notes\")?.toString();\r\n    this.ammo[this.selectedAmmo] = template;\r\n    this.renderAmmoList();\r\n  }\r\n\r\n  private renderFireList(): void {\r\n    this.fireListEl.innerHTML = \"\";\r\n    this.fireTemplates.forEach((template, index) => {\r\n      if (\r\n        this.fireSearchTerm &&\r\n        !(template.name || \"\").toLowerCase().includes(this.fireSearchTerm) &&\r\n        !(template.ammoRef || \"\").toLowerCase().includes(this.fireSearchTerm)\r\n      ) {\r\n        return;\r\n      }\r\n      const button = document.createElement(\"button\");\r\n      button.type = \"button\";\r\n      button.dataset.index = index.toString();\r\n      button.className = `list-pill${index === this.selectedFire ? \" active\" : \"\"}`;\r\n      button.innerHTML = `\r\n        <span class=\"title\">${template.name || \"Mode\"}</span>\r\n        <span class=\"meta\">${template.rounds || \"-\"} rnd burst</span>\r\n      `;\r\n      this.fireListEl.appendChild(button);\r\n    });\r\n  }\r\n\r\n  private populateFireForm(): void {\r\n    const template = this.fireTemplates[this.selectedFire] ?? createFireTemplate();\r\n    this.fireFormEl.querySelector<HTMLInputElement>('[name=\"fire-name\"]')!.value = template.name || \"\";\r\n    this.fireFormEl.querySelector<HTMLInputElement>('[name=\"fire-rounds\"]')!.value = template.rounds?.toString() || \"\";\r\n    this.fireFormEl.querySelector<HTMLInputElement>('[name=\"fire-min-range\"]')!.value = template.minRange?.toString() || \"\";\r\n    this.fireFormEl.querySelector<HTMLInputElement>('[name=\"fire-max-range\"]')!.value = template.maxRange?.toString() || \"\";\r\n    this.fireFormEl.querySelector<HTMLInputElement>('[name=\"fire-cooldown\"]')!.value = template.cooldown?.toString() || \"\";\r\n    this.fireFormEl.querySelector<HTMLInputElement>('[name=\"fire-ammo\"]')!.value = template.ammoRef || \"\";\r\n    this.fireFormEl.querySelector<HTMLTextAreaElement>('[name=\"fire-notes\"]')!.value = template.notes || \"\";\r\n  }\r\n\r\n  private applyFireChanges(): void {\r\n    const template = this.fireTemplates[this.selectedFire] ?? createFireTemplate();\r\n    const data = new FormData(this.fireFormEl);\r\n    template.name = data.get(\"fire-name\")?.toString().trim() || \"New Mode\";\r\n    template.rounds = data.get(\"fire-rounds\")?.toString().trim() || \"\";\r\n    template.minRange = data.get(\"fire-min-range\")?.toString().trim() || \"\";\r\n    template.maxRange = data.get(\"fire-max-range\")?.toString().trim() || \"\";\r\n    template.cooldown = data.get(\"fire-cooldown\")?.toString().trim() || \"\";\r\n    template.ammoRef = data.get(\"fire-ammo\")?.toString().trim() || \"\";\r\n    template.notes = data.get(\"fire-notes\")?.toString().trim() || \"\";\r\n    this.fireTemplates[this.selectedFire] = template;\r\n    this.renderFireList();\r\n  }\r\n\r\n  private syncAmmoTemplateAirburstFields(): void {\r\n    if (!this.ammoFormEl) return;\r\n    const toggle = this.ammoFormEl.querySelector<HTMLInputElement>('[name=\"ammo-airburst\"]');\r\n    const enabled = Boolean(toggle?.checked);\r\n    [\"ammo-sub-count\", \"ammo-sub-damage\", \"ammo-sub-pen\"].forEach((name) => {\r\n      const input = this.ammoFormEl.querySelector<HTMLInputElement>(`[name=\"${name}\"]`);\r\n      if (input) {\r\n        input.disabled = !enabled;\r\n      }\r\n    });\r\n  }\r\n\r\n  private renderTagLists(): void {\r\n    const makeRow = (entry: TagEntry, scope: TagScope): HTMLElement => {\r\n      const row = document.createElement(\"div\");\r\n      row.className = \"tag-row\";\r\n      row.innerHTML = `\r\n        <input type=\"text\" data-tag-field=\"name\" data-scope=\"${scope}\" data-id=\"${entry.id}\" placeholder=\"Label\" value=\"${entry.name}\" />\r\n        <input type=\"color\" data-tag-field=\"color\" data-scope=\"${scope}\" data-id=\"${entry.id}\" value=\"${entry.color}\" />\r\n        <button type=\"button\" class=\"ghost\" data-action=\"remove-tag\" data-scope=\"${scope}\" data-id=\"${entry.id}\">Remove</button>\r\n      `;\r\n      const preview = document.createElement(\"span\");\r\n      preview.className = \"tag-chip-preview\";\r\n      row.prepend(preview);\r\n      const nameInput = row.querySelector<HTMLInputElement>('input[data-tag-field=\"name\"]');\r\n      const colorInput = row.querySelector<HTMLInputElement>('input[data-tag-field=\"color\"]');\r\n      const syncPreview = () => {\r\n        preview.textContent = (nameInput?.value.trim() || \"Untitled tag\").substring(0, 32);\r\n        const color = colorInput?.value || \"#5bc0ff\";\r\n        preview.style.setProperty(\"--tag-chip-color\", color);\r\n      };\r\n      nameInput?.addEventListener(\"input\", syncPreview);\r\n      colorInput?.addEventListener(\"input\", syncPreview);\r\n      syncPreview();\r\n      return row;\r\n    };\r\n\r\n    this.categoryTagListEl.innerHTML = \"\";\r\n    this.tagDraft.categories.forEach((entry) => {\r\n      this.categoryTagListEl.appendChild(makeRow(entry, \"categories\"));\r\n    });\r\n\r\n    this.caliberTagListEl.innerHTML = \"\";\r\n    this.tagDraft.calibers.forEach((entry) => {\r\n      this.caliberTagListEl.appendChild(makeRow(entry, \"calibers\"));\r\n    });\r\n  }\r\n\r\n  private getWeaponFormCaliber(): string {\r\n    return this.weaponFormEl?.querySelector<HTMLInputElement>('[name=\"weapon-caliber\"]')?.value.trim() || \"\";\r\n  }\r\n\r\n  private getWeaponFormBarrelLength(): number {\r\n    const rawValue = this.weaponFormEl?.querySelector<HTMLInputElement>('[name=\"weapon-barrel\"]')?.value || \"\";\r\n    const parsed = Number.parseFloat(rawValue);\r\n    return Number.isNaN(parsed) ? 0 : parsed;\r\n  }\r\n\r\n  private parseCaliberMeasurement(raw?: string | null): number | undefined {\r\n    if (!raw) return undefined;\r\n    const normalized = raw.replace(\",\", \".\");\r\n    const match = normalized.match(/\\d+(?:\\.\\d+)?/);\r\n    if (!match) return undefined;\r\n    const value = Number.parseFloat(match[0]);\r\n    return Number.isNaN(value) ? undefined : value;\r\n  }\r\n\r\n  private computeAmmoFpsEstimate(caliberRaw: string, barrelLength: number, grain: number): number {\r\n    const normalized = caliberRaw.replace(/\\s+/g, \"\");\r\n    const caliberMatch = normalized.match(/(\\d{1,3})(?:[.,](\\d{1,3}))?x(\\d{1,3})/i);\r\n    let diameter = this.parseCaliberMeasurement(caliberRaw) ?? 5.56;\r\n    if (caliberMatch) {\r\n      const decimalPart = caliberMatch[2] ?? \"\";\r\n      diameter = Number.parseFloat(decimalPart ? `${caliberMatch[1]}.${decimalPart}` : caliberMatch[1]);\r\n    }\r\n    const base = 2000;\r\n    const barrelComponent = barrelLength * 45;\r\n    const grainPenalty = grain * 1.5;\r\n    const caliberTweak = (6 - diameter) * 15;\r\n    const estimate = base + barrelComponent - grainPenalty + caliberTweak;\r\n    return Math.max(300, Math.round(estimate));\r\n  }\r\n\r\n  private refreshWeaponAmmoCaliberAutoFill(): void {\r\n    if (!this.weaponAmmoListEl) return;\r\n    const inherited = this.getWeaponFormCaliber();\r\n    this.weaponAmmoListEl.querySelectorAll<HTMLInputElement>('input[data-ammo-field=\"caliber\"]').forEach((input) => {\r\n      const fallback = input.dataset.initialCaliber?.trim() || \"\";\r\n      const value = inherited || fallback;\r\n      input.value = value;\r\n      input.placeholder = value || inherited;\r\n      input.dataset.initialCaliber = value;\r\n    });\r\n  }\r\n\r\n  private renderWeaponTagSuggestions(): void {\r\n    if (this.weaponCategoryTagListEl) {\r\n      this.weaponCategoryTagListEl.innerHTML = this.buildTagOptionMarkup(Object.keys(this.tags.categories || {}));\r\n    }\r\n    if (this.weaponCaliberTagListEl) {\r\n      this.weaponCaliberTagListEl.innerHTML = this.buildTagOptionMarkup(Object.keys(this.tags.calibers || {}));\r\n    }\r\n  }\r\n\r\n  private buildTagOptionMarkup(values: string[]): string {\r\n    if (!values || !values.length) return \"\";\r\n    return [...values]\r\n      .sort((a, b) => a.localeCompare(b))\r\n      .map((value) => `<option value=\"${value}\"></option>`)\r\n      .join(\"\");\r\n  }\r\n\r\n  private setWeaponStatus(message: string, level: \"info\" | \"success\" | \"error\" = \"info\"): void {\r\n    this.setStatus(this.weaponStatusEl, message, level);\r\n  }\r\n\r\n  private setAmmoStatus(message: string, level: \"info\" | \"success\" | \"error\" = \"info\"): void {\r\n    this.setStatus(this.ammoStatusEl, message, level);\r\n  }\r\n\r\n  private setFireStatus(message: string, level: \"info\" | \"success\" | \"error\" = \"info\"): void {\r\n    this.setStatus(this.fireStatusEl, message, level);\r\n  }\r\n\r\n  private setTagStatus(message: string, level: \"info\" | \"success\" | \"error\" = \"info\"): void {\r\n    this.setStatus(this.tagStatusEl, message, level);\r\n  }\r\n\r\n  private setStatus(target: HTMLElement, message: string, level: \"info\" | \"success\" | \"error\"): void {\r\n    target.textContent = message;\r\n    if (level === \"info\") {\r\n      delete target.dataset.tone;\r\n    } else {\r\n      target.dataset.tone = level;\r\n    }\r\n  }\r\n\r\n  private toInputValue(value: unknown): string {\r\n    if (value === null || value === undefined) return \"\";\r\n    return String(value);\r\n  }\r\n\r\n  private handleTagInput(event: Event): void {\r\n    const target = event.target as HTMLInputElement;\r\n    if (!target || !target.dataset.tagField) return;\r\n    const scope = (target.dataset.scope as TagScope) || \"categories\";\r\n    const id = target.dataset.id;\r\n    const entry = this.tagDraft[scope].find((row) => row.id === id);\r\n    if (!entry) return;\r\n    if (target.dataset.tagField === \"name\") {\r\n      entry.name = target.value;\r\n    } else if (target.dataset.tagField === \"color\") {\r\n      entry.color = target.value;\r\n    }\r\n  }\r\n\r\n  private mapToEntries(map?: Record<string, string>): TagEntry[] {\r\n    if (!map) return [];\r\n    return Object.entries(map).map(([name, color]) => ({ id: this.makeId(), name, color }));\r\n  }\r\n\r\n  private makeId(): string {\r\n    return Math.random().toString(36).slice(2, 9);\r\n  }\r\n}\r\n"],"names":["createWeaponTemplate","createAmmoTemplate","createFireTemplate","WeaponWorkbench","root","__publicField","weaponLibraryService","weapons","deepClone","ammoLibraryService","templates","weaponTagService","tags","fireModeTemplateService","error","panelId","button","event","_a","index","template","_b","fn","_c","scope","id","entry","payload","toMap","entries","acc","key","weapon","_d","_e","_f","data","_g","_h","_i","_j","ammoList","ammo","modes","mode","panel","expanded","heading","btn","body","base","container","selected","active","value","TRAJECTORY_OPTIONS","option","WEAPON_TRAIT_GROUPS","group","separator","toValue","row","airburstValue","grainInput","fpsInput","ammoCaliberInput","startingValue","applyBallistics","grain","barrel","caliberSource","velocity","removeButton","airburstSelect","subInputs","syncAirburst","enabled","input","select","read","field","selector","airburst","names","current","empty","name","opt","rendered","term","_k","_l","_m","_n","toggle","makeRow","preview","nameInput","colorInput","syncPreview","color","rawValue","parsed","raw","match","caliberRaw","barrelLength","caliberMatch","diameter","decimalPart","barrelComponent","grainPenalty","caliberTweak","estimate","inherited","fallback","values","a","b","message","level","target","map"],"mappings":"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"}